<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>BigDecimal源码解析 | Eric Liang</title><meta name="description" content="BigDecimal源码解析"><meta name="keywords" content="JDK源码解析,BigDecimal"><meta name="author" content="Eric Liang"><meta name="copyright" content="Eric Liang"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="BigDecimal源码解析"><meta name="twitter:description" content="BigDecimal源码解析"><meta name="twitter:image" content="https://source.unsplash.com/300x300/?program"><meta property="og:type" content="article"><meta property="og:title" content="BigDecimal源码解析"><meta property="og:url" content="https://ericql.github.io/2019/11/12/01-Java%E5%9F%BA%E7%A1%80%E7%AF%87/02-JDK%E6%BA%90%E7%A0%81%E7%AF%87/BigDecimal%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"><meta property="og:site_name" content="Eric Liang"><meta property="og:description" content="BigDecimal源码解析"><meta property="og:image" content="https://source.unsplash.com/300x300/?program"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://ericql.github.io/2019/11/12/01-Java%E5%9F%BA%E7%A1%80%E7%AF%87/02-JDK%E6%BA%90%E7%A0%81%E7%AF%87/BigDecimal%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"><link rel="prev" title="博客相关命令" href="https://ericql.github.io/2019/11/25/hexo%E5%91%BD%E4%BB%A4/"><link rel="next" title="Java中的equals()和hashcode()之间关系" href="https://ericql.github.io/2019/11/12/01-Java%E5%9F%BA%E7%A1%80%E7%AF%87/01-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E7%82%B9/Java%E4%B8%AD%E7%9A%84equals()%E5%92%8Chashcode()%E4%B9%8B%E9%97%B4%E5%85%B3%E7%B3%BB/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'false',
  highlight_lang: 'true',
  highlight_shrink: 'false',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  copyright: undefined,
  copy_copyright_js: false,
  ClickShowText: undefined,
  medium_zoom: 'false',
  Snackbar: undefined
  
}</script></head><body><div id="header"> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Eric Liang</a></span><i class="fa fa-bars fa-fw toggle-menu pull_right close" aria-hidden="true"></i><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 档案</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></span><span class="pull_right" id="search_button"></span></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="lazyload avatar_img" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/Photo/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'"></div><div class="mobile_post_data"><div class="mobile_data_item is_center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">33</div></a></div></div><div class="mobile_data_item is_center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">17</div></a></div></div><div class="mobile_data_item is_center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">7</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 档案</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#BigDecimal源码解析"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">BigDecimal源码解析</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#类定义"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">类定义</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#主要变量"><span class="toc_mobile_items-number">1.2.</span> <span class="toc_mobile_items-text">主要变量</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#构造方法"><span class="toc_mobile_items-number">1.3.</span> <span class="toc_mobile_items-text">构造方法</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#内部类"><span class="toc_mobile_items-number">1.4.</span> <span class="toc_mobile_items-text">内部类</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#StringBuilderHelper"><span class="toc_mobile_items-number">1.4.1.</span> <span class="toc_mobile_items-text">StringBuilderHelper</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#UnsafeHolder"><span class="toc_mobile_items-number">1.4.2.</span> <span class="toc_mobile_items-text">UnsafeHolder</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#主要方法"><span class="toc_mobile_items-number">1.5.</span> <span class="toc_mobile_items-text">主要方法</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#自动装箱-静态工厂方法"><span class="toc_mobile_items-number">1.5.1.</span> <span class="toc_mobile_items-text">自动装箱(静态工厂方法)</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#算术运算"><span class="toc_mobile_items-number">1.5.2.</span> <span class="toc_mobile_items-text">算术运算</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#加法运算"><span class="toc_mobile_items-number">1.5.2.1.</span> <span class="toc_mobile_items-text">加法运算</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#减法操作"><span class="toc_mobile_items-number">1.5.2.2.</span> <span class="toc_mobile_items-text">减法操作</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#乘法运算"><span class="toc_mobile_items-number">1.5.2.3.</span> <span class="toc_mobile_items-text">乘法运算</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#除法运算"><span class="toc_mobile_items-number">1.5.2.4.</span> <span class="toc_mobile_items-text">除法运算</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#求余运算"><span class="toc_mobile_items-number">1.5.2.5.</span> <span class="toc_mobile_items-text">求余运算</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#次幂运算"><span class="toc_mobile_items-number">1.5.2.6.</span> <span class="toc_mobile_items-text">次幂运算</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#绝对值"><span class="toc_mobile_items-number">1.5.2.7.</span> <span class="toc_mobile_items-text">绝对值</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#正负号函数"><span class="toc_mobile_items-number">1.5.2.8.</span> <span class="toc_mobile_items-text">正负号函数</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#BigDecimal标度和非标度"><span class="toc_mobile_items-number">1.5.2.9.</span> <span class="toc_mobile_items-text">BigDecimal标度和非标度</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#BigDecimal精度"><span class="toc_mobile_items-number">1.5.2.10.</span> <span class="toc_mobile_items-text">BigDecimal精度</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#舍入模式"><span class="toc_mobile_items-number">1.5.3.</span> <span class="toc_mobile_items-text">舍入模式</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#舍入模式变量介绍"><span class="toc_mobile_items-number">1.5.3.1.</span> <span class="toc_mobile_items-text">舍入模式变量介绍</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#舍入操作"><span class="toc_mobile_items-number">1.5.3.2.</span> <span class="toc_mobile_items-text">舍入操作</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#小数点移动操作"><span class="toc_mobile_items-number">1.5.4.</span> <span class="toc_mobile_items-text">小数点移动操作</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#左移"><span class="toc_mobile_items-number">1.5.4.1.</span> <span class="toc_mobile_items-text">左移</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#右移"><span class="toc_mobile_items-number">1.5.4.2.</span> <span class="toc_mobile_items-text">右移</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#10次幂操作"><span class="toc_mobile_items-number">1.5.4.3.</span> <span class="toc_mobile_items-text">10次幂操作</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#尾部清零"><span class="toc_mobile_items-number">1.5.4.4.</span> <span class="toc_mobile_items-text">尾部清零</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#比较运算"><span class="toc_mobile_items-number">1.5.5.</span> <span class="toc_mobile_items-text">比较运算</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#无符号比较"><span class="toc_mobile_items-number">1.5.5.1.</span> <span class="toc_mobile_items-text">无符号比较</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#有符号比较"><span class="toc_mobile_items-number">1.5.5.2.</span> <span class="toc_mobile_items-text">有符号比较</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#equals"><span class="toc_mobile_items-number">1.5.5.3.</span> <span class="toc_mobile_items-text">equals</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#最小值min和最大值max"><span class="toc_mobile_items-number">1.5.5.4.</span> <span class="toc_mobile_items-text">最小值min和最大值max</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#哈希函数"><span class="toc_mobile_items-number">1.5.6.</span> <span class="toc_mobile_items-text">哈希函数</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#格式转换器"><span class="toc_mobile_items-number">1.5.7.</span> <span class="toc_mobile_items-text">格式转换器</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#toString-NaN"><span class="toc_mobile_items-number">1.5.7.1.</span> <span class="toc_mobile_items-text">toString</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#转换为BigInteger"><span class="toc_mobile_items-number">1.5.7.2.</span> <span class="toc_mobile_items-text">转换为BigInteger</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#自动拆箱"><span class="toc_mobile_items-number">1.5.8.</span> <span class="toc_mobile_items-text">自动拆箱</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#拆成long"><span class="toc_mobile_items-number">1.5.8.1.</span> <span class="toc_mobile_items-text">拆成long</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#拆成int"><span class="toc_mobile_items-number">1.5.8.2.</span> <span class="toc_mobile_items-text">拆成int</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#拆成short"><span class="toc_mobile_items-number">1.5.8.3.</span> <span class="toc_mobile_items-text">拆成short</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#拆成byte"><span class="toc_mobile_items-number">1.5.8.4.</span> <span class="toc_mobile_items-text">拆成byte</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#拆成float"><span class="toc_mobile_items-number">1.5.8.5.</span> <span class="toc_mobile_items-text">拆成float</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#拆成double"><span class="toc_mobile_items-number">1.5.8.6.</span> <span class="toc_mobile_items-text">拆成double</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#最后单位大小"><span class="toc_mobile_items-number">1.5.8.7.</span> <span class="toc_mobile_items-text">最后单位大小</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#拆成char"><span class="toc_mobile_items-number">1.5.8.8.</span> <span class="toc_mobile_items-text">拆成char[]</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#bigInteger"><span class="toc_mobile_items-number">1.5.8.9.</span> <span class="toc_mobile_items-text">bigInteger</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#10次幂运算和标度匹配"><span class="toc_mobile_items-number">1.5.9.</span> <span class="toc_mobile_items-text">10次幂运算和标度匹配</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#序列化和反序列化"><span class="toc_mobile_items-number">1.5.10.</span> <span class="toc_mobile_items-text">序列化和反序列化</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#获取长度"><span class="toc_mobile_items-number">1.5.11.</span> <span class="toc_mobile_items-text">获取长度</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#后置零删除"><span class="toc_mobile_items-number">1.5.12.</span> <span class="toc_mobile_items-text">后置零删除</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#比较操作-private"><span class="toc_mobile_items-number">1.5.13.</span> <span class="toc_mobile_items-text">比较操作(private)</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#内部打印"><span class="toc_mobile_items-number">1.5.14.</span> <span class="toc_mobile_items-text">内部打印</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#舍入操作-private"><span class="toc_mobile_items-number">1.5.15.</span> <span class="toc_mobile_items-text">舍入操作(private)</span></a></li></ol></li></ol></li></ol></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#BigDecimal源码解析"><span class="toc-number">1.</span> <span class="toc-text">BigDecimal源码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#类定义"><span class="toc-number">1.1.</span> <span class="toc-text">类定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#主要变量"><span class="toc-number">1.2.</span> <span class="toc-text">主要变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#构造方法"><span class="toc-number">1.3.</span> <span class="toc-text">构造方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#内部类"><span class="toc-number">1.4.</span> <span class="toc-text">内部类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#StringBuilderHelper"><span class="toc-number">1.4.1.</span> <span class="toc-text">StringBuilderHelper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UnsafeHolder"><span class="toc-number">1.4.2.</span> <span class="toc-text">UnsafeHolder</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#主要方法"><span class="toc-number">1.5.</span> <span class="toc-text">主要方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#自动装箱-静态工厂方法"><span class="toc-number">1.5.1.</span> <span class="toc-text">自动装箱(静态工厂方法)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#算术运算"><span class="toc-number">1.5.2.</span> <span class="toc-text">算术运算</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#加法运算"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">加法运算</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#减法操作"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">减法操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#乘法运算"><span class="toc-number">1.5.2.3.</span> <span class="toc-text">乘法运算</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#除法运算"><span class="toc-number">1.5.2.4.</span> <span class="toc-text">除法运算</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#求余运算"><span class="toc-number">1.5.2.5.</span> <span class="toc-text">求余运算</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#次幂运算"><span class="toc-number">1.5.2.6.</span> <span class="toc-text">次幂运算</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#绝对值"><span class="toc-number">1.5.2.7.</span> <span class="toc-text">绝对值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#正负号函数"><span class="toc-number">1.5.2.8.</span> <span class="toc-text">正负号函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BigDecimal标度和非标度"><span class="toc-number">1.5.2.9.</span> <span class="toc-text">BigDecimal标度和非标度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BigDecimal精度"><span class="toc-number">1.5.2.10.</span> <span class="toc-text">BigDecimal精度</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#舍入模式"><span class="toc-number">1.5.3.</span> <span class="toc-text">舍入模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#舍入模式变量介绍"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">舍入模式变量介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#舍入操作"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">舍入操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#小数点移动操作"><span class="toc-number">1.5.4.</span> <span class="toc-text">小数点移动操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#左移"><span class="toc-number">1.5.4.1.</span> <span class="toc-text">左移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#右移"><span class="toc-number">1.5.4.2.</span> <span class="toc-text">右移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10次幂操作"><span class="toc-number">1.5.4.3.</span> <span class="toc-text">10次幂操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#尾部清零"><span class="toc-number">1.5.4.4.</span> <span class="toc-text">尾部清零</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#比较运算"><span class="toc-number">1.5.5.</span> <span class="toc-text">比较运算</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#无符号比较"><span class="toc-number">1.5.5.1.</span> <span class="toc-text">无符号比较</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#有符号比较"><span class="toc-number">1.5.5.2.</span> <span class="toc-text">有符号比较</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#equals"><span class="toc-number">1.5.5.3.</span> <span class="toc-text">equals</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#最小值min和最大值max"><span class="toc-number">1.5.5.4.</span> <span class="toc-text">最小值min和最大值max</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#哈希函数"><span class="toc-number">1.5.6.</span> <span class="toc-text">哈希函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#格式转换器"><span class="toc-number">1.5.7.</span> <span class="toc-text">格式转换器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#toString-NaN"><span class="toc-number">1.5.7.1.</span> <span class="toc-text">toString</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#转换为BigInteger"><span class="toc-number">1.5.7.2.</span> <span class="toc-text">转换为BigInteger</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自动拆箱"><span class="toc-number">1.5.8.</span> <span class="toc-text">自动拆箱</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#拆成long"><span class="toc-number">1.5.8.1.</span> <span class="toc-text">拆成long</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#拆成int"><span class="toc-number">1.5.8.2.</span> <span class="toc-text">拆成int</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#拆成short"><span class="toc-number">1.5.8.3.</span> <span class="toc-text">拆成short</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#拆成byte"><span class="toc-number">1.5.8.4.</span> <span class="toc-text">拆成byte</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#拆成float"><span class="toc-number">1.5.8.5.</span> <span class="toc-text">拆成float</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#拆成double"><span class="toc-number">1.5.8.6.</span> <span class="toc-text">拆成double</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#最后单位大小"><span class="toc-number">1.5.8.7.</span> <span class="toc-text">最后单位大小</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#拆成char"><span class="toc-number">1.5.8.8.</span> <span class="toc-text">拆成char[]</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bigInteger"><span class="toc-number">1.5.8.9.</span> <span class="toc-text">bigInteger</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10次幂运算和标度匹配"><span class="toc-number">1.5.9.</span> <span class="toc-text">10次幂运算和标度匹配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#序列化和反序列化"><span class="toc-number">1.5.10.</span> <span class="toc-text">序列化和反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#获取长度"><span class="toc-number">1.5.11.</span> <span class="toc-text">获取长度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#后置零删除"><span class="toc-number">1.5.12.</span> <span class="toc-text">后置零删除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#比较操作-private"><span class="toc-number">1.5.13.</span> <span class="toc-text">比较操作(private)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#内部打印"><span class="toc-number">1.5.14.</span> <span class="toc-text">内部打印</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#舍入操作-private"><span class="toc-number">1.5.15.</span> <span class="toc-text">舍入操作(private)</span></a></li></ol></li></ol></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url((设置顶部图))"><div id="post-info"><div id="post-title"><div class="posttitle">BigDecimal源码解析</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2019-11-12<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-02-01</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/01-Java%E5%9F%BA%E7%A1%80%E7%AF%87/">01-Java基础篇</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/01-Java%E5%9F%BA%E7%A1%80%E7%AF%87/02-JDK%E6%BA%90%E7%A0%81%E7%AF%87/">02-JDK源码篇</a></span><div class="post-meta-wordcount"><i class="fa fa-eye post-meta__icon" aria-hidden="true">       </i><span>阅读量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="BigDecimal源码解析"><a href="#BigDecimal源码解析" class="headerlink" title="BigDecimal源码解析"></a>BigDecimal源码解析</h1><p>&emsp;&emsp;BigDecimal是不可变的、任意精度的有符号十进制数。BigDecimal是由任意精度整数非标度值和和32位的整数标度(scale)组成。</p>
<ul>
<li>如果为0或正数，则标度scale表示小数点后的位数</li>
<li>如果为负数，则是该数的非标度值乘以10的scale次幂，即BigDecimal表示的数值是(unscaledValue × 10的-scale次幂)</li>
</ul>
<ol>
<li>BigDecimal提供以下的操作：算术、标度操作、舍入、比较、哈希算法和格式转换</li>
<li>toString()方法提供BigDecimal的规范表示形式</li>
<li>BigDecimal类使用户能完全控制舍入行为，如果未指定舍入模式，并且无法表示准备结果，则抛出一个异常;否则通过向该操作提供适当的MathContext对象，可以对已选择的精度和舍入模式执行计算，在任何情况下，可以为舍入控制提供八种舍入模式。使用此类中(如ROUND_HALF_UP)的整数字段来表示舍入模式已过时，应改为使用RoundingMode enum的枚举值。当为MathContext对象提供0的精度设置时，算术运算是准确的，它们是不采用任何MathContext对象的算术方法,为了计算准备结果，不使用附带0精度设置的MathContext对象的舍入模式设置，因此与该对象无关。在除法中，准备的商可能是一个无限长的十进制扩展，</li>
</ol>
<h2 id="类定义"><a href="#类定义" class="headerlink" title="类定义"></a>类定义</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BigDecimal</span> <span class="keyword">extends</span> <span class="title">Number</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">BigDecimal</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>继承Number类提供将表示的数值转换为byte、double、float、int、long和short方法</li>
<li>实现Comparable接口，获取到compareTo方法</li>
</ul>
<h2 id="主要变量"><a href="#主要变量" class="headerlink" title="主要变量"></a>主要变量</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BigDecimal的未scale的值,BigInteger是一个任意长度的整数非标度值</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> BigInteger intVal;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BigDecimal的标度(小数点),输入数除以10的scale次幂(32 位的整数标度).注意:这可能有任何值，因此计算必须长时间进行</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> scale;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BigDecimal的精度(精度是非标度值的数字个数)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">int</span> precision;</span><br><span class="line"></span><br><span class="line"><span class="comment">// toString的缓存</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> String stringCache;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 标记值为intCompact表示有效数字信息只能从intVal中获得。</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> INFLATED = Long.MIN_VALUE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 若BigDecimal的绝对值小于Long.MAX_VALUE,放在这个变量中</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">long</span> intCompact;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 所有18位基数的10个字符串组成一个长字符串;不是所有的19位字符串都可以</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_COMPACT_DIGITS = <span class="number">18</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 缓存可重用的StringBuilderHelper,为了避免并发访问</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;StringBuilderHelper&gt;</span><br><span class="line">    threadLocalStringBuilderHelper = <span class="keyword">new</span> ThreadLocal&lt;StringBuilderHelper&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> StringBuilderHelper <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StringBuilderHelper();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//缓存0 ~ 10</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BigDecimal zeroThroughTen[] = &#123;</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.ZERO,         <span class="number">0</span>,  <span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.ONE,          <span class="number">1</span>,  <span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.valueOf(<span class="number">2</span>),   <span class="number">2</span>,  <span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.valueOf(<span class="number">3</span>),   <span class="number">3</span>,  <span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.valueOf(<span class="number">4</span>),   <span class="number">4</span>,  <span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.valueOf(<span class="number">5</span>),   <span class="number">5</span>,  <span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.valueOf(<span class="number">6</span>),   <span class="number">6</span>,  <span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.valueOf(<span class="number">7</span>),   <span class="number">7</span>,  <span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.valueOf(<span class="number">8</span>),   <span class="number">8</span>,  <span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.valueOf(<span class="number">9</span>),   <span class="number">9</span>,  <span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.TEN,          <span class="number">10</span>, <span class="number">0</span>, <span class="number">2</span>),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//缓存0 ~ 0E-15</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BigDecimal[] ZERO_SCALED_BY = &#123;</span><br><span class="line">    zeroThroughTen[<span class="number">0</span>],</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.ZERO, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.ZERO, <span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.ZERO, <span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.ZERO, <span class="number">0</span>, <span class="number">4</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.ZERO, <span class="number">0</span>, <span class="number">5</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.ZERO, <span class="number">0</span>, <span class="number">6</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.ZERO, <span class="number">0</span>, <span class="number">7</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.ZERO, <span class="number">0</span>, <span class="number">8</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.ZERO, <span class="number">0</span>, <span class="number">9</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.ZERO, <span class="number">0</span>, <span class="number">10</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.ZERO, <span class="number">0</span>, <span class="number">11</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.ZERO, <span class="number">0</span>, <span class="number">12</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.ZERO, <span class="number">0</span>, <span class="number">13</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.ZERO, <span class="number">0</span>, <span class="number">14</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> BigDecimal(BigInteger.ZERO, <span class="number">0</span>, <span class="number">15</span>, <span class="number">1</span>),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MIN_VALUE &amp; Long.MAX_VALUE的一半</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> HALF_LONG_MAX_VALUE = Long.MAX_VALUE / <span class="number">2</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> HALF_LONG_MIN_VALUE = Long.MIN_VALUE / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 常量</span></span><br><span class="line"><span class="comment">// 值为 0，标度为 0</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> BigDecimal ZERO = zeroThroughTen[<span class="number">0</span>];</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 值为 1，标度为 0</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> BigDecimal ONE = zeroThroughTen[<span class="number">1</span>];</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 值为 10，标度为 0</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> BigDecimal TEN = zeroThroughTen[<span class="number">10</span>];</span><br></pre></td></tr></table></figure>
<h2 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 受信任的包私有构造函数.可信仅仅意味着如果val是INFLATED,intVal不可能为空,如果intVal为空,val不可能是INFLATED。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> intVal	BigInteger的数值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> val	long的数值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> scale	标度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> prec	精度</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">BigDecimal(BigInteger intVal, <span class="keyword">long</span> val, <span class="keyword">int</span> scale, <span class="keyword">int</span> prec) &#123;</span><br><span class="line">    <span class="keyword">this</span>.scale = scale;</span><br><span class="line">    <span class="keyword">this</span>.precision = prec;</span><br><span class="line">    <span class="keyword">this</span>.intCompact = val;</span><br><span class="line">    <span class="keyword">this</span>.intVal = intVal;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BigDecimal</span><span class="params">(<span class="keyword">char</span>[] in, <span class="keyword">int</span> offset, <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(in,offset,len,MathContext.UNLIMITED);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将BigDecimal的字符数组表示形式转换为BigDecimal,接受与BigDecimal(String)构造方法相同的字符序列,同时允许指定子数组.</span></span><br><span class="line"><span class="comment"> * 注意:如果字符数组中已经提供字符的序列,则使用此构造方法要比将char数组转换为字符串并使用BigDecimal(String)构造方法更快</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> in	作为源字符的 char 数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> offset	要检查的数组中的第一个字符</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> len	要考虑的字符数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BigDecimal</span><span class="params">(<span class="keyword">char</span>[] in, <span class="keyword">int</span> offset, <span class="keyword">int</span> len, MathContext mc)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 防止长度过大</span></span><br><span class="line">    <span class="keyword">if</span> (offset + len &gt; in.length || offset &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NumberFormatException(<span class="string">"Bad offset or len arguments for char[] input."</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这是BigDecimal构造函数的主要字符串;所有传入的字符串都在这里结束</span></span><br><span class="line">    <span class="comment">// 它使用显式(内联)解析速度并为非紧凑情况生成最多一个中间(临时)对象(char []数组)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对计算过程中的所有字段值使用局部变量</span></span><br><span class="line">    <span class="keyword">int</span> prec = <span class="number">0</span>;                 <span class="comment">// BigDecimal的数字长度</span></span><br><span class="line">    <span class="keyword">int</span> scl = <span class="number">0</span>;                  <span class="comment">// BigDecimal的标度</span></span><br><span class="line">    <span class="keyword">long</span> rs = <span class="number">0</span>;                  <span class="comment">// intCompact值</span></span><br><span class="line">    BigInteger rb = <span class="keyword">null</span>;         <span class="comment">// BigInteger的值</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 使用数组边界检查来处理太长、len == 0、错误偏移等等</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 符号的处理：'+'为false，'-'为true</span></span><br><span class="line">        <span class="keyword">boolean</span> isneg = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// // 第一个字符为'-'</span></span><br><span class="line">        <span class="keyword">if</span> (in[offset] == <span class="string">'-'</span>) &#123;</span><br><span class="line">            isneg = <span class="keyword">true</span>;</span><br><span class="line">            offset++;</span><br><span class="line">            len--;</span><br><span class="line">        <span class="comment">// 第一个字符为'+'    </span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (in[offset] == <span class="string">'+'</span>) &#123;</span><br><span class="line">            offset++;</span><br><span class="line">            len--;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 数字的有效部分：当有"."时为真</span></span><br><span class="line">        <span class="keyword">boolean</span> dot = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">long</span> exp = <span class="number">0</span>;                    <span class="comment">// exponent</span></span><br><span class="line">        <span class="keyword">char</span> c;                          <span class="comment">// 当前字符</span></span><br><span class="line">        <span class="keyword">boolean</span> isCompact = (len &lt;= MAX_COMPACT_DIGITS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// idx是整数数组的索引.只有当我们不能使用紧凑的表示时.才会使用数组</span></span><br><span class="line">        <span class="keyword">int</span> idx = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (isCompact) &#123;</span><br><span class="line">            <span class="comment">// 第一个紧凑的情况:我们不需要保留字符,而只需计算就位值即可</span></span><br><span class="line">            <span class="keyword">for</span> (; len &gt; <span class="number">0</span>; offset++, len--) &#123;</span><br><span class="line">                c = in[offset];</span><br><span class="line">                <span class="comment">// 当前字符是'0'</span></span><br><span class="line">                <span class="keyword">if</span> ((c == <span class="string">'0'</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (prec == <span class="number">0</span>)</span><br><span class="line">                        prec = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (rs != <span class="number">0</span>) &#123;</span><br><span class="line">                        rs *= <span class="number">10</span>;</span><br><span class="line">                        ++prec;</span><br><span class="line">                    &#125; </span><br><span class="line">                    <span class="comment">// 否则数字是多余的前导零</span></span><br><span class="line">                    <span class="keyword">if</span> (dot)</span><br><span class="line">                        ++scl;</span><br><span class="line">                <span class="comment">// 存在数字        </span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((c &gt;= <span class="string">'1'</span> &amp;&amp; c &lt;= <span class="string">'9'</span>)) &#123;</span><br><span class="line">                    <span class="keyword">int</span> digit = c - <span class="string">'0'</span>;</span><br><span class="line">                    <span class="keyword">if</span> (prec != <span class="number">1</span> || rs != <span class="number">0</span>)</span><br><span class="line">                        ++prec;<span class="comment">// 如果以0开头,则prec不变</span></span><br><span class="line">                    rs = rs * <span class="number">10</span> + digit;</span><br><span class="line">                    <span class="keyword">if</span> (dot)</span><br><span class="line">                        ++scl;</span><br><span class="line">                <span class="comment">// 存在小数点        </span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">'.'</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (dot) <span class="comment">// 两个小数点</span></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> NumberFormatException();</span><br><span class="line">                    dot = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Character.isDigit(c)) &#123;</span><br><span class="line">                    <span class="comment">// 获取使用10进制的字符c的数值</span></span><br><span class="line">                    <span class="keyword">int</span> digit = Character.digit(c, <span class="number">10</span>);</span><br><span class="line">                    <span class="keyword">if</span> (digit == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (prec == <span class="number">0</span>)</span><br><span class="line">                            prec = <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (rs != <span class="number">0</span>) &#123;</span><br><span class="line">                            rs *= <span class="number">10</span>;</span><br><span class="line">                            ++prec;</span><br><span class="line">                        &#125; </span><br><span class="line">                    <span class="comment">// 否则数字是多余的前导零</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (prec != <span class="number">1</span> || rs != <span class="number">0</span>)</span><br><span class="line">                            ++prec; <span class="comment">// 如果以0开头,则prec不变</span></span><br><span class="line">                        rs = rs * <span class="number">10</span> + digit;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (dot)</span><br><span class="line">                        ++scl;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((c == <span class="string">'e'</span>) || (c == <span class="string">'E'</span>)) &#123;</span><br><span class="line">                    exp = parseExp(in, offset, len);</span><br><span class="line">                    <span class="comment">// 向后兼容性需要下一个测试</span></span><br><span class="line">                    <span class="keyword">if</span> ((<span class="keyword">int</span>) exp != exp) <span class="comment">// 溢出</span></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> NumberFormatException();</span><br><span class="line">                    <span class="keyword">break</span>; <span class="comment">// [保存测试]</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> NumberFormatException();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (prec == <span class="number">0</span>) <span class="comment">// 找不到数字</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NumberFormatException();</span><br><span class="line">            <span class="comment">// 如果exp不为零,请调整比例</span></span><br><span class="line">            <span class="keyword">if</span> (exp != <span class="number">0</span>) &#123; <span class="comment">// 有显示指数</span></span><br><span class="line">                scl = adjustScale(scl, exp);</span><br><span class="line">            &#125;</span><br><span class="line">            rs = isneg ? -rs : rs;</span><br><span class="line">            <span class="comment">// prec的范围为[1，MAX_INT],mcp的范围为[0，MAX_INT];因此此减法不会溢出</span></span><br><span class="line">            <span class="keyword">int</span> mcp = mc.precision;</span><br><span class="line">            <span class="keyword">int</span> drop = prec - mcp;</span><br><span class="line">            <span class="comment">// 取整                     </span></span><br><span class="line">            <span class="keyword">if</span> (mcp &gt; <span class="number">0</span> &amp;&amp; drop &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">while</span> (drop &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    scl = checkScaleNonZero((<span class="keyword">long</span>) scl - drop);</span><br><span class="line">                    rs = divideAndRound(rs, LONG_TEN_POWERS_TABLE[drop], mc.roundingMode.oldMode);</span><br><span class="line">                    prec = longDigitLength(rs);</span><br><span class="line">                    drop = prec - mcp;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">char</span> coeff[] = <span class="keyword">new</span> <span class="keyword">char</span>[len];</span><br><span class="line">            <span class="keyword">for</span> (; len &gt; <span class="number">0</span>; offset++, len--) &#123;</span><br><span class="line">                c = in[offset];</span><br><span class="line">                <span class="comment">// 存在数字</span></span><br><span class="line">                <span class="keyword">if</span> ((c &gt;= <span class="string">'0'</span> &amp;&amp; c &lt;= <span class="string">'9'</span>) || Character.isDigit(c)) &#123;</span><br><span class="line">                    <span class="comment">// 紧凑的情况:我们不需要保留字符,而只需计算就位值即可</span></span><br><span class="line">                    <span class="keyword">if</span> (c == <span class="string">'0'</span> || Character.digit(c, <span class="number">10</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (prec == <span class="number">0</span>) &#123;</span><br><span class="line">                            coeff[idx] = c;</span><br><span class="line">                            prec = <span class="number">1</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (idx != <span class="number">0</span>) &#123;</span><br><span class="line">                            coeff[idx++] = c;</span><br><span class="line">                            ++prec;</span><br><span class="line">                        &#125; </span><br><span class="line">                    <span class="comment">// 否则c必须是冗余的前导零</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (prec != <span class="number">1</span> || idx != <span class="number">0</span>)</span><br><span class="line">                            ++prec; <span class="comment">// 如果以0开头,则prec不变</span></span><br><span class="line">                        coeff[idx++] = c;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (dot)</span><br><span class="line">                        ++scl;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 存在小数点</span></span><br><span class="line">                <span class="keyword">if</span> (c == <span class="string">'.'</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (dot) <span class="comment">// 两次小数点</span></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> NumberFormatException();</span><br><span class="line">                    dot = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 预期指数</span></span><br><span class="line">                <span class="keyword">if</span> ((c != <span class="string">'e'</span>) &amp;&amp; (c != <span class="string">'E'</span>))</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> NumberFormatException();</span><br><span class="line">                exp = parseExp(in, offset, len);</span><br><span class="line">                <span class="comment">// 向后兼容性需要下一个测试</span></span><br><span class="line">                <span class="keyword">if</span> ((<span class="keyword">int</span>) exp != exp) <span class="comment">// 溢出</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> NumberFormatException();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 这里没有字符了</span></span><br><span class="line">            <span class="keyword">if</span> (prec == <span class="number">0</span>) <span class="comment">// 找不到数字</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NumberFormatException();</span><br><span class="line">            <span class="comment">// Adjust scale if exp is not zero.</span></span><br><span class="line">            <span class="keyword">if</span> (exp != <span class="number">0</span>) &#123; <span class="comment">// 有显示指数</span></span><br><span class="line">                scl = adjustScale(scl, exp);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 从精度中删除前导零(数字计数)</span></span><br><span class="line">            rb = <span class="keyword">new</span> BigInteger(coeff, isneg ? -<span class="number">1</span> : <span class="number">1</span>, prec);</span><br><span class="line">            rs = compactValFor(rb);</span><br><span class="line">            <span class="keyword">int</span> mcp = mc.precision;</span><br><span class="line">            <span class="keyword">if</span> (mcp &gt; <span class="number">0</span> &amp;&amp; (prec &gt; mcp)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (rs == INFLATED) &#123;</span><br><span class="line">                    <span class="keyword">int</span> drop = prec - mcp;</span><br><span class="line">                    <span class="keyword">while</span> (drop &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        scl = checkScaleNonZero((<span class="keyword">long</span>) scl - drop);</span><br><span class="line">                        rb = divideAndRoundByTenPow(rb, drop, mc.roundingMode.oldMode);</span><br><span class="line">                        rs = compactValFor(rb);</span><br><span class="line">                        <span class="keyword">if</span> (rs != INFLATED) &#123;</span><br><span class="line">                            prec = longDigitLength(rs);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        prec = bigDigitLength(rb);</span><br><span class="line">                        drop = prec - mcp;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (rs != INFLATED) &#123;</span><br><span class="line">                    <span class="keyword">int</span> drop = prec - mcp;</span><br><span class="line">                    <span class="keyword">while</span> (drop &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        scl = checkScaleNonZero((<span class="keyword">long</span>) scl - drop);</span><br><span class="line">                        rs = divideAndRound(rs, LONG_TEN_POWERS_TABLE[drop], mc.roundingMode.oldMode);</span><br><span class="line">                        prec = longDigitLength(rs);</span><br><span class="line">                        drop = prec - mcp;</span><br><span class="line">                    &#125;</span><br><span class="line">                    rb = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NumberFormatException();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NegativeArraySizeException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NumberFormatException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.scale = scl;</span><br><span class="line">    <span class="keyword">this</span>.precision = prec;</span><br><span class="line">    <span class="keyword">this</span>.intCompact = rs;</span><br><span class="line">    <span class="keyword">this</span>.intVal = rb;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">adjustScale</span><span class="params">(<span class="keyword">int</span> scl, <span class="keyword">long</span> exp)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> adjustedScale = scl - exp;</span><br><span class="line">    <span class="keyword">if</span> (adjustedScale &gt; Integer.MAX_VALUE || adjustedScale &lt; Integer.MIN_VALUE)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NumberFormatException(<span class="string">"Scale out of range."</span>);</span><br><span class="line">    scl = (<span class="keyword">int</span>) adjustedScale;</span><br><span class="line">    <span class="keyword">return</span> scl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 解析指数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">parseExp</span><span class="params">(<span class="keyword">char</span>[] in, <span class="keyword">int</span> offset, <span class="keyword">int</span> len)</span></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> exp = <span class="number">0</span>;</span><br><span class="line">    offset++;</span><br><span class="line">    <span class="keyword">char</span> c = in[offset];</span><br><span class="line">    len--;</span><br><span class="line">    <span class="keyword">boolean</span> negexp = (c == <span class="string">'-'</span>);</span><br><span class="line">    <span class="comment">// 可选标志</span></span><br><span class="line">    <span class="keyword">if</span> (negexp || c == <span class="string">'+'</span>) &#123;</span><br><span class="line">        offset++;</span><br><span class="line">        c = in[offset];</span><br><span class="line">        len--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (len &lt;= <span class="number">0</span>) <span class="comment">// 没有指数位数</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NumberFormatException();</span><br><span class="line">    <span class="comment">// 跳过指数中的前导零</span></span><br><span class="line">    <span class="keyword">while</span> (len &gt; <span class="number">10</span> &amp;&amp; (c==<span class="string">'0'</span> || (Character.digit(c, <span class="number">10</span>) == <span class="number">0</span>))) &#123;</span><br><span class="line">        offset++;</span><br><span class="line">        c = in[offset];</span><br><span class="line">        len--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (len &gt; <span class="number">10</span>) <span class="comment">// 太多非零指数位数</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NumberFormatException();</span><br><span class="line">    <span class="comment">// c现在拥有指数的第一位数</span></span><br><span class="line">    <span class="keyword">for</span> (;; len--) &#123;</span><br><span class="line">        <span class="keyword">int</span> v;</span><br><span class="line">        <span class="keyword">if</span> (c &gt;= <span class="string">'0'</span> &amp;&amp; c &lt;= <span class="string">'9'</span>) &#123;</span><br><span class="line">            v = c - <span class="string">'0'</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            v = Character.digit(c, <span class="number">10</span>);</span><br><span class="line">            <span class="keyword">if</span> (v &lt; <span class="number">0</span>) <span class="comment">// not a digit</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NumberFormatException();</span><br><span class="line">        &#125;</span><br><span class="line">        exp = exp * <span class="number">10</span> + v;</span><br><span class="line">        <span class="keyword">if</span> (len == <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">break</span>; <span class="comment">// 那是最后的字符</span></span><br><span class="line">        offset++;</span><br><span class="line">        c = in[offset];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (negexp) <span class="comment">// 申请标志</span></span><br><span class="line">        exp = -exp;</span><br><span class="line">    <span class="keyword">return</span> exp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将BigDecimal的字符数组表示形式转换为BigDecimal,接受与BigDecimal(String)构造方法相同的字符序列 </span></span><br><span class="line"><span class="comment"> * 注意:如果字符序列已经可以作为一个字符数组使用,则使用此构造方法要比将char数组转换为字符串并使用BigDecimal(String)构造方法更快</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> in 作为源字符的 char 数组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BigDecimal</span><span class="params">(<span class="keyword">char</span>[] in)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(in, <span class="number">0</span>, in.length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将BigDecimal的字符数组表示形式转换为BigDecimal,接受与BigDecimal(String)构造方法相同的字符序列(根据上下文设置进行舍入)</span></span><br><span class="line"><span class="comment"> * 注意:如果字符序列已经可以作为一个字符数组使用,则使用此构造方法要比将char数组转换为字符串并使用BigDecimal(String)构造方法更快 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> in	作为源字符的 char 数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mc	要使用的上下文</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BigDecimal</span><span class="params">(<span class="keyword">char</span>[] in, MathContext mc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(in, <span class="number">0</span>, in.length, mc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将BigDecimal的字符串表示形式转换为BigDecimal.字符串表示形式由可选符号'+'('\u002B')或'-'('\u002D')组成</span></span><br><span class="line"><span class="comment"> * 后跟零或多个十进制数字("整数")的序列,可以选择后跟一个小数,也可以选择后跟一个指数</span></span><br><span class="line"><span class="comment"> * 该小数由小数点以及后跟的零或更多十进制数字组成.字符串必须至少包含整数或小数部分中的一个数字.由符号、整数和小数部分组成的数字称为有效位数</span></span><br><span class="line"><span class="comment"> * 指数由字符'e'('\u0065')或 'E'('\u0045')以及后跟的一个或多个十进制数字组成</span></span><br><span class="line"><span class="comment"> * 指数的值必须位于Integer.MAX_VALUE(Integer.MIN_VALUE+1)和Integer.MAX_VALUE(包括)之间</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 注：对于不是float、double NaN和±Infinity的值,此构造方法与Float.toString(float)和Double.toString(double)返回的值兼容</span></span><br><span class="line"><span class="comment"> * 这通常是将float或double转换为BigDecimal的首选方法,因为它不会遇到BigDecimal(double)构造方法的不可预知问题 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> val	BigDecimal 的字符串表示形式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BigDecimal</span><span class="params">(String val)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(val.toCharArray(), <span class="number">0</span>, val.length());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将BigDecimal的字符串表示形式转换为 BigDecimal,接受与BigDecimal(String) 构造方法相同的字符串(按照上下文设置进行舍入)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> val	BigDecimal 的字符串表示形式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mc	要使用的上下文</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BigDecimal</span><span class="params">(String val, MathContext mc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(val.toCharArray(), <span class="number">0</span>, val.length());</span><br><span class="line">    <span class="keyword">if</span> (mc.precision &gt; <span class="number">0</span>)<span class="comment">// 精度大于0</span></span><br><span class="line">        roundThis(mc);<span class="comment">// 根据MathContext设置将这个BigDecimal四舍五入</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将double转换为 BigDecimal,后者是double的二进制浮点值准确的十进制表示形式.返回的 BigDecimal的标度是使(10的scale次幂 × val)为整数的最小值 </span></span><br><span class="line"><span class="comment"> * 注： </span></span><br><span class="line"><span class="comment"> * 1、此构造方法的结果有一定的不可预知性.有人可能认为在Java中写入new BigDecimal(0.1)所创建的BigDecimal正好等于0.1(非标度值 1,其标度为 1).</span></span><br><span class="line"><span class="comment"> * 但是它实际上等于 0.1000000000000000055511151231257827021181583404541015625.这是因为0.1无法准确地表示为double(或者说对于该情况,不能表示为任何有限长度的二进制小数).这样传入到构造方法的值不会正好等于0.1(虽然表面上等于该值)</span></span><br><span class="line"><span class="comment"> * 2、另一方面String 构造方法是完全可预知的：写入new BigDecimal("0.1")将创建一个BigDecimal,它正好等于预期的0.1.因此比较而言,通常建议优先使用String构造方法</span></span><br><span class="line"><span class="comment"> * 3、当double必须用作BigDecimal的源时,请注意,此构造方法提供了一个准确转换;它不提供与以下操作相同的结果：先使用Double.toString(double)方法,然后使用BigDecimal(String)构造方法,将double转换为String.要获取该结果,请使用static valueOf(double)方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> val	要转换为 BigDecimal 的 double 值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BigDecimal</span><span class="params">(<span class="keyword">double</span> val)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(val,MathContext.UNLIMITED);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BigDecimal</span><span class="params">(<span class="keyword">double</span> val, MathContext mc)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 如果 val 为无穷大或 NaN</span></span><br><span class="line">    <span class="keyword">if</span> (Double.isInfinite(val) || Double.isNaN(val))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NumberFormatException(<span class="string">"Infinite or NaN"</span>);</span><br><span class="line">    <span class="comment">// 将double转化为符号、exponent和significand,根据根据JLS第20.10.22节中的公式</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 根据IEEE 754浮点双精度格式("double format")位布局,返回val的表示形式</span></span><br><span class="line"><span class="comment">     * 第63位(掩码 0x8000000000000000L 选定的位)表示浮点数的符号</span></span><br><span class="line"><span class="comment">     * 第62-52位(掩码 0x7ff0000000000000L 选定的位)表示指数</span></span><br><span class="line"><span class="comment">     * 第51-0位(掩码 0x000fffffffffffffL 选定的位)表示浮点数的有效数字(有时也称为尾数)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">long</span> valBits = Double.doubleToLongBits(val);</span><br><span class="line">    <span class="keyword">int</span> sign = ((valBits &gt;&gt; <span class="number">63</span>) == <span class="number">0</span> ? <span class="number">1</span> : -<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">int</span> exponent = (<span class="keyword">int</span>) ((valBits &gt;&gt; <span class="number">52</span>) &amp; <span class="number">0x7ffL</span>);</span><br><span class="line">    <span class="keyword">long</span> significand = (exponent == <span class="number">0</span></span><br><span class="line">            ? (valBits &amp; ((<span class="number">1L</span> &lt;&lt; <span class="number">52</span>) - <span class="number">1</span>)) &lt;&lt; <span class="number">1</span></span><br><span class="line">            : (valBits &amp; ((<span class="number">1L</span> &lt;&lt; <span class="number">52</span>) - <span class="number">1</span>)) | (<span class="number">1L</span> &lt;&lt; <span class="number">52</span>));</span><br><span class="line">    exponent -= <span class="number">1075</span>;</span><br><span class="line">    <span class="comment">// 这时候, val == sign * significand * 2**exponent</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 特殊情况零可以抑制无尽的规范化和虚假的规模计算</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (significand == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.intVal = BigInteger.ZERO;</span><br><span class="line">        <span class="keyword">this</span>.scale = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.intCompact = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.precision = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 正常化:i.e., significand 是偶数，significand等于0；&amp;计算:两位同为1结果为1，否则为0</span></span><br><span class="line">    <span class="keyword">while</span> ((significand &amp; <span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        significand &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">        exponent++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> scale = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 计算intVal和scale</span></span><br><span class="line">    BigInteger intVal;</span><br><span class="line">    <span class="keyword">long</span> compactVal = sign * significand;</span><br><span class="line">    <span class="keyword">if</span> (exponent == <span class="number">0</span>) &#123;</span><br><span class="line">        intVal = (compactVal == INFLATED) ? INFLATED_BIGINT : <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 指数小于0</span></span><br><span class="line">        <span class="keyword">if</span> (exponent &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 5 的-exponent次幂乘以s</span></span><br><span class="line">            intVal = BigInteger.valueOf(<span class="number">5</span>).pow(-exponent).multiply(compactVal);</span><br><span class="line">            scale = -exponent;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 指数大于0</span></span><br><span class="line">            <span class="comment">// // 2 的exponent次幂乘以s</span></span><br><span class="line">            intVal = BigInteger.valueOf(<span class="number">2</span>).pow(exponent).multiply(compactVal);</span><br><span class="line">        &#125;</span><br><span class="line">        compactVal = compactValFor(intVal);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> prec = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> mcp = mc.precision;</span><br><span class="line">    <span class="keyword">if</span> (mcp &gt; <span class="number">0</span>) &#123; <span class="comment">//取整</span></span><br><span class="line">        <span class="keyword">int</span> mode = mc.roundingMode.oldMode;</span><br><span class="line">        <span class="keyword">int</span> drop;</span><br><span class="line">        <span class="keyword">if</span> (compactVal == INFLATED) &#123;</span><br><span class="line">            prec = bigDigitLength(intVal);</span><br><span class="line">            drop = prec - mcp;</span><br><span class="line">            <span class="keyword">while</span> (drop &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                scale = checkScaleNonZero((<span class="keyword">long</span>) scale - drop);</span><br><span class="line">                intVal = divideAndRoundByTenPow(intVal, drop, mode);</span><br><span class="line">                compactVal = compactValFor(intVal);</span><br><span class="line">                <span class="keyword">if</span> (compactVal != INFLATED) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                prec = bigDigitLength(intVal);</span><br><span class="line">                drop = prec - mcp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (compactVal != INFLATED) &#123;</span><br><span class="line">            prec = longDigitLength(compactVal);</span><br><span class="line">            drop = prec - mcp;</span><br><span class="line">            <span class="keyword">while</span> (drop &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                scale = checkScaleNonZero((<span class="keyword">long</span>) scale - drop);</span><br><span class="line">                compactVal = divideAndRound(compactVal, LONG_TEN_POWERS_TABLE[drop], mc.roundingMode.oldMode);</span><br><span class="line">                prec = longDigitLength(compactVal);</span><br><span class="line">                drop = prec - mcp;</span><br><span class="line">            &#125;</span><br><span class="line">            intVal = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.intVal = intVal;</span><br><span class="line">    <span class="keyword">this</span>.intCompact = compactVal;</span><br><span class="line">    <span class="keyword">this</span>.scale = scale;</span><br><span class="line">    <span class="keyword">this</span>.precision = prec;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将 BigInteger转换为BigDecimal.BigDecimal的标度是零</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> val	要转换为 BigDecimal 的 BigInteger 值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BigDecimal</span><span class="params">(BigInteger val)</span> </span>&#123;</span><br><span class="line">    scale = <span class="number">0</span>;</span><br><span class="line">    intVal = val;</span><br><span class="line">    intCompact = compactValFor(val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BigDecimal</span><span class="params">(BigInteger val, MathContext mc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(val,<span class="number">0</span>,mc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将 BigInteger 非标度值和 int 标度转换为 BigDecimal。BigDecimal 的值为 (unscaledVal × 10的-scale幂)。 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> unscaledVal	BigDecimal 的非标度值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> scale	BigDecimal 的标度</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BigDecimal</span><span class="params">(BigInteger unscaledVal, <span class="keyword">int</span> scale)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 现在允许负标度</span></span><br><span class="line">    <span class="keyword">this</span>.intVal = unscaledVal;</span><br><span class="line">    <span class="keyword">this</span>.intCompact = compactValFor(unscaledVal);</span><br><span class="line">    <span class="keyword">this</span>.scale = scale;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BigDecimal</span><span class="params">(BigInteger unscaledVal, <span class="keyword">int</span> scale, MathContext mc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> compactVal = compactValFor(unscaledVal);</span><br><span class="line">    <span class="keyword">int</span> mcp = mc.precision;</span><br><span class="line">    <span class="keyword">int</span> prec = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (mcp &gt; <span class="number">0</span>) &#123; <span class="comment">// 取整</span></span><br><span class="line">        <span class="keyword">int</span> mode = mc.roundingMode.oldMode;</span><br><span class="line">        <span class="keyword">if</span> (compactVal == INFLATED) &#123;</span><br><span class="line">            prec = bigDigitLength(unscaledVal);</span><br><span class="line">            <span class="keyword">int</span> drop = prec - mcp;</span><br><span class="line">            <span class="keyword">while</span> (drop &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                scale = checkScaleNonZero((<span class="keyword">long</span>) scale - drop);</span><br><span class="line">                unscaledVal = divideAndRoundByTenPow(unscaledVal, drop, mode);</span><br><span class="line">                compactVal = compactValFor(unscaledVal);</span><br><span class="line">                <span class="keyword">if</span> (compactVal != INFLATED) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                prec = bigDigitLength(unscaledVal);</span><br><span class="line">                drop = prec - mcp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (compactVal != INFLATED) &#123;</span><br><span class="line">            prec = longDigitLength(compactVal);</span><br><span class="line">            <span class="keyword">int</span> drop = prec - mcp;     <span class="comment">// 跌落不能超过18</span></span><br><span class="line">            <span class="keyword">while</span> (drop &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                scale = checkScaleNonZero((<span class="keyword">long</span>) scale - drop);</span><br><span class="line">                compactVal = divideAndRound(compactVal, LONG_TEN_POWERS_TABLE[drop], mode);</span><br><span class="line">                prec = longDigitLength(compactVal);</span><br><span class="line">                drop = prec - mcp;</span><br><span class="line">            &#125;</span><br><span class="line">            unscaledVal = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.intVal = unscaledVal;</span><br><span class="line">    <span class="keyword">this</span>.intCompact = compactVal;</span><br><span class="line">    <span class="keyword">this</span>.scale = scale;</span><br><span class="line">    <span class="keyword">this</span>.precision = prec;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将 int 转换为 BigDecimal。BigDecimal 的标度为零</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> val 要转换为 BigDecimal 的 int 值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BigDecimal</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.intCompact = val;</span><br><span class="line">    <span class="keyword">this</span>.scale = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>.intVal = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BigDecimal</span><span class="params">(<span class="keyword">int</span> val, MathContext mc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> mcp = mc.precision;</span><br><span class="line">    <span class="keyword">long</span> compactVal = val;</span><br><span class="line">    <span class="keyword">int</span> scale = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> prec = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (mcp &gt; <span class="number">0</span>) &#123; <span class="comment">// 取整</span></span><br><span class="line">        prec = longDigitLength(compactVal);</span><br><span class="line">        <span class="keyword">int</span> drop = prec - mcp; <span class="comment">// 跌落不能超过18</span></span><br><span class="line">        <span class="keyword">while</span> (drop &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            scale = checkScaleNonZero((<span class="keyword">long</span>) scale - drop);</span><br><span class="line">            compactVal = divideAndRound(compactVal, LONG_TEN_POWERS_TABLE[drop], mc.roundingMode.oldMode);</span><br><span class="line">            prec = longDigitLength(compactVal);</span><br><span class="line">            drop = prec - mcp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.intVal = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.intCompact = compactVal;</span><br><span class="line">    <span class="keyword">this</span>.scale = scale;</span><br><span class="line">    <span class="keyword">this</span>.precision = prec;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将 long 转换为 BigDecimal。BigDecimal 的标度为零。 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> val	要转换为 BigDecimal 的 long 值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BigDecimal</span><span class="params">(<span class="keyword">long</span> val)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.intCompact = val;</span><br><span class="line">    <span class="keyword">this</span>.intVal = (val == INFLATED) ? INFLATED_BIGINT : <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.scale = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BigDecimal</span><span class="params">(<span class="keyword">long</span> val, MathContext mc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> mcp = mc.precision;</span><br><span class="line">    <span class="keyword">int</span> mode = mc.roundingMode.oldMode;</span><br><span class="line">    <span class="keyword">int</span> prec = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> scale = <span class="number">0</span>;</span><br><span class="line">    BigInteger intVal = (val == INFLATED) ? INFLATED_BIGINT : <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (mcp &gt; <span class="number">0</span>) &#123; <span class="comment">// do rounding</span></span><br><span class="line">        <span class="keyword">if</span> (val == INFLATED) &#123;</span><br><span class="line">            prec = <span class="number">19</span>;</span><br><span class="line">            <span class="keyword">int</span> drop = prec - mcp;</span><br><span class="line">            <span class="keyword">while</span> (drop &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                scale = checkScaleNonZero((<span class="keyword">long</span>) scale - drop);</span><br><span class="line">                intVal = divideAndRoundByTenPow(intVal, drop, mode);</span><br><span class="line">                val = compactValFor(intVal);</span><br><span class="line">                <span class="keyword">if</span> (val != INFLATED) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                prec = bigDigitLength(intVal);</span><br><span class="line">                drop = prec - mcp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (val != INFLATED) &#123;</span><br><span class="line">            prec = longDigitLength(val);</span><br><span class="line">            <span class="keyword">int</span> drop = prec - mcp;</span><br><span class="line">            <span class="keyword">while</span> (drop &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                scale = checkScaleNonZero((<span class="keyword">long</span>) scale - drop);</span><br><span class="line">                val = divideAndRound(val, LONG_TEN_POWERS_TABLE[drop], mc.roundingMode.oldMode);</span><br><span class="line">                prec = longDigitLength(val);</span><br><span class="line">                drop = prec - mcp;</span><br><span class="line">            &#125;</span><br><span class="line">            intVal = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.intVal = intVal;</span><br><span class="line">    <span class="keyword">this</span>.intCompact = val;</span><br><span class="line">    <span class="keyword">this</span>.scale = scale;</span><br><span class="line">    <span class="keyword">this</span>.precision = prec;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="内部类"><a href="#内部类" class="headerlink" title="内部类"></a>内部类</h2><h3 id="StringBuilderHelper"><a href="#StringBuilderHelper" class="headerlink" title="StringBuilderHelper"></a>StringBuilderHelper</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为BigDecimal对象构建字符串表示形式的私有类。</span></span><br><span class="line"><span class="comment"> * StringBuilderHelper是作为线程本地变量构造的,因此它是线程安全的</span></span><br><span class="line"><span class="comment"> * StringBuilder字段充当缓冲区来保存BigDecimal的临时表示</span></span><br><span class="line"><span class="comment"> * 如果其intCompact字段没有INFLATED,cmpCharArray将保存BigDecimal的压缩表示的所有字符(如果是负数,则"-"符号除外)</span></span><br><span class="line"><span class="comment"> * 它由对toString()及其在特定线程中的变体的所有调用共享</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">StringBuilderHelper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> StringBuilder sb;    <span class="comment">// BigDecimal字符串的占位符</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">char</span>[] cmpCharArray; <span class="comment">// 用于放置intCompact的字符数组</span></span><br><span class="line"></span><br><span class="line">    StringBuilderHelper() &#123;</span><br><span class="line">        sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="comment">// 所有非负的long都可以放入19个字符数组中。</span></span><br><span class="line">        cmpCharArray = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">19</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 访问器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">StringBuilder <span class="title">getStringBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sb.setLength(<span class="number">0</span>);<span class="comment">// 设置sb的长度为0</span></span><br><span class="line">        <span class="keyword">return</span> sb;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取cmpCharArray[]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">char</span>[] getCompactCharArray() &#123;</span><br><span class="line">        <span class="keyword">return</span> cmpCharArray;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将intCompact的字符放置到cmpCharArray中，并将偏移量返回到表示开始的数组中。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> intCompact 放入cmpCharArray数量。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 到表示开始的数组的偏移量。</span></span><br><span class="line"><span class="comment">     * 注意:intCompact必须大于或等于零。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">putIntCompact</span><span class="params">(<span class="keyword">long</span> intCompact)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">assert</span> intCompact &gt;= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> q;</span><br><span class="line">        <span class="keyword">int</span> r;</span><br><span class="line">        <span class="comment">// 因为我们是从最低有效位开始的，所以charPos指向cmpCharArray中的最后一个字符。</span></span><br><span class="line">        <span class="keyword">int</span> charPos = cmpCharArray.length;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 迭代，直到商符合int</span></span><br><span class="line">        <span class="keyword">while</span> (intCompact &gt; Integer.MAX_VALUE) &#123;</span><br><span class="line">            q = intCompact / <span class="number">100</span>;</span><br><span class="line">            r = (<span class="keyword">int</span>)(intCompact - q * <span class="number">100</span>);</span><br><span class="line">            intCompact = q;</span><br><span class="line">            cmpCharArray[--charPos] = DIGIT_ONES[r];</span><br><span class="line">            cmpCharArray[--charPos] = DIGIT_TENS[r];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 当i2 &gt;= 100时</span></span><br><span class="line">        <span class="keyword">int</span> q2;</span><br><span class="line">        <span class="keyword">int</span> i2 = (<span class="keyword">int</span>)intCompact;</span><br><span class="line">        <span class="keyword">while</span> (i2 &gt;= <span class="number">100</span>) &#123;</span><br><span class="line">            q2 = i2 / <span class="number">100</span>;</span><br><span class="line">            r  = i2 - q2 * <span class="number">100</span>;</span><br><span class="line">            i2 = q2;</span><br><span class="line">            cmpCharArray[--charPos] = DIGIT_ONES[r];</span><br><span class="line">            cmpCharArray[--charPos] = DIGIT_TENS[r];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cmpCharArray[--charPos] = DIGIT_ONES[i2];</span><br><span class="line">        <span class="keyword">if</span> (i2 &gt;= <span class="number">10</span>)<span class="comment">// 当i2 &gt;= 10时</span></span><br><span class="line">            cmpCharArray[--charPos] = DIGIT_TENS[i2];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> charPos;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">char</span>[] DIGIT_TENS = &#123;</span><br><span class="line">        <span class="string">'0'</span>, <span class="string">'0'</span>, <span class="string">'0'</span>, <span class="string">'0'</span>, <span class="string">'0'</span>, <span class="string">'0'</span>, <span class="string">'0'</span>, <span class="string">'0'</span>, <span class="string">'0'</span>, <span class="string">'0'</span>,</span><br><span class="line">        <span class="string">'1'</span>, <span class="string">'1'</span>, <span class="string">'1'</span>, <span class="string">'1'</span>, <span class="string">'1'</span>, <span class="string">'1'</span>, <span class="string">'1'</span>, <span class="string">'1'</span>, <span class="string">'1'</span>, <span class="string">'1'</span>,</span><br><span class="line">        <span class="string">'2'</span>, <span class="string">'2'</span>, <span class="string">'2'</span>, <span class="string">'2'</span>, <span class="string">'2'</span>, <span class="string">'2'</span>, <span class="string">'2'</span>, <span class="string">'2'</span>, <span class="string">'2'</span>, <span class="string">'2'</span>,</span><br><span class="line">        <span class="string">'3'</span>, <span class="string">'3'</span>, <span class="string">'3'</span>, <span class="string">'3'</span>, <span class="string">'3'</span>, <span class="string">'3'</span>, <span class="string">'3'</span>, <span class="string">'3'</span>, <span class="string">'3'</span>, <span class="string">'3'</span>,</span><br><span class="line">        <span class="string">'4'</span>, <span class="string">'4'</span>, <span class="string">'4'</span>, <span class="string">'4'</span>, <span class="string">'4'</span>, <span class="string">'4'</span>, <span class="string">'4'</span>, <span class="string">'4'</span>, <span class="string">'4'</span>, <span class="string">'4'</span>,</span><br><span class="line">        <span class="string">'5'</span>, <span class="string">'5'</span>, <span class="string">'5'</span>, <span class="string">'5'</span>, <span class="string">'5'</span>, <span class="string">'5'</span>, <span class="string">'5'</span>, <span class="string">'5'</span>, <span class="string">'5'</span>, <span class="string">'5'</span>,</span><br><span class="line">        <span class="string">'6'</span>, <span class="string">'6'</span>, <span class="string">'6'</span>, <span class="string">'6'</span>, <span class="string">'6'</span>, <span class="string">'6'</span>, <span class="string">'6'</span>, <span class="string">'6'</span>, <span class="string">'6'</span>, <span class="string">'6'</span>,</span><br><span class="line">        <span class="string">'7'</span>, <span class="string">'7'</span>, <span class="string">'7'</span>, <span class="string">'7'</span>, <span class="string">'7'</span>, <span class="string">'7'</span>, <span class="string">'7'</span>, <span class="string">'7'</span>, <span class="string">'7'</span>, <span class="string">'7'</span>,</span><br><span class="line">        <span class="string">'8'</span>, <span class="string">'8'</span>, <span class="string">'8'</span>, <span class="string">'8'</span>, <span class="string">'8'</span>, <span class="string">'8'</span>, <span class="string">'8'</span>, <span class="string">'8'</span>, <span class="string">'8'</span>, <span class="string">'8'</span>,</span><br><span class="line">        <span class="string">'9'</span>, <span class="string">'9'</span>, <span class="string">'9'</span>, <span class="string">'9'</span>, <span class="string">'9'</span>, <span class="string">'9'</span>, <span class="string">'9'</span>, <span class="string">'9'</span>, <span class="string">'9'</span>, <span class="string">'9'</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">char</span>[] DIGIT_ONES = &#123;</span><br><span class="line">        <span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>,</span><br><span class="line">        <span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>,</span><br><span class="line">        <span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>,</span><br><span class="line">        <span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>,</span><br><span class="line">        <span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>,</span><br><span class="line">        <span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>,</span><br><span class="line">        <span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>,</span><br><span class="line">        <span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>,</span><br><span class="line">        <span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>,</span><br><span class="line">        <span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="UnsafeHolder"><a href="#UnsafeHolder" class="headerlink" title="UnsafeHolder"></a>UnsafeHolder</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UnsafeHolder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> sun.misc.Unsafe unsafe;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> intCompactOffset;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> intValOffset;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            unsafe = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">            intCompactOffset = unsafe.objectFieldOffset</span><br><span class="line">                (BigDecimal.class.getDeclaredField("intCompact"));</span><br><span class="line">            intValOffset = unsafe.objectFieldOffset</span><br><span class="line">                (BigDecimal.class.getDeclaredField("intVal"));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ExceptionInInitializerError(ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setIntCompactVolatile</span><span class="params">(BigDecimal bd, <span class="keyword">long</span> val)</span> </span>&#123;</span><br><span class="line">        unsafe.putLongVolatile(bd, intCompactOffset, val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setIntValVolatile</span><span class="params">(BigDecimal bd, BigInteger val)</span> </span>&#123;</span><br><span class="line">        unsafe.putObjectVolatile(bd, intValOffset, val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="主要方法"><a href="#主要方法" class="headerlink" title="主要方法"></a>主要方法</h2><h3 id="自动装箱-静态工厂方法"><a href="#自动装箱-静态工厂方法" class="headerlink" title="自动装箱(静态工厂方法)"></a>自动装箱(静态工厂方法)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将long非标度值和int标度转换为BigDecimal.提供的此"静态工厂方法"优先于(long, int)构造方法,因为前者允许重用经常使用的BigDecimal值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> unscaledVal	BigDecimal 的非标度值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> scale	BigDecimal 的标度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	其值为 (unscaledVal × 10的-scale次幂) 的 BigDecimal</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BigDecimal <span class="title">valueOf</span><span class="params">(<span class="keyword">long</span> unscaledVal, <span class="keyword">int</span> scale)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (scale == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> valueOf(unscaledVal);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (unscaledVal == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> zeroValueOf(scale);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BigDecimal(unscaledVal == INFLATED ? INFLATED_BIGINT : <span class="keyword">null</span>,unscaledVal, scale, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将long值转换为具有零标度的BigDecimal.提供的此"静态工厂方法"优先于(long)构造方法,因为前者允许重用经常使用的BigDecimal值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> val	BigDecimal 的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	其值为 val 的 BigDecimal</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BigDecimal <span class="title">valueOf</span><span class="params">(<span class="keyword">long</span> val)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 不超过缓存,直接返回缓存</span></span><br><span class="line">    <span class="keyword">if</span> (val &gt;= <span class="number">0</span> &amp;&amp; val &lt; zeroThroughTen.length)</span><br><span class="line">        <span class="keyword">return</span> zeroThroughTen[(<span class="keyword">int</span>)val];</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (val != INFLATED)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BigDecimal(<span class="keyword">null</span>, val, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BigDecimal(INFLATED_BIGINT, val, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> BigDecimal <span class="title">valueOf</span><span class="params">(<span class="keyword">long</span> unscaledVal, <span class="keyword">int</span> scale, <span class="keyword">int</span> prec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (scale == <span class="number">0</span> &amp;&amp; unscaledVal &gt;= <span class="number">0</span> &amp;&amp; unscaledVal &lt; zeroThroughTen.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> zeroThroughTen[(<span class="keyword">int</span>) unscaledVal];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (unscaledVal == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> zeroValueOf(scale);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BigDecimal(unscaledVal == INFLATED ? INFLATED_BIGINT : <span class="keyword">null</span>, unscaledVal, scale, prec);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> BigDecimal <span class="title">valueOf</span><span class="params">(BigInteger intVal, <span class="keyword">int</span> scale, <span class="keyword">int</span> prec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> val = compactValFor(intVal);</span><br><span class="line">    <span class="keyword">if</span> (val == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> zeroValueOf(scale);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (scale == <span class="number">0</span> &amp;&amp; val &gt;= <span class="number">0</span> &amp;&amp; val &lt; zeroThroughTen.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> zeroThroughTen[(<span class="keyword">int</span>) val];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BigDecimal(intVal, val, scale, prec);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> BigDecimal <span class="title">zeroValueOf</span><span class="params">(<span class="keyword">int</span> scale)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (scale &gt;= <span class="number">0</span> &amp;&amp; scale &lt; ZERO_SCALED_BY.length)</span><br><span class="line">        <span class="keyword">return</span> ZERO_SCALED_BY[scale];</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BigDecimal(BigInteger.ZERO, <span class="number">0</span>, scale, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用Double.toString(double)方法提供的double规范的字符串表示形式将double转换为BigDecimal</span></span><br><span class="line"><span class="comment"> * 注：这通常是将double(或float)转化为BigDecimal的首选方法,因为返回的值等于从构造BigDecimal(使用 Double.toString(double)得到的结果)得到的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> val	要转换为 BigDecimal 的 double</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	其值等于或约等于 val 值的 BigDecimal</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BigDecimal <span class="title">valueOf</span><span class="params">(<span class="keyword">double</span> val)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 提醒:一个zero double返回"0.0",因此我们不能快速路径来使用常量zero.这一点可能非常重要,足以在以后证明工厂方法、缓存或一些私有常量是合理的</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BigDecimal(Double.toString(val));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="算术运算"><a href="#算术运算" class="headerlink" title="算术运算"></a>算术运算</h3><h4 id="加法运算"><a href="#加法运算" class="headerlink" title="加法运算"></a>加法运算</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回一个 BigDecimal,其值为(this + augend),其标度为max(this.scale(), augend.scale())</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> augend	将添加到此 BigDecimal 中的值。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	this + augend</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">add</span><span class="params">(BigDecimal augend)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.intCompact != INFLATED) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((augend.intCompact != INFLATED)) &#123;</span><br><span class="line">            <span class="keyword">return</span> add(<span class="keyword">this</span>.intCompact, <span class="keyword">this</span>.scale, augend.intCompact, augend.scale);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> add(<span class="keyword">this</span>.intCompact, <span class="keyword">this</span>.scale, augend.intVal, augend.scale);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((augend.intCompact != INFLATED)) &#123;</span><br><span class="line">            <span class="keyword">return</span> add(augend.intCompact, augend.scale, <span class="keyword">this</span>.intVal, <span class="keyword">this</span>.scale);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> add(<span class="keyword">this</span>.intVal, <span class="keyword">this</span>.scale, augend.intVal, augend.scale);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回其值为(this + augend)的BigDecimal(根据上下文设置进行舍入)</span></span><br><span class="line"><span class="comment"> * 如果任一数字为零,并且精度设置为非零,则其他数字(必要时进行舍入)可以作为结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> augend	将添加到此 BigDecimal 中的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mc	要使用的上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	this + augend，必要时进行舍入</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">add</span><span class="params">(BigDecimal augend, MathContext mc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mc.precision == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> add(augend);</span><br><span class="line">    BigDecimal lhs = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果任意一个数字都是0,则使用另一个数字(如果需要的话)进行四舍五入和缩放</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">boolean</span> lhsIsZero = lhs.signum() == <span class="number">0</span>; <span class="comment">// 判断lhs的值是否为0</span></span><br><span class="line">        <span class="keyword">boolean</span> augendIsZero = augend.signum() == <span class="number">0</span>; <span class="comment">// 判断augend的值是否为0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (lhsIsZero || augendIsZero) &#123;</span><br><span class="line">            <span class="comment">// 获取lhs.scale()和augend.scale()中较大的一个</span></span><br><span class="line">            <span class="keyword">int</span> preferredScale = Math.max(lhs.scale(), augend.scale());</span><br><span class="line">            BigDecimal result;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lhsIsZero &amp;&amp; augendIsZero) <span class="comment">// 都为0</span></span><br><span class="line">                <span class="keyword">return</span> zeroValueOf(preferredScale);</span><br><span class="line">            <span class="comment">// 判断当前对象的值是否为0,根据mc设置返回一个augend或者lhs四舍五入的BigDecimal对象    </span></span><br><span class="line">            result = lhsIsZero ? doRound(augend, mc) : doRound(lhs, mc);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (result.scale() == preferredScale) <span class="comment">// 判断结果标度是否为最大</span></span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (result.scale() &gt; preferredScale) &#123; <span class="comment">// 结果标度大于最大</span></span><br><span class="line">                <span class="comment">// 从当前BigDecimal对象中删除不重要的后置零,直到不能删除更多的零为止</span></span><br><span class="line">                <span class="keyword">return</span> stripZerosToMatchScale(result.intVal, result.intCompact, result.scale, preferredScale);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// result.scale &lt; preferredScale</span></span><br><span class="line">                <span class="keyword">int</span> precisionDiff = mc.precision - result.precision();</span><br><span class="line">                <span class="keyword">int</span> scaleDiff     = preferredScale - result.scale();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (precisionDiff &gt;= scaleDiff) <span class="comment">// 精度差大于等于标度差</span></span><br><span class="line">                    <span class="keyword">return</span> result.setScale(preferredScale); <span class="comment">// 可以达到目标规模</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="keyword">return</span> result.setScale(result.scale() + precisionDiff);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> padding = (<span class="keyword">long</span>) lhs.scale - augend.scale;</span><br><span class="line">    <span class="keyword">if</span> (padding != <span class="number">0</span>) &#123; <span class="comment">// 标度不同;需要对齐</span></span><br><span class="line">        <span class="comment">// 返回一个长度为2的数组,其条目的和等于lhs和augend参数的整数和</span></span><br><span class="line">        BigDecimal arg[] = preAlign(lhs, augend, padding, mc);</span><br><span class="line">        <span class="comment">// 匹配arg[0]和arg[1]的scales，以校准它们的最小有效数字</span></span><br><span class="line">        matchScale(arg);</span><br><span class="line">        lhs = arg[<span class="number">0</span>];</span><br><span class="line">        augend = arg[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据mc设置返回一个d的四舍五入的BigDecimal对象</span></span><br><span class="line">    <span class="keyword">return</span> doRound(lhs.inflated().add(augend.inflated()), lhs.scale, mc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回一个长度为2的数组,其条目的和等于lhs和augend参数的整数和</span></span><br><span class="line"><span class="comment"> * 如果数字的位置参数有足够的差距,值较小的可以浓缩成一个"粘滞位",如果最终结果的精度不包括小数量级操作数的高阶数,则最终结果将以相同的方式进行四舍五入</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 注意，虽然严格来说这是一种优化，但它的实际应用范围更广。</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 这对应于固定精度浮点加法器中的预移位操作;这个方法由于MathContext所决定的结果的可变精度而变得复杂</span></span><br><span class="line"><span class="comment"> * 更细致的操作可以实现较小幅度操作数上的"右偏移",从而即使部分重叠的有效数也可以减少较小操作数的位数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> lhs	当前 BigDecimal 中的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> augend	将添加到此BigDecimal中的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> padding  lhs.scale- padding.scale</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mc	要使用的上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> BigDecimal[] preAlign(BigDecimal lhs, BigDecimal augend, <span class="keyword">long</span> padding, MathContext mc) &#123;</span><br><span class="line">    <span class="keyword">assert</span> padding != <span class="number">0</span>;</span><br><span class="line">    BigDecimal big;</span><br><span class="line">    BigDecimal small;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (padding &lt; <span class="number">0</span>) &#123; <span class="comment">// lhs大,被加数小</span></span><br><span class="line">        big = lhs;</span><br><span class="line">        small = augend;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// lhs小;被加数大</span></span><br><span class="line">        big = augend;</span><br><span class="line">        small = lhs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 这是结果的ulp的估计尺度;它假设结果没有一个真正的add(例如999 + 1 =&gt; - 1000)或任何一个借位的减法取消(例如：100 - 1.2 = &gt; 98.8)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">long</span> estResultUlpScale = (<span class="keyword">long</span>) big.scale - big.precision() + mc.precision;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * big的低位是big.scale().这是真的,不管大的规模是正的还是负的</span></span><br><span class="line"><span class="comment">     * 小的高阶位是small.scale - (small.precision() - 1)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">long</span> smallHighDigitPos = (<span class="keyword">long</span>) small.scale - small.precision() + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (smallHighDigitPos &gt; big.scale + <span class="number">2</span> &amp;&amp; <span class="comment">// 大小不相交</span></span><br><span class="line">        smallHighDigitPos &gt; estResultUlpScale + <span class="number">2</span>) &#123; <span class="comment">// small 不可见</span></span><br><span class="line">        small = BigDecimal.valueOf(small.signum(), <span class="keyword">this</span>.checkScale(Math.max(big.scale, estResultUlpScale) + <span class="number">3</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 因为加法是对称的,所以在返回的操作数中保持输入顺序并不重要</span></span><br><span class="line">    BigDecimal[] result = &#123;big, small&#125;;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="减法操作"><a href="#减法操作" class="headerlink" title="减法操作"></a>减法操作</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回一个 BigDecimal,其值为(this - subtrahend),其标度为max(this.scale(), subtrahend.scale()) </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> subtrahend	从此 BigDecimal 减去的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	this - subtrahend</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">subtract</span><span class="params">(BigDecimal subtrahend)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.intCompact != INFLATED) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((subtrahend.intCompact != INFLATED)) &#123;</span><br><span class="line">            <span class="keyword">return</span> add(<span class="keyword">this</span>.intCompact, <span class="keyword">this</span>.scale, -subtrahend.intCompact, subtrahend.scale);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> add(<span class="keyword">this</span>.intCompact, <span class="keyword">this</span>.scale, subtrahend.intVal.negate(), subtrahend.scale);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((subtrahend.intCompact != INFLATED)) &#123;</span><br><span class="line">            <span class="comment">// 在此BigDecimal的值对之前给出的一组减数目的值,以避免对专门化的add方法进行重载</span></span><br><span class="line">            <span class="keyword">return</span> add(-subtrahend.intCompact, subtrahend.scale, <span class="keyword">this</span>.intVal, <span class="keyword">this</span>.scale);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> add(<span class="keyword">this</span>.intVal, <span class="keyword">this</span>.scale, subtrahend.intVal.negate(), subtrahend.scale);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回其值为(this - subtrahend)的BigDecimal(根据上下文设置进行舍入) </span></span><br><span class="line"><span class="comment"> * 如果subtrahend为零,则将其(必要时进行舍入)作为结果.如果为零,则该结果是subtrahend.negate(mc)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> subtrahend	从此 BigDecimal 减去的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mc	要使用的上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	this - subtrahend，必要时进行舍入</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">subtract</span><span class="params">(BigDecimal subtrahend, MathContext mc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mc.precision == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> subtract(subtrahend);</span><br><span class="line">    <span class="comment">// negate(): 获取当前对象,其值为(-subtrahend),其标度为subtrahend.scale()</span></span><br><span class="line">    <span class="comment">// 在add()中共享特殊的四舍五入</span></span><br><span class="line">    <span class="keyword">return</span> add(subtrahend.negate(), mc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="乘法运算"><a href="#乘法运算" class="headerlink" title="乘法运算"></a>乘法运算</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回一个 BigDecimal,其值为(this × multiplicand),其标度为(this.scale() + multiplicand.scale())</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> multiplicand 乘以此 BigDecimal 的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	this * multiplicand</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">multiply</span><span class="params">(BigDecimal multiplicand)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 验证(long)scale + multiplicand.scale为int,并返回(long)scale + multiplicand.scale值</span></span><br><span class="line">    <span class="keyword">int</span> productScale = checkScale((<span class="keyword">long</span>) scale + multiplicand.scale);</span><br><span class="line">    <span class="comment">// 可以做一个更聪明的检查,将INFLATED的检查合并到溢出计算中</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.intCompact != INFLATED) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((multiplicand.intCompact != INFLATED)) &#123;</span><br><span class="line">            <span class="keyword">return</span> multiply(<span class="keyword">this</span>.intCompact, multiplicand.intCompact, productScale);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> multiply(<span class="keyword">this</span>.intCompact, multiplicand.intVal, productScale);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// 溢出    </span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((multiplicand.intCompact != INFLATED)) &#123;</span><br><span class="line">            <span class="keyword">return</span> multiply(multiplicand.intCompact, <span class="keyword">this</span>.intVal, productScale);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> multiply(<span class="keyword">this</span>.intVal, multiplicand.intVal, productScale);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回其值为 (this × multiplicand) 的 BigDecimal(根据上下文设置进行舍入)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> multiplicand	乘以此 BigDecimal 的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mc	要使用的上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	必要时舍入的 this * multiplicand</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">multiply</span><span class="params">(BigDecimal multiplicand, MathContext mc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mc.precision == <span class="number">0</span>)</span><br><span class="line">    	<span class="comment">// this * multiplicand</span></span><br><span class="line">        <span class="keyword">return</span> multiply(multiplicand);</span><br><span class="line">    <span class="comment">// 根据mc设置返回一个(this * multiplicand)四舍五入的BigDecimal对象    </span></span><br><span class="line">    <span class="keyword">int</span> productScale = checkScale((<span class="keyword">long</span>) scale + multiplicand.scale);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.intCompact != INFLATED) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((multiplicand.intCompact != INFLATED)) &#123;</span><br><span class="line">            <span class="keyword">return</span> multiplyAndRound(<span class="keyword">this</span>.intCompact, multiplicand.intCompact, productScale, mc);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> multiplyAndRound(<span class="keyword">this</span>.intCompact, multiplicand.intVal, productScale, mc);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((multiplicand.intCompact != INFLATED)) &#123;</span><br><span class="line">            <span class="keyword">return</span> multiplyAndRound(multiplicand.intCompact, <span class="keyword">this</span>.intVal, productScale, mc);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> multiplyAndRound(<span class="keyword">this</span>.intVal, multiplicand.intVal, productScale, mc);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="除法运算"><a href="#除法运算" class="headerlink" title="除法运算"></a>除法运算</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回一个BigDecimal,其值为(this/divisor),其标度为指定标度.如果必须执行舍入,以生成具有指定标度的结果,则应用指定的舍入模式</span></span><br><span class="line"><span class="comment"> * 相对于此遗留方法,应优先使用新的divide(BigDecimal, int, RoundingMode)方法 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> divisor	此 BigDecimal 要除以的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> scale	要返回的 BigDecimal 商的标度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> roundingMode	要应用的舍入模式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	this / divisor </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">divide</span><span class="params">(BigDecimal divisor, <span class="keyword">int</span> scale, <span class="keyword">int</span> roundingMode)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 注意:这个方法*必须*返回一个新对象，因为divideAndRound使用divide生成一个值，然后修改该值的标度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (roundingMode &lt; ROUND_UP || roundingMode &gt; ROUND_UNNECESSARY)</span><br><span class="line">    	<span class="comment">// 如果 roundingMode 不表示一个有效的舍入模式</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid rounding mode"</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.intCompact != INFLATED) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((divisor.intCompact != INFLATED)) &#123;</span><br><span class="line">            <span class="keyword">return</span> divide(<span class="keyword">this</span>.intCompact, <span class="keyword">this</span>.scale, divisor.intCompact, divisor.scale, scale, roundingMode);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> divide(<span class="keyword">this</span>.intCompact, <span class="keyword">this</span>.scale, divisor.intVal, divisor.scale, scale, roundingMode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((divisor.intCompact != INFLATED)) &#123;</span><br><span class="line">            <span class="keyword">return</span> divide(<span class="keyword">this</span>.intVal, <span class="keyword">this</span>.scale, divisor.intCompact, divisor.scale, scale, roundingMode);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> divide(<span class="keyword">this</span>.intVal, <span class="keyword">this</span>.scale, divisor.intVal, divisor.scale, scale, roundingMode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">divide</span><span class="params">(BigDecimal divisor, <span class="keyword">int</span> scale, RoundingMode roundingMode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> divide(divisor, scale, roundingMode.oldMode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回一个 BigDecimal,其值为(this / divisor),其首选标度为(this.scale() - divisor.scale())</span></span><br><span class="line"><span class="comment"> * 如果无法表示准确的商值(因为它有无穷的十进制扩展),则抛出 ArithmeticException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> divisor	此 BigDecimal 要相除的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	this / divisor </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">divide</span><span class="params">(BigDecimal divisor)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 先处理零情况</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (divisor.signum() == <span class="number">0</span>) &#123;   <span class="comment">// x/0</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.signum() == <span class="number">0</span>)    <span class="comment">// 0/0</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArithmeticException(<span class="string">"Division undefined"</span>);  <span class="comment">// NaN</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArithmeticException(<span class="string">"Division by zero"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算优先 scale</span></span><br><span class="line">    <span class="comment">// (long)this.scale - divisor.scale强转为int类型,判断是否等于int类型后的值,若果是返回int类型后的值,否则小于0,返回integer最小值,否则最大值</span></span><br><span class="line">    <span class="keyword">int</span> preferredScale = saturateLong((<span class="keyword">long</span>) <span class="keyword">this</span>.scale - divisor.scale);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.signum() == <span class="number">0</span>) <span class="comment">// 0/y</span></span><br><span class="line">        <span class="keyword">return</span> zeroValueOf(preferredScale);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 如果这个除数的商有一个有限的小数展开,展开的位数不能超过(a.precision()+ceil(10*b.precision)/3)位.</span></span><br><span class="line"><span class="comment">         * 因此,使用这种精度创建MathContext对象,并使用不必要的舍入模式进行除法</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        MathContext mc = <span class="keyword">new</span> MathContext((<span class="keyword">int</span>)Math.min(<span class="keyword">this</span>.precision() +               (<span class="keyword">long</span>)Math.ceil(<span class="number">10.0</span>*divisor.precision()/<span class="number">3.0</span>), Integer.MAX_VALUE),RoundingMode.UNNECESSARY);</span><br><span class="line">        </span><br><span class="line">        BigDecimal quotient;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 返回一个 BigDecimal,其值为(this / divisor),其标度为 this.scale() </span></span><br><span class="line">            quotient = <span class="keyword">this</span>.divide(divisor, mc);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ArithmeticException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArithmeticException(<span class="string">"Non-terminating decimal expansion; "</span> + <span class="string">"no exact representable decimal result."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取quotient 的标度</span></span><br><span class="line">        <span class="keyword">int</span> quotientScale = quotient.scale();</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * divide(BigDecimal, mc)尝试通过删除后面的零来将商调整为所需的商;由于精确divide method没有明确的数字限制,我们也可以加上0。</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        <span class="keyword">if</span> (preferredScale &gt; quotientScale)</span><br><span class="line">        <span class="comment">// 返回BigDecimal,其标度为preferredScale,其非标度值通过此 BigDecimal的非标度值乘以或除以十的适当次幂来确定,以维护其总值</span></span><br><span class="line">            <span class="keyword">return</span> quotient.setScale(preferredScale, ROUND_UNNECESSARY);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> quotient;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回其值为(this / divisor)的 BigDecimal(根据上下文设置进行舍入)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> divisor	此 BigDecimal 要除以的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mc	要使用的上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	this / divisor，必要时进行舍入</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">divide</span><span class="params">(BigDecimal divisor, MathContext mc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> mcp = mc.precision;</span><br><span class="line">    <span class="keyword">if</span> (mcp == <span class="number">0</span>)</span><br><span class="line">    <span class="comment">// 返回一个 BigDecimal,其值为(this/divisor),其首选标度为 (this.scale()-divisor.scale())</span></span><br><span class="line">        <span class="keyword">return</span> divide(divisor);</span><br><span class="line"></span><br><span class="line">    BigDecimal dividend = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">long</span> preferredScale = (<span class="keyword">long</span>)dividend.scale - divisor.scale;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 现在计算答案.我们使用现有的divide-and-round method,但是当这轮进行缩放时,我们必须对这里的值进行标准化以达到预期的结果</span></span><br><span class="line"><span class="comment">     * 对于x/y,我们首先处理y=0和x=0,然后对x和y进行标准化,得到具有以下约束条件的x'和y':</span></span><br><span class="line"><span class="comment">     * 	(a) 0.1 &lt;= x' &lt; 1</span></span><br><span class="line"><span class="comment">     *  (b)  x' &lt;= y' &lt; 10*x'</span></span><br><span class="line"><span class="comment">     * 将x'/y'除以所需的scale设置为mc.precision,则会得到范围0.1到1的四舍五入结果,</span></span><br><span class="line"><span class="comment">     * 精确到正确的数字数(如果结果为1.000，则除外……)当x=y,或者四舍五入超过1.case会适当地减少到1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (divisor.signum() == <span class="number">0</span>) &#123;      <span class="comment">// x/0</span></span><br><span class="line">        <span class="keyword">if</span> (dividend.signum() == <span class="number">0</span>)    <span class="comment">// 0/0</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArithmeticException(<span class="string">"Division undefined"</span>);  <span class="comment">// NaN</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArithmeticException(<span class="string">"Division by zero"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (dividend.signum() == <span class="number">0</span>) <span class="comment">// 0/y</span></span><br><span class="line">        <span class="keyword">return</span> zeroValueOf(saturateLong(preferredScale));</span><br><span class="line">    <span class="keyword">int</span> xscale = dividend.precision();</span><br><span class="line">    <span class="keyword">int</span> yscale = divisor.precision();</span><br><span class="line">    <span class="keyword">if</span>(dividend.intCompact!=INFLATED) &#123;</span><br><span class="line">        <span class="keyword">if</span>(divisor.intCompact!=INFLATED) &#123;</span><br><span class="line">            <span class="keyword">return</span> divide(dividend.intCompact, xscale, divisor.intCompact, yscale, preferredScale, mc);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> divide(dividend.intCompact, xscale, divisor.intVal, yscale, preferredScale, mc);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(divisor.intCompact!=INFLATED) &#123;</span><br><span class="line">            <span class="keyword">return</span> divide(dividend.intVal, xscale, divisor.intCompact, yscale, preferredScale, mc);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> divide(dividend.intVal, xscale, divisor.intVal, yscale, preferredScale, mc);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回 BigDecimal,其值为向下舍入所得商值(this / divisor) 的整数部分.该结果的首选标度为(this.scale() - divisor.scale()) </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> divisor	此 BigDecimal 要除以的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	this / divisor 的整数部分</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">divideToIntegralValue</span><span class="params">(BigDecimal divisor)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 计算优先 scale</span></span><br><span class="line">	<span class="comment">// (long)this.scale - divisor.scale强转为int类型,判断是否等于int类型后的值,若果是,返回int类型后的值,否则小于0;返回integer最小值,否则最大值</span></span><br><span class="line">    <span class="keyword">int</span> preferredScale = saturateLong((<span class="keyword">long</span>) <span class="keyword">this</span>.scale - divisor.scale);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.compareMagnitude(divisor) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 更快when this &lt;&lt; divisor</span></span><br><span class="line">        <span class="keyword">return</span> zeroValueOf(preferredScale);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.signum() == <span class="number">0</span> &amp;&amp; divisor.signum() != <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// 获取一个BigDecimal,其标度为指定值</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.setScale(preferredScale, ROUND_UNNECESSARY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行一个除法,用足够的数字四舍五入到一个正确的整数值;然后去掉任何小数</span></span><br><span class="line">    <span class="keyword">int</span> maxDigits = (<span class="keyword">int</span>)Math.min(<span class="keyword">this</span>.precision() + (<span class="keyword">long</span>)Math.ceil(<span class="number">10.0</span>*divisor.precision()/<span class="number">3.0</span>) + Math.abs((<span class="keyword">long</span>)<span class="keyword">this</span>.scale() - divisor.scale()) + <span class="number">2</span>,</span><br><span class="line">                                  Integer.MAX_VALUE);</span><br><span class="line">    <span class="comment">// 返回其值为(this/divisor)的BigDecimal(根据上下文设置进行舍入)               </span></span><br><span class="line">    BigDecimal quotient = <span class="keyword">this</span>.divide(divisor, <span class="keyword">new</span> MathContext(maxDigits,  RoundingMode.DOWN)); </span><br><span class="line">    <span class="keyword">if</span> (quotient.scale &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 获取一个BigDecimal,其标度为指定值</span></span><br><span class="line">        quotient = quotient.setScale(<span class="number">0</span>, RoundingMode.DOWN);</span><br><span class="line">        <span class="comment">// 从当前BigDecimal对象中删除不重要的后置零,直到不能删除更多的零为止</span></span><br><span class="line">        quotient = stripZerosToMatchScale(quotient.intVal, quotient.intCompact, quotient.scale, preferredScale);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (quotient.scale &lt; preferredScale) &#123;</span><br><span class="line">        <span class="comment">// 如果需要,用零填充</span></span><br><span class="line">        quotient = quotient.setScale(preferredScale, ROUND_UNNECESSARY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> quotient;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回 BigDecimal,其值为(this / divisor)的整数部分.因为准确商值的整数部分与舍入模式无关,所以舍入模式不影响此方法返回的值</span></span><br><span class="line"><span class="comment"> * 该结果的首选标度是 (this.scale() - divisor.scale())。</span></span><br><span class="line"><span class="comment"> * 如果准确商值的整数部分需要的位数多于mc.precision,则抛出 ArithmeticException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> divisor	此 BigDecimal 要相除的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mc	要使用的上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	this / divisor 的整数部分</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">divideToIntegralValue</span><span class="params">(BigDecimal divisor, MathContext mc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mc.precision == <span class="number">0</span> || <span class="comment">// 确切的结果</span></span><br><span class="line">        (<span class="keyword">this</span>.compareMagnitude(divisor) &lt; <span class="number">0</span>)) <span class="comment">// 零结果</span></span><br><span class="line">        <span class="keyword">return</span> divideToIntegralValue(divisor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算优先scale</span></span><br><span class="line">    <span class="keyword">int</span> preferredScale = saturateLong((<span class="keyword">long</span>)<span class="keyword">this</span>.scale - divisor.scale);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 对mc.precision数字执行普通除法.如果余数的绝对值小于除数,则商的整数部分适合mc.precision数字</span></span><br><span class="line"><span class="comment">     * 接下来,从商中删除任何小数,并将scale调整为首选值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    BigDecimal result = <span class="keyword">this</span>.divide(divisor, <span class="keyword">new</span> MathContext(mc.precision, RoundingMode.DOWN));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result.scale() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 结果是一个整数.看商是否表示精确商的整数部分;如果是,计算出来的余数将小于除数</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        BigDecimal product = result.multiply(divisor);</span><br><span class="line">        <span class="comment">// 如果商是整数值,|dividend-product| &lt; |divisor|.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.subtract(product).compareMagnitude(divisor) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果 mc.precision &gt; 0,并且该结果需要的精度大于 mc.precision</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArithmeticException(<span class="string">"Division impossible"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result.scale() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 商的整数部分将适合于precision数字;重新计算商的scale 0,以避免双舍入,然后尝试调整,如果需要</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        result = result.setScale(<span class="number">0</span>, RoundingMode.DOWN);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// else result.scale() == 0;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> precisionDiff;</span><br><span class="line">    <span class="keyword">if</span> ((preferredScale &gt; result.scale()) &amp;&amp;</span><br><span class="line">        (precisionDiff = mc.precision - result.precision()) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> result.setScale(result.scale() +</span><br><span class="line">                               Math.min(precisionDiff, preferredScale - result.scale) );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 从当前BigDecimal对象中删除不重要的后置零,直到不能删除更多的零为止</span></span><br><span class="line">        <span class="keyword">return</span> stripZerosToMatchScale(result.intVal,result.intCompact,result.scale,preferredScale);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="求余运算"><a href="#求余运算" class="headerlink" title="求余运算"></a>求余运算</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回其值为 (this % divisor) 的 BigDecimal。 </span></span><br><span class="line"><span class="comment"> * 余数由 this.subtract(this.divideToIntegralValue(divisor).multiply(divisor)) 给出.注意:这不是模操作(结果可以为负)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> divisor	此 BigDecimal 要除以的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	this % divisor</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">remainder</span><span class="params">(BigDecimal divisor)</span> </span>&#123;</span><br><span class="line">    BigDecimal divrem[] = <span class="keyword">this</span>.divideAndRemainder(divisor);</span><br><span class="line">    <span class="keyword">return</span> divrem[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回其值为(this % divisor)的 BigDecimal(根据上下文设置进行舍入)</span></span><br><span class="line"><span class="comment"> * MathContext设置会影响用于计算余数的隐式除法.余数计算本身要进行准确的定义</span></span><br><span class="line"><span class="comment"> * 因此,余数包含的数字个数可能多于mc.getPrecision()</span></span><br><span class="line"><span class="comment"> *  余数由this.subtract(this.divideToIntegralValue(divisor, mc).multiply(divisor))给出.注意:这不是模操作(结果可以为负)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> divisor	此 BigDecimal 要相除的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mc	要使用的上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	this % divisor，必要时进行舍入</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> BigDecimal <span class="title">remainder</span><span class="params">(BigDecimal divisor, MathContext mc)</span> </span>&#123;</span><br><span class="line">    BigDecimal divrem[] = <span class="keyword">this</span>.divideAndRemainder(divisor, mc);</span><br><span class="line">    <span class="keyword">return</span> divrem[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回由两个元素组成的BigDecimal数组,该数组包含 divideToIntegralValue的结果,后跟对两个操作数计算所得到的remainder</span></span><br><span class="line"><span class="comment"> * 注意:如果同时需要整数商和余数,则此方法比分别使用 divideToIntegralValue和remainder方法更快速,因为相除仅需执行一次</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> divisor	此 BigDecimal 要相除的值和计算的余数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	由两个元素组成的BigDecimal数组：商值(divideToIntegralValue 的结果)是初始元素,余数是最终元素</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> BigDecimal[] divideAndRemainder(BigDecimal divisor) &#123;</span><br><span class="line">    <span class="comment">// 我们用恒等式x = i * y + r来确定r</span></span><br><span class="line">    BigDecimal[] result = <span class="keyword">new</span> BigDecimal[<span class="number">2</span>];</span><br><span class="line">    <span class="comment">// 返回 BigDecimal,其值为向下舍入所得商值(this / divisor) 的整数部分.该结果的首选标度为(this.scale() - divisor.scale())</span></span><br><span class="line">    result[<span class="number">0</span>] = <span class="keyword">this</span>.divideToIntegralValue(divisor);</span><br><span class="line">    <span class="comment">// 返回一个 BigDecimal,其值为(this - result[0].multiply(divisor)),其标度为max(this.scale(), result[0].multiply(divisor).scale())</span></span><br><span class="line">    result[<span class="number">1</span>] = <span class="keyword">this</span>.subtract(result[<span class="number">0</span>].multiply(divisor));</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回由两个元素组成的BigDecimal数组,该数组包含 divideToIntegralValue的结果,后跟根据上下文设置对两个操作数进行舍入计算所得到的remainder的结果 </span></span><br><span class="line"><span class="comment"> * 注意:如果同时需要整数商和余数,则此方法比分别使用 divideToIntegralValue和remainder方法更快速,因为相除仅需执行一次 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> divisor	此 BigDecimal 要相除的值和计算的余数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mc	要使用的上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	由两个元素组成的BigDecimal数组：商值(divideToIntegralValue 的结果)是初始元素,余数是最终元素</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> BigDecimal[] divideAndRemainder(BigDecimal divisor, MathContext mc) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mc.precision == <span class="number">0</span>)</span><br><span class="line">    <span class="comment">// 返回由两个元素组成的BigDecimal数组</span></span><br><span class="line">        <span class="keyword">return</span> divideAndRemainder(divisor);</span><br><span class="line"></span><br><span class="line">    BigDecimal[] result = <span class="keyword">new</span> BigDecimal[<span class="number">2</span>];</span><br><span class="line">    BigDecimal lhs = <span class="keyword">this</span>;</span><br><span class="line">    <span class="comment">// 返回 BigDecimal,其值为(this / divisor)的整数部分</span></span><br><span class="line">    result[<span class="number">0</span>] = lhs.divideToIntegralValue(divisor, mc);</span><br><span class="line">    <span class="comment">// 返回一个BigDecimal,其值为(this - result[0].multiply(divisor)),其标度为max(this.scale(), result[0].multiply(divisor).scale())</span></span><br><span class="line">    result[<span class="number">1</span>] = lhs.subtract(result[<span class="number">0</span>].multiply(divisor));</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="次幂运算"><a href="#次幂运算" class="headerlink" title="次幂运算"></a>次幂运算</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回其值为(this的n次幂)的BigDecimal,准确计算该幂,使其具有无限精度</span></span><br><span class="line"><span class="comment"> * 参数n必须在0到999999999(包括)之间.ZERO.pow(0)返回ONE.注意:未来版本可能会扩展此方法允许的指数范围</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> n	此 BigDecimal 的幂</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	this的n次幂</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">pow</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">0</span> || n &gt; <span class="number">999999999</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArithmeticException(<span class="string">"Invalid operation"</span>);</span><br><span class="line">    <span class="comment">// 如果结果为溢流/欠流,则无需计算pow(n).不要试图支持"超常"的数字</span></span><br><span class="line">    <span class="keyword">int</span> newScale = checkScale((<span class="keyword">long</span>)scale * n);</span><br><span class="line">    <span class="comment">// 如果当前对象的intVal为空,分配适当的BigInteger给intVal字段</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BigDecimal(<span class="keyword">this</span>.inflated().pow(n), newScale);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回其值为(this)的BigDecimal.当前实现使用的是ANSI标准X3.274-1996中定义的核心算法(根据上下文设置进行舍入)</span></span><br><span class="line"><span class="comment"> * 一般情况下,返回的数值在具有选择精度的精确数值的两个ulp中.注意,未来版本可以使用不同的算法,以减少允许的错误范围,并增加允许的指数范围</span></span><br><span class="line"><span class="comment"> * X3.274-1996算法为： </span></span><br><span class="line"><span class="comment"> * 	如果出现以下情况,则抛出ArithmeticException异常 </span></span><br><span class="line"><span class="comment"> * 		abs(n) &gt; 999999999 </span></span><br><span class="line"><span class="comment"> * 		mc.precision == 0 且 n &lt; 0 </span></span><br><span class="line"><span class="comment"> * 		mc.precision &gt; 0 且 n 大于 mc.precision </span></span><br><span class="line"><span class="comment"> * 	如果n为零,则返回ONE(即使 this 为零),否则 </span></span><br><span class="line"><span class="comment"> * 		如果 n 为正数,则通过重复的平方技术将此结果计算到一个累加器中.每个附带累加器的乘法都使用与mc中相同的数学上下文设置,增加到 mc.precision + elength + 1的精度除外,其中elength表示n中的十进制数字的个数。 </span></span><br><span class="line"><span class="comment"> * 		如果 n 为负数,则将n 视为正数计算其结果;然后使用上面指定的工作精度,用一除以此值.然后将正数或负数的最终值舍入为目标精度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> n	此 BigDecimal 的幂</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mc	要使用的上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	使用ANSI标准X3.274-1996算法的this的n次幂 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">pow</span><span class="params">(<span class="keyword">int</span> n, MathContext mc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mc.precision == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> pow(n);</span><br><span class="line">    <span class="keyword">if</span> (n &lt; -<span class="number">999999999</span> || n &gt; <span class="number">999999999</span>) <span class="comment">// 如果n超出范围</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArithmeticException(<span class="string">"Invalid operation"</span>);</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) <span class="comment">// 如果n为零,则返回ONE(即使this为零)</span></span><br><span class="line">        <span class="keyword">return</span> ONE;                      <span class="comment">// x**0 == 1 in X3.274</span></span><br><span class="line">    BigDecimal lhs = <span class="keyword">this</span>;</span><br><span class="line">    MathContext workmc = mc;           <span class="comment">// 设置working</span></span><br><span class="line">    <span class="keyword">int</span> mag = Math.abs(n);               <span class="comment">// 返回n的绝对值</span></span><br><span class="line">    <span class="keyword">if</span> (mc.precision &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> elength = longDigitLength(mag); <span class="comment">// 以数字表示的mag的绝对值的长度</span></span><br><span class="line">        <span class="keyword">if</span> (elength &gt; mc.precision)        <span class="comment">// X3.274规则</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArithmeticException(<span class="string">"Invalid operation"</span>);</span><br><span class="line">        <span class="comment">// 构造一个新的MathContext,它具有指定的精度(mc.precision + elength + 1)和舍入模式(mc.roundingMode)</span></span><br><span class="line">        workmc = <span class="keyword">new</span> MathContext(mc.precision + elength + <span class="number">1</span>,</span><br><span class="line">                                  mc.roundingMode);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 准备进行power计算…</span></span><br><span class="line">    BigDecimal acc = ONE;           <span class="comment">// accumulator</span></span><br><span class="line">    <span class="keyword">boolean</span> seenbit = <span class="keyword">false</span>;        <span class="comment">// 当我们看到1-bit的时候</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">1</span>;;i++) &#123;            <span class="comment">// 对于每个bit[忽略上面bit]</span></span><br><span class="line">        mag += mag;                 <span class="comment">// 左进位 1 bit</span></span><br><span class="line">        <span class="keyword">if</span> (mag &lt; <span class="number">0</span>) &#123;              <span class="comment">// 上面bit已设置</span></span><br><span class="line">            seenbit = <span class="keyword">true</span>;         <span class="comment">// OK,我们已关闭</span></span><br><span class="line">            acc = acc.multiply(lhs, workmc); <span class="comment">// acc=acc*x</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">31</span>)</span><br><span class="line">            <span class="keyword">break</span>;                  <span class="comment">// 这是最后 1 bit</span></span><br><span class="line">        <span class="keyword">if</span> (seenbit)</span><br><span class="line">            acc=acc.multiply(acc, workmc);   <span class="comment">// acc=acc*acc [平方]</span></span><br><span class="line">            <span class="comment">// 否则,平方是没有意义的</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果是-n,用工作精度计算倒数precision</span></span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">0</span>) <span class="comment">// [因此 mc.precision&gt;0]</span></span><br><span class="line">        acc=ONE.divide(acc, workmc);</span><br><span class="line">    <span class="comment">// 四舍五入到最后的精度和零,根据mc设置返回一个acc的四舍五入的BigDecimal对象</span></span><br><span class="line">    <span class="keyword">return</span> doRound(acc, mc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="绝对值"><a href="#绝对值" class="headerlink" title="绝对值"></a>绝对值</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回BigDecimal,其值为此BigDecimal的绝对值,其标度为 this.scale()</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	abs(this)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">abs</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 判断当前的值是否小于0,小于0,返回相反数,否则返回当前值</span></span><br><span class="line">    <span class="keyword">return</span> (signum() &lt; <span class="number">0</span> ? negate() : <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回其值为此BigDecimal绝对值的BigDecimal(根据上下文设置进行舍入)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mc	要使用的上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	abs(this),必要时进行舍入</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">abs</span><span class="params">(MathContext mc)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 判断当前的值是否小于0,小于0,返回相反数,否则返回当前值</span></span><br><span class="line">    <span class="keyword">return</span> (signum() &lt; <span class="number">0</span> ? negate(mc) : plus(mc));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回BigDecimal,其值为(-this),其标度为this.scale() </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	-this</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">negate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    BigDecimal result;</span><br><span class="line">    <span class="comment">//将-intCompact和scale转换为BigDecimal</span></span><br><span class="line">    <span class="keyword">if</span> (intCompact != INFLATED)</span><br><span class="line">        result = BigDecimal.valueOf(-intCompact, scale);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">    	<span class="comment">// 将BigInteger的(intVal.negate()的相反数)和scale转换为 BigDecimal</span></span><br><span class="line">        result = <span class="keyword">new</span> BigDecimal(intVal.negate(), scale);</span><br><span class="line">        result.precision = precision;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回其值为(-this)的BigDecimal(根据上下文设置进行舍入)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mc	要使用的上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	abs(this)，必要时进行舍入</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">negate</span><span class="params">(MathContext mc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> negate().plus(mc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回BigDecimal,其值为(+this),其标度为this.scale()</span></span><br><span class="line"><span class="comment"> * 此方法仅返回此BigDecimal,该方法与一元减方法negate()对称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	this</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">plus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回其值为(+this)的BigDecimal(根据上下文设置进行舍入)</span></span><br><span class="line"><span class="comment"> * 此方法的效果与round(MathContext)方法的效果相同</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mc	要使用的上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	this,必要时进行舍入.零结果具有的标度为0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">plus</span><span class="params">(MathContext mc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mc.precision == <span class="number">0</span>) <span class="comment">// 请不要四舍五入</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">return</span> doRound(<span class="keyword">this</span>, mc);<span class="comment">// 根据mc设置返回一个this的四舍五入的BigDecimal对象</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="正负号函数"><a href="#正负号函数" class="headerlink" title="正负号函数"></a>正负号函数</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回此BigDecimal的正负号函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	当此BigDecimal的值为负、零或正时,返回-1、0 或 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">signum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (intCompact != INFLATED)?</span><br><span class="line">        Long.signum(intCompact):</span><br><span class="line">        intVal.signum();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="BigDecimal标度和非标度"><a href="#BigDecimal标度和非标度" class="headerlink" title="BigDecimal标度和非标度"></a>BigDecimal标度和非标度</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回此BigDecimal的标度.如果为零或正数,则标度是小数点后的位数</span></span><br><span class="line"><span class="comment"> * 如果为负数,则将该数的非标度值乘以10的负scale次幂.例如:-3 标度是指非标度值乘以1000</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	此 BigDecimal 的标度</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">scale</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> scale;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回其值为此BigDecimal的非标度值的BigInteger.(计算(this * 10的this.scale()次幂))</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	此 BigDecimal 的非标度值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigInteger <span class="title">unscaledValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.inflate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="BigDecimal精度"><a href="#BigDecimal精度" class="headerlink" title="BigDecimal精度"></a>BigDecimal精度</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回此BigDecimal的精度.(精度是非标度值的数字个数)</span></span><br><span class="line"><span class="comment"> * 零值的精度是1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	此 BigDecimal 的精度</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">precision</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result = precision;</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="number">0</span>) &#123;<span class="comment">// 精度为0</span></span><br><span class="line">        <span class="keyword">long</span> s = intCompact;</span><br><span class="line">        <span class="keyword">if</span> (s != INFLATED)<span class="comment">// 以数字表示的s的绝对值的长度</span></span><br><span class="line">            result = longDigitLength(s);</span><br><span class="line">        <span class="keyword">else</span><span class="comment">// 返回当前对象的intVal的绝对值的长度</span></span><br><span class="line">            result = bigDigitLength(inflate());</span><br><span class="line">        precision = result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="舍入模式"><a href="#舍入模式" class="headerlink" title="舍入模式"></a>舍入模式</h3><h4 id="舍入模式变量介绍"><a href="#舍入模式变量介绍" class="headerlink" title="舍入模式变量介绍"></a>舍入模式变量介绍</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 舍入远离零的舍入模式.在丢弃非零部分之前始终增加数字.</span></span><br><span class="line"><span class="comment"> * 注意:此舍入模式始终不会减少计算值的大小</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> ROUND_UP =           <span class="number">0</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 接近零的舍入模式.在丢弃某部分之前始终不增加数字(即截短)</span></span><br><span class="line"><span class="comment"> * 注意:此舍入模式始终不会增加计算值的大小</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> ROUND_DOWN =         <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 接近正无穷大的舍入模式.如果BigDecimal为正,则舍入行为与ROUND_UP相同;如果为负,则舍入行为与ROUND_DOWN相同.注意:此舍入模式始终不会减少计算值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> ROUND_CEILING =      <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 接近负无穷大的舍入模式.如果BigDecimal为正,则舍入行为与ROUND_DOWN相同;如果为负,则舍入行为与ROUND_UP相同.注意:此舍入模式始终不会增加计算值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> ROUND_FLOOR =        <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 向"最接近的"数字舍入,如果与两个相邻数字的距离相等,则为向上舍入的舍入模式</span></span><br><span class="line"><span class="comment"> * 如果舍弃部分&gt;=0.5,则舍入行为与ROUND_UP相同;否则舍入行为与ROUND_DOWN相同</span></span><br><span class="line"><span class="comment"> * 注意:这是我们大多数人在小学时就学过的舍入模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> ROUND_HALF_UP =      <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 向"最接近的"数字舍入,如果与两个相邻数字的距离相等,则为上舍入的舍入模式</span></span><br><span class="line"><span class="comment"> * 如果舍弃部分&gt;0.5,则舍入行为与ROUND_UP相同;否则舍入行为与ROUND_DOWN相同</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> ROUND_HALF_DOWN =    <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 向"最接近的"数字舍入,如果与两个相邻数字的距离相等,则向相邻的偶数舍入</span></span><br><span class="line"><span class="comment"> * 如果舍弃部分左边的数字为奇数,则舍入行为与ROUND_HALF_UP相同;</span></span><br><span class="line"><span class="comment"> * 如果为偶数,则舍入行为与ROUND_HALF_DOWN相同</span></span><br><span class="line"><span class="comment"> * 注意:在重复进行一系列计算时,此舍入模式可以将累加错误减到最小 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> ROUND_HALF_EVEN =    <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 断言请求的操作具有精确的结果,因此不需要舍入</span></span><br><span class="line"><span class="comment"> * 如果对获得精确结果的操作指定此舍入模式,则抛出ArithmeticException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> ROUND_UNNECESSARY =  <span class="number">7</span>;</span><br></pre></td></tr></table></figure>
<h4 id="舍入操作"><a href="#舍入操作" class="headerlink" title="舍入操作"></a>舍入操作</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回根据MathContext设置进行舍入后的BigDecimal.如果精度设置为0,则不进行任何舍入操作</span></span><br><span class="line"><span class="comment"> * 此方法的效果与plus(MathContext)方法的效果相同</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mc	要使用的上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	根据 MathContext 设置舍入后的 BigDecimal</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">round</span><span class="params">(MathContext mc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> plus(mc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回BigDecimal,其标度为指定值,其非标度值通过此BigDecimal的非标度值乘以或除以十的适当次幂来确定,以维护其总值</span></span><br><span class="line"><span class="comment"> * 如果该操作减少标度,则非标度值必须被除(而不是乘),并且该值可以更改;在这种情况下,将指定的舍入模式应用到除法中</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> newScale	要返回的 BigDecimal 值的标度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> roundingMode	要应用的舍入模式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	一个 BigDecimal,其标度为指定值,其非标度值可以通过此BigDecimal的非标度值乘以或除以十的适当次幂来确定,以维护其总值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">setScale</span><span class="params">(<span class="keyword">int</span> newScale, RoundingMode roundingMode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> setScale(newScale, roundingMode.oldMode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回一个 BigDecimal,其标度为指定值,其非标度值通过此BigDecimal的非标度值乘以或除以十的适当次幂来确定,以维护其总值</span></span><br><span class="line"><span class="comment"> * 如果该操作减少标度,则非标度值必须被除(而不是乘),并且该值可以更改;在这种情况下,将指定的舍入模式应用到除法中</span></span><br><span class="line"><span class="comment"> * 注意:由于BigDecimal对象是不可变的,此方法的调用不会导致初始对象被修改,这与使用名为setX变异字段X方法的常规约定相反</span></span><br><span class="line"><span class="comment"> * 相反:setScale返回具有适当标度的对象;返回的对象不一定是新分配的</span></span><br><span class="line"><span class="comment"> * 相对于此遗留方法,应优先使用新的setScale(int, RoundingMode) 方法。 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> newScale	要返回的 BigDecimal 值的标度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> roundingMode	要应用的舍入模式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">setScale</span><span class="params">(<span class="keyword">int</span> newScale, <span class="keyword">int</span> roundingMode)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 如果 roundingMode 不表示一个有效的舍入模式</span></span><br><span class="line">    <span class="keyword">if</span> (roundingMode &lt; ROUND_UP || roundingMode &gt; ROUND_UNNECESSARY)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid rounding mode"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> oldScale = <span class="keyword">this</span>.scale;</span><br><span class="line">    <span class="keyword">if</span> (newScale == oldScale)        <span class="comment">// 简单的情况，标度一致</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.signum() == <span class="number">0</span>)            <span class="comment">// 0可以有任何scale</span></span><br><span class="line">    	<span class="comment">// 将 0和 newScale转换为 BigDecimal。</span></span><br><span class="line">        <span class="keyword">return</span> BigDecimal.valueOf(<span class="number">0</span>, newScale);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> rs = <span class="keyword">this</span>.intCompact;</span><br><span class="line">    <span class="keyword">if</span> (newScale &gt; oldScale) &#123;<span class="comment">// 新标度大于旧标度</span></span><br><span class="line">        <span class="keyword">int</span> raise = checkScale((<span class="keyword">long</span>)newScale - oldScale);</span><br><span class="line">        BigInteger rb = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 计算rs * 10 ^ raise;</span></span><br><span class="line">        <span class="keyword">if</span> (rs == INFLATED ||</span><br><span class="line">            (rs = longMultiplyPowerTen(rs, raise)) == INFLATED)</span><br><span class="line">            rb = bigMultiplyPowerTen(raise);<span class="comment">// 计算this * 10 ^ raise</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BigDecimal(rb, rs, newScale,</span><br><span class="line">                              (precision &gt; <span class="number">0</span>) ? precision + raise : <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// newScale &lt; oldScale -- 减少一些数字</span></span><br><span class="line">        <span class="comment">// 由于四舍五入的影响，无法预测精度（precision）。</span></span><br><span class="line">        <span class="keyword">int</span> drop = checkScale((<span class="keyword">long</span>)oldScale - newScale);</span><br><span class="line">        <span class="keyword">if</span> (drop &lt; LONG_TEN_POWERS_TABLE.length)</span><br><span class="line">        	<span class="comment">// 内部用于除法运算。 </span></span><br><span class="line">            <span class="keyword">return</span> divideAndRound(rs, <span class="keyword">this</span>.intVal,</span><br><span class="line">                                  LONG_TEN_POWERS_TABLE[drop], <span class="keyword">null</span>,</span><br><span class="line">                                  newScale, roundingMode, newScale);</span><br><span class="line">        <span class="keyword">else</span> <span class="comment">// 内部用于除法运算。 </span></span><br><span class="line">            <span class="keyword">return</span> divideAndRound(rs, <span class="keyword">this</span>.intVal,</span><br><span class="line">                                  INFLATED, bigTenToThe(drop),</span><br><span class="line">                                  newScale, roundingMode, newScale);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回一个BigDecimal,其标度为指定值,其值在数值上等于此BigDecimal的值</span></span><br><span class="line"><span class="comment"> * 如果这不可能,则抛出ArithmeticException</span></span><br><span class="line"><span class="comment"> * 此调用通常用于增加标度,在这种情况下,可以保证存在指定标度和正确值的BigDecimal</span></span><br><span class="line"><span class="comment"> * 如果调用方知道BigDecimal在其小数部分的结尾有足够多的零(即其整数值中的十的因子),则该调用也可用于减少标度,以允许重新标度,而不更改其值</span></span><br><span class="line"><span class="comment"> * 此方法返回与setScale的两个参数版本相同的结果,但是,为调用方省去了指定舍入模式的麻烦(舍入模式不影响结果)</span></span><br><span class="line"><span class="comment"> * 注意:由于BigDecimal对象是不可变的,因此此方法的调用不会 导致初始对象被修改,这与使用名为setX变异字段X 方法的常规约定相反</span></span><br><span class="line"><span class="comment"> * 相反:setScale返回具有适当标度的对象;返回的对象不一定是新分配的</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> newScale	要返回的BigDecimal值的标度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	一个 BigDecimal,其标度为指定值,其非标度值可以通过此BigDecimal的非标度值乘以或除以十的适当次幂来确定,以维护其总值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">setScale</span><span class="params">(<span class="keyword">int</span> newScale)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> setScale(newScale, ROUND_UNNECESSARY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="小数点移动操作"><a href="#小数点移动操作" class="headerlink" title="小数点移动操作"></a>小数点移动操作</h3><h4 id="左移"><a href="#左移" class="headerlink" title="左移"></a>左移</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回一个BigDecimal,它等效于将该值的小数点向左移动n位.如果n为非负数,则调用仅将n添加到该标度</span></span><br><span class="line"><span class="comment"> * 如果n为负数,则该调用等效于movePointRight(-n)</span></span><br><span class="line"><span class="comment"> * 此调用返回的BigDecimal的值为(this × 10的-n次幂),标度为max(this.scale()+n, 0)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> n	将小数点向左移动的位数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	一个 BigDecimal,它等效于将该值的小数点向左移动n位</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">movePointLeft</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 如果n==Integer.MIN_VALUE，则不能使用movePointRight(-n)</span></span><br><span class="line">    <span class="keyword">int</span> newScale = checkScale((<span class="keyword">long</span>)scale + n);</span><br><span class="line">    BigDecimal num = <span class="keyword">new</span> BigDecimal(intVal, intCompact, newScale, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> num.scale &lt; <span class="number">0</span> ? num.setScale(<span class="number">0</span>, ROUND_UNNECESSARY) : num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="右移"><a href="#右移" class="headerlink" title="右移"></a>右移</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回一个BigDecimal,它等效于将该值的小数点向右移动n位.如果n为非负数,则该调用仅从该标度减去n</span></span><br><span class="line"><span class="comment"> * 如果n为负,则该调用等效于movePointLeft(-n)</span></span><br><span class="line"><span class="comment"> * 此调用返回的BigDecimal的值为(this × 10n),标度为max(this.scale()-n, 0)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> n	将小数点向右移动的位数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	一个 BigDecimal,它等效于将该值的小数点向右移动 n 位</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">movePointRight</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 如果n==Integer.MIN_VALUE,则不能使用movePointLeft(-n)</span></span><br><span class="line">    <span class="keyword">int</span> newScale = checkScale((<span class="keyword">long</span>)scale - n);</span><br><span class="line">    BigDecimal num = <span class="keyword">new</span> BigDecimal(intVal, intCompact, newScale, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> num.scale &lt; <span class="number">0</span> ? num.setScale(<span class="number">0</span>, ROUND_UNNECESSARY) : num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="10次幂操作"><a href="#10次幂操作" class="headerlink" title="10次幂操作"></a>10次幂操作</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回其数值等于(this * 10的n次幂)的BigDecimal.该结果的标度为(this.scale() - n)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> n</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">scaleByPowerOfTen</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BigDecimal(intVal, intCompact,</span><br><span class="line">                          checkScale((<span class="keyword">long</span>)scale - n), precision);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="尾部清零"><a href="#尾部清零" class="headerlink" title="尾部清零"></a>尾部清零</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回数值上等于此小数,但从该表示形式移除所有尾部零的BigDecimal</span></span><br><span class="line"><span class="comment"> * 例如:从BigDecimal值600.0中移除尾部零,该值具有的[BigInteger,scale]组件等于[6000, 1],使用[BigInteger, scale]组件生成的6E2等于[6, -2] </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">stripTrailingZeros</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 如果当前对象的intVal为空,分配适当的BigInteger给intVal字段,</span></span><br><span class="line">    <span class="keyword">this</span>.inflate();</span><br><span class="line">    BigDecimal result = <span class="keyword">new</span> BigDecimal(intVal, scale);</span><br><span class="line">    <span class="comment">// 从当前BigDecimal对象中删除不重要的后置零,直到不能删除更多的零为止</span></span><br><span class="line">    result.stripZerosToMatchScale(Long.MIN_VALUE);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="比较运算"><a href="#比较运算" class="headerlink" title="比较运算"></a>比较运算</h3><h4 id="无符号比较"><a href="#无符号比较" class="headerlink" title="无符号比较"></a>无符号比较</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将此BigDecimal与指定的BigDecimal比较</span></span><br><span class="line"><span class="comment"> * 根据此方法,值相等但具有不同标度的两个BigDecimal对象(如:2.0和2.00)被认为是相等的</span></span><br><span class="line"><span class="comment"> * 相对六个boolean比较运算符(&lt;, ==, &gt;, &gt;=, !=, &lt;=)中每一个运算符的各个方法,优先提供此方法</span></span><br><span class="line"><span class="comment"> * 建议使用以下语句执行上述比较：(x.compareTo(y) &lt;op&gt; 0),其中&lt;op&gt;是六个比较运算符之一</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> val	将此 BigDecimal 与之比较的 BigDecimal。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 当此BigDecimal在数字上小于、等于或大于val时,返回-1、0或1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(BigDecimal val)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 等比例(scale)和无膨胀的情况的快速路径</span></span><br><span class="line">    <span class="keyword">if</span> (scale == val.scale) &#123;</span><br><span class="line">        <span class="keyword">long</span> xs = intCompact;</span><br><span class="line">        <span class="keyword">long</span> ys = val.intCompact;</span><br><span class="line">        <span class="keyword">if</span> (xs != INFLATED &amp;&amp; ys != INFLATED)</span><br><span class="line">            <span class="keyword">return</span> xs != ys ? ((xs &gt; ys) ? <span class="number">1</span> : -<span class="number">1</span>) : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> xsign = <span class="keyword">this</span>.signum();<span class="comment">// 返回正负号</span></span><br><span class="line">    <span class="keyword">int</span> ysign = val.signum();</span><br><span class="line">    <span class="keyword">if</span> (xsign != ysign)</span><br><span class="line">        <span class="keyword">return</span> (xsign &gt; ysign) ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (xsign == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> cmp = compareMagnitude(val);<span class="comment">// 调用内置compareTo()方法</span></span><br><span class="line">    <span class="keyword">return</span> (xsign &gt; <span class="number">0</span>) ? cmp : -cmp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="有符号比较"><a href="#有符号比较" class="headerlink" title="有符号比较"></a>有符号比较</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 忽略符号的compareTo版本</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> val	将此BigDecimal与之比较的BigDecimal</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">compareMagnitude</span><span class="params">(BigDecimal val)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 匹配scales,避免不必要的膨胀</span></span><br><span class="line">    <span class="keyword">long</span> ys = val.intCompact;</span><br><span class="line">    <span class="keyword">long</span> xs = <span class="keyword">this</span>.intCompact;</span><br><span class="line">    <span class="keyword">if</span> (xs == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> (ys == <span class="number">0</span>) ? <span class="number">0</span> : -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (ys == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> sdiff = <span class="keyword">this</span>.scale - val.scale;<span class="comment">// 标度之差</span></span><br><span class="line">    <span class="keyword">if</span> (sdiff != <span class="number">0</span>) &#123;<span class="comment">// 标度不相同处理</span></span><br><span class="line">        <span class="comment">// Avoid matching scales if the (adjusted) exponents differ</span></span><br><span class="line">    	<span class="comment">// 如果(调整后的)指数(exponents )不同,避免匹配标度(scales)</span></span><br><span class="line">        <span class="keyword">int</span> xae = <span class="keyword">this</span>.precision() - <span class="keyword">this</span>.scale;   <span class="comment">// [-1]</span></span><br><span class="line">        <span class="keyword">int</span> yae = val.precision() - val.scale;     <span class="comment">// [-1]</span></span><br><span class="line">        <span class="keyword">if</span> (xae &lt; yae)</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (xae &gt; yae)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        BigInteger rb = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (sdiff &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        	<span class="comment">// 计算xs * 10 ^ -sdiff == INFLATED</span></span><br><span class="line">            <span class="keyword">if</span> ( (xs == INFLATED ||</span><br><span class="line">                  (xs = longMultiplyPowerTen(xs, -sdiff)) == INFLATED) &amp;&amp;</span><br><span class="line">                 ys == INFLATED) &#123;</span><br><span class="line">            	<span class="comment">// 计算this* 10 ^ -sdiff</span></span><br><span class="line">                rb = bigMultiplyPowerTen(-sdiff);</span><br><span class="line">                <span class="keyword">return</span> rb.compareMagnitude(val.intVal);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// sdiff &gt; 0</span></span><br><span class="line">        	<span class="comment">// 计算ys * 10 ^ sdiff == INFLATED</span></span><br><span class="line">            <span class="keyword">if</span> ( (ys == INFLATED ||</span><br><span class="line">                  (ys = longMultiplyPowerTen(ys, sdiff)) == INFLATED) &amp;&amp;</span><br><span class="line">                 xs == INFLATED) &#123;</span><br><span class="line">            	<span class="comment">// 计算this* 10 ^ sdiff</span></span><br><span class="line">                rb = val.bigMultiplyPowerTen(sdiff);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.intVal.compareMagnitude(rb);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (xs != INFLATED)<span class="comment">// 标度相同处理</span></span><br><span class="line">    	<span class="comment">// 判断xs和ys的绝对值的大小</span></span><br><span class="line">        <span class="keyword">return</span> (ys != INFLATED) ? longCompareMagnitude(xs, ys) : -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ys != INFLATED)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">// 将this.intVal的大小数组与指定的val.intVal的大小数组进行比较。</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.intVal.compareMagnitude(val.intVal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="equals"><a href="#equals" class="headerlink" title="equals"></a>equals</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 比较此BigDecimal与指定的Object的相等性</span></span><br><span class="line"><span class="comment"> * 与compareTo不同,仅当两个BigDecimal对象的值和标度都相等时,</span></span><br><span class="line"><span class="comment"> * 此方法才认为它们相等(因此通过此方法进行比较时,2.0不等于2.00)</span></span><br><span class="line"><span class="comment"> * 覆盖类Object中的equals</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> x	将与此 BigDecimal 进行比较的 Object</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	当且仅当指定的Object为BigDecimal,并且其值和标度都等于此BigDecimal的值和标度时,返回 true</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!(x <span class="keyword">instanceof</span> BigDecimal))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    BigDecimal xDec = (BigDecimal) x;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="keyword">this</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (scale != xDec.scale)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">long</span> s = <span class="keyword">this</span>.intCompact;</span><br><span class="line">    <span class="keyword">long</span> xs = xDec.intCompact;</span><br><span class="line">    <span class="keyword">if</span> (s != INFLATED) &#123;</span><br><span class="line">        <span class="keyword">if</span> (xs == INFLATED)<span class="comment">// 返回给定的xDec.intVal的compact值,如果太大,则返回INFLATED</span></span><br><span class="line">            xs = compactValFor(xDec.intVal);</span><br><span class="line">        <span class="keyword">return</span> xs == s;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (xs != INFLATED)<span class="comment">// 返回给定的this.intVal的compact 值,如果太大,则返回INFLATED</span></span><br><span class="line">        <span class="keyword">return</span> xs == compactValFor(<span class="keyword">this</span>.intVal);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.inflate().equals(xDec.inflate());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="最小值min和最大值max"><a href="#最小值min和最大值max" class="headerlink" title="最小值min和最大值max"></a>最小值min和最大值max</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回此BigDecimal和val的最小值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> val	要计算最小值的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	其值为BigDecimal和val中较小值的BigDecimal.根据compareTo方法的定义,如果它们相等,则返回this</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">min</span><span class="params">(BigDecimal val)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (compareTo(val) &lt;= <span class="number">0</span> ? <span class="keyword">this</span> : val);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回此BigDecimal和val的最大值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> val	要计算最大值的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	其值为此BigDecimal和val中较大值的BigDecimal.根据compareTo方法的定义,如果它们相等,则返回this</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">max</span><span class="params">(BigDecimal val)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (compareTo(val) &gt;= <span class="number">0</span> ? <span class="keyword">this</span> : val);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="哈希函数"><a href="#哈希函数" class="headerlink" title="哈希函数"></a>哈希函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回此BigDecimal的哈希码</span></span><br><span class="line"><span class="comment"> * 注意:数值上相等但标度不同的两个BigDecimal对象(如:2.0和2.00)通常没有相同的哈希码</span></span><br><span class="line"><span class="comment"> * 覆盖：类 Object 中的 hashCode</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	此 BigDecimal 的哈希码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (intCompact != INFLATED) &#123;</span><br><span class="line">        <span class="keyword">long</span> val2 = (intCompact &lt; <span class="number">0</span>)? -intCompact : intCompact;</span><br><span class="line">        <span class="keyword">int</span> temp = (<span class="keyword">int</span>)( ((<span class="keyword">int</span>)(val2 &gt;&gt;&gt; <span class="number">32</span>)) * <span class="number">31</span>  +</span><br><span class="line">                          (val2 &amp; LONG_MASK));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">31</span>*((intCompact &lt; <span class="number">0</span>) ?-temp:temp) + scale;</span><br><span class="line">    &#125; <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">31</span>*intVal.hashCode() + scale;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="格式转换器"><a href="#格式转换器" class="headerlink" title="格式转换器"></a>格式转换器</h3><h4 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="toString"></a>toString</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回此BigDecimal的字符串表示形式,如果需要指数,则使用科学记数法</span></span><br><span class="line"><span class="comment"> * 根据以下步骤可创建BigDecimal的标准的规范化字符串形式：</span></span><br><span class="line"><span class="comment"> * 首先,使用不带前导零的字符'0'至'9'(如果其值为零,则使用单个'0'字符)将BigDecimal的非标度值的绝对值转换为以十为基数的字符串</span></span><br><span class="line"><span class="comment"> * 其次,计算调整的指数;这是无效的标度,加上转换的非标度值中的字符数减1;即：-scale+(ulength-1),其中ulength是十进制数字中非标度值的绝对值的长度(其精度);如果该标度大于或等于零,并且调整的指数大于或等于 -6,则在不使用指数记数法的情况下将该数转换为字符形式</span></span><br><span class="line"><span class="comment"> *     在这种情况下,如果标度为零,则不添加小数点,如果标度为正数,则插入小数点,且标度指定了小数点右边的字符个数.</span></span><br><span class="line"><span class="comment"> *     必要时,将字符'0'添加到转换的非标度值的左边.如果插入后小数点前面没有字符,则以传统字符'0'为前缀.</span></span><br><span class="line"><span class="comment"> *     否则(即：如果标度为负数,或者调整的指数小于-6),使用指数记数法将该数转换为字符形式</span></span><br><span class="line"><span class="comment"> *     在这种情况下,如果转换后的BigInteger多于一位数,则小数点插入在第一个数字之后</span></span><br><span class="line"><span class="comment"> * 然后,将字符形式的指数作为转换的非标度值(也许具有插入的小数点)的后缀;这包含字母'E'和直接跟在其后的转换为字符形式的调整指数.后者的基数为十,使用的字符是'0'到'9',没有前导零,并且,如果调整的指数为负数,则总是以符号字符'-'('\u002D')为前缀,否则以'+'('\u002B')为前缀</span></span><br><span class="line"><span class="comment"> * 最后,如果非标度值小于零,则整个字符串以减号'-' ('\u002D')为前缀.如果非标度值为零或正数,则不使用符号字符作为前缀</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 示例：对于左边的每个表示形式[unscaled value,scale],得到的字符串显示在右边</span></span><br><span class="line"><span class="comment"> * 	    [123,0]      "123"</span></span><br><span class="line"><span class="comment"> * 	    [-123,0]     "-123"</span></span><br><span class="line"><span class="comment"> * 	    [123,-1]     "1.23E+3"</span></span><br><span class="line"><span class="comment"> * 	    [123,-3]     "1.23E+5"</span></span><br><span class="line"><span class="comment"> * 	    [123,1]      "12.3"</span></span><br><span class="line"><span class="comment"> * 	    [123,5]      "0.00123"</span></span><br><span class="line"><span class="comment"> * 	    [123,10]     "1.23E-8"</span></span><br><span class="line"><span class="comment"> * 	    [-123,12]    "-1.23E-10"</span></span><br><span class="line"><span class="comment"> * 注： </span></span><br><span class="line"><span class="comment"> *  1、可区分的BigDecimal值和此转换的结果之间存在一对一的映射关系</span></span><br><span class="line"><span class="comment"> *  即：每个可区分的BigDecimal值(非标度值和标度)都有唯一的字符串表示形式,作为使用toString的结果</span></span><br><span class="line"><span class="comment"> *  如果使用BigDecimal(String)构造方法将该字符串表示形式转换为BigDecimal,则将恢复初始值</span></span><br><span class="line"><span class="comment"> *  2、给定的数产生的字符串总是相同的;它不受语言环境的影响</span></span><br><span class="line"><span class="comment"> *  这意味着它可以用作交换十进制数据的规范化字符串表示形式,或用作Hashtable的关键字等等</span></span><br><span class="line"><span class="comment"> *  NumberFormat类及其子类可以处理区分语言环境的数的格式化和分析 </span></span><br><span class="line"><span class="comment"> *  3、toEngineeringString()方法可用于在工程计数法中表示带有指数的数</span></span><br><span class="line"><span class="comment"> *  setScale方法可用于对BigDecimal进行舍入,使其小数点后的位数为已知位数</span></span><br><span class="line"><span class="comment"> *  4、使用Character.forDigit提供的数字到字符的映射关系</span></span><br><span class="line"><span class="comment"> *  覆盖：类Object中的toString</span></span><br><span class="line"><span class="comment"> *  <span class="doctag">@return</span>	此BigDecimal的字符串表示形式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String sc = stringCache;</span><br><span class="line">    <span class="keyword">if</span> (sc == <span class="keyword">null</span>)<span class="comment">// 科学记数法</span></span><br><span class="line">        stringCache = sc = layoutChars(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> sc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回此BigDecimal的字符串表示形式,需要指数时,则使用工程计数法 </span></span><br><span class="line"><span class="comment"> * 返回如toString()方法中所描述的表 BigDecimal的字符串,不包括使用指数记数法的情况</span></span><br><span class="line"><span class="comment"> * 将十的幂调整为三的倍数(工程记数法),这样,非零值的整数部分的范围是1到999</span></span><br><span class="line"><span class="comment"> * 如果对零值使用指数记数法,则使用小数点和小数的一(或二)个零数字,以便保留零值的标度</span></span><br><span class="line"><span class="comment"> * 注意：与 toString()的输出不同,如果使用string constructor将输出字符串转换为BigDecimal,</span></span><br><span class="line"><span class="comment"> * 则此方法的输出不保证恢复此BigDecimal的相同[integer, scale]对.</span></span><br><span class="line"><span class="comment"> * 此方法满足以下较弱约束,即产生的结果在数值上始终等于将字符串构造方法应用到方法的输出得到的结果 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	此 BigDecimal 的字符串表示形式,如果需要指数,则使用工程记数法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toEngineeringString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> layoutChars(<span class="keyword">false</span>);<span class="comment">// 工程计数法</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回不带指数字段的此BigDecimal的字符串表示形式</span></span><br><span class="line"><span class="comment"> * 对于具有正标度的值,小数点右边的数字个数用于指示标度</span></span><br><span class="line"><span class="comment"> * 对于具有零或负标度的值,生成得到的字符串,好像将该值转换为在数值上等于具有零标度的值一样,并且好像零标度值的所有尾部零都出现在该结果中</span></span><br><span class="line"><span class="comment"> *  如果非标度值小于零,则整个字符串以减号'-'('\u002D')为前缀</span></span><br><span class="line"><span class="comment"> *  如果非标度值为零或正数,则没有任何符号字符作为前缀</span></span><br><span class="line"><span class="comment"> *  注意：如果将此方法的结果传递到string constructor,则只需要恢复此BigDecimal的数值</span></span><br><span class="line"><span class="comment"> *  新的BigDecimal的表示形式可以有不同的标度.</span></span><br><span class="line"><span class="comment"> *  尤其是如果此BigDecimal具有负标度,则在由字符串构造方法进行处理时,此方法产生的字符串将具有零标度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toPlainString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    BigDecimal bd = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">if</span> (bd.scale &lt; <span class="number">0</span>)<span class="comment">// 标度小于0</span></span><br><span class="line">        bd = bd.setScale(<span class="number">0</span>);</span><br><span class="line">    bd.inflate();<span class="comment">// 如果bd的intVal为空，分配适当的BigInteger给intVal字段，</span></span><br><span class="line">    <span class="keyword">if</span> (bd.scale == <span class="number">0</span>)      <span class="comment">// 没有小数点</span></span><br><span class="line">        <span class="keyword">return</span> bd.intVal.toString();</span><br><span class="line">    <span class="keyword">return</span> bd.getValueString(bd.signum(), bd.intVal.abs().toString(), bd.scale);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 字符串拼接——私有工具类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> signum	当前BigDecimal的符号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> intString	当前BigDecimal的intVal的绝对值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> scale	当前BigDecimal的标度(小数点)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getValueString</span><span class="params">(<span class="keyword">int</span> signum, String intString, <span class="keyword">int</span> scale)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* 插入小数点 */</span></span><br><span class="line">    StringBuilder buf;</span><br><span class="line">    <span class="keyword">int</span> insertionPoint = intString.length() - scale;</span><br><span class="line">    <span class="keyword">if</span> (insertionPoint == <span class="number">0</span>) &#123;  <span class="comment">/* 小数点在intVal之前,例如0.1*/</span></span><br><span class="line">        <span class="keyword">return</span> (signum&lt;<span class="number">0</span> ? <span class="string">"-0."</span> : <span class="string">"0."</span>) + intString;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (insertionPoint &gt; <span class="number">0</span>) &#123; <span class="comment">/* 小数点在intVal内部,例如111.1111*/</span></span><br><span class="line">        buf = <span class="keyword">new</span> StringBuilder(intString);</span><br><span class="line">        buf.insert(insertionPoint, <span class="string">'.'</span>);</span><br><span class="line">        <span class="keyword">if</span> (signum &lt; <span class="number">0</span>)</span><br><span class="line">            buf.insert(<span class="number">0</span>, <span class="string">'-'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">/* 我们必须在小数点和intVal之间插入0,例如：0.00123*/</span></span><br><span class="line">        buf = <span class="keyword">new</span> StringBuilder(<span class="number">3</span>-insertionPoint + intString.length());</span><br><span class="line">        buf.append(signum&lt;<span class="number">0</span> ? <span class="string">"-0."</span> : <span class="string">"0."</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;-insertionPoint; i++)</span><br><span class="line">            buf.append(<span class="string">'0'</span>);</span><br><span class="line">        buf.append(intString);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> buf.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="转换为BigInteger"><a href="#转换为BigInteger" class="headerlink" title="转换为BigInteger"></a>转换为BigInteger</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将此BigDecimal转换为BigInteger</span></span><br><span class="line"><span class="comment"> * 此转换类似于Java Language Specification中定义的从double到long 的基本收缩转换：</span></span><br><span class="line"><span class="comment"> * 将丢弃此BigDecimal的小数部分</span></span><br><span class="line"><span class="comment"> * 注意：此转换会丢失关于BigDecimal值的精度信息</span></span><br><span class="line"><span class="comment"> * 要在转换不准确时(即当丢弃非零小数部分时)抛出异常,请使用toBigIntegerExact()方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	转换为 BigInteger 的此 BigDecimal</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigInteger <span class="title">toBigInteger</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 强制一个整数,平稳</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.setScale(<span class="number">0</span>, ROUND_DOWN).inflate();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将此BigDecimal转换为BigInteger,以检查丢失的信息.如果此BigDecimal具有非零小数部分,则抛出一个异常</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	转换为 BigInteger 的此 BigDecimal。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigInteger <span class="title">toBigIntegerExact</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 四舍五入为整数,小数部分不为0的情况除外</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.setScale(<span class="number">0</span>, ROUND_UNNECESSARY).inflate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="自动拆箱"><a href="#自动拆箱" class="headerlink" title="自动拆箱"></a>自动拆箱</h3><h4 id="拆成long"><a href="#拆成long" class="headerlink" title="拆成long"></a>拆成long</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将此BigDecimal转换为long</span></span><br><span class="line"><span class="comment"> * 此转换类似于Java Language Specification中定义的从double到 short 的基本收缩转换：</span></span><br><span class="line"><span class="comment"> * 将丢弃此BigDecimal的小数部分,并且如果生成的"BigInteger"太大而不适合用long表示,则仅返回64位低位字节</span></span><br><span class="line"><span class="comment"> * 注意：此转换会丢失关于此BigDecimal值的总大小和精度的信息,并返回带有相反符号的结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	转换为 long 的此 BigDecimal</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">longValue</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (intCompact != INFLATED &amp;&amp; scale == <span class="number">0</span>) ?</span><br><span class="line">        intCompact:</span><br><span class="line">        toBigInteger().longValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将此BigDecimal转换为long,以检查丢失的信息.如果此BigDecimal具有非零小数部分,或者超出long结果的可能范围,则抛出ArithmeticException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	转换为 long 的此 BigDecimal。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">longValueExact</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (intCompact != INFLATED &amp;&amp; scale == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> intCompact;</span><br><span class="line">    <span class="comment">// 如果整数部分大于19位，则不可能匹配</span></span><br><span class="line">    <span class="keyword">if</span> ((precision() - scale) &gt; <span class="number">19</span>) <span class="comment">// [对于负标度也是一样]</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> java.lang.ArithmeticException(<span class="string">"Overflow"</span>);<span class="comment">// 如果 this 具有非零小数部分，或者不适合用 long 表示。</span></span><br><span class="line">    <span class="comment">// Fastpath 0和&lt; 1.0数字(如果非常小，则后者的四舍五入速度非常慢)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.signum() == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">this</span>.precision() - <span class="keyword">this</span>.scale) &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArithmeticException(<span class="string">"Rounding necessary"</span>);</span><br><span class="line">    <span class="comment">// 四舍五入为整数，小数部分不为0的情况除外</span></span><br><span class="line">    BigDecimal num = <span class="keyword">this</span>.setScale(<span class="number">0</span>, ROUND_UNNECESSARY);</span><br><span class="line">    <span class="keyword">if</span> (num.precision() &gt;= <span class="number">19</span>) <span class="comment">// 需要仔细检查</span></span><br><span class="line">        LongOverflow.check(num);</span><br><span class="line">    <span class="keyword">return</span> num.inflate().longValue();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Long值越界问题检查</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LongOverflow</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** BigInteger = Long.MIN_VALUE。 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BigInteger LONGMIN = BigInteger.valueOf(Long.MIN_VALUE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** BigInteger = Long.MAX_VALUE。 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BigInteger LONGMAX = BigInteger.valueOf(Long.MAX_VALUE);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检查num.intVal的数值范围</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> num</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">check</span><span class="params">(BigDecimal num)</span> </span>&#123;</span><br><span class="line">    	<span class="comment">// 如果num的intVal为空，分配适当的BigInteger给intVal字段，</span></span><br><span class="line">        num.inflate();</span><br><span class="line">        <span class="keyword">if</span> ((num.intVal.compareTo(LONGMIN) &lt; <span class="number">0</span>) ||</span><br><span class="line">            (num.intVal.compareTo(LONGMAX) &gt; <span class="number">0</span>))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> java.lang.ArithmeticException(<span class="string">"Overflow"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="拆成int"><a href="#拆成int" class="headerlink" title="拆成int"></a>拆成int</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将此BigDecimal转换为int</span></span><br><span class="line"><span class="comment"> * 此转换类似于Java Language Specification中定义的从double到short的基本收缩转换：</span></span><br><span class="line"><span class="comment"> * 将丢弃此BigDecimal的所有小数部分,并且如果生成的"BigInteger"太大而不适合用int表示,则仅返回32位低位字节</span></span><br><span class="line"><span class="comment"> * 注意：此转换会丢失关于此BigDecimal值的总大小和精度的信息,并返回带有相反符号的结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	转换为 int 的此 BigDecimal</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">intValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span>  (intCompact != INFLATED &amp;&amp; scale == <span class="number">0</span>) ?</span><br><span class="line">        (<span class="keyword">int</span>)intCompact :</span><br><span class="line">        toBigInteger().intValue();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将此BigDecimal转换为int,以检查丢失的信息</span></span><br><span class="line"><span class="comment"> * 如果此BigDecimal具有非零小数部分,或者超出int结果的可能范围,则抛出ArithmeticException。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	转换为 int 的此 BigDecimal</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">intValueExact</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">long</span> num;</span><br><span class="line">   num = <span class="keyword">this</span>.longValueExact();     <span class="comment">// 将检查小数部分</span></span><br><span class="line">   <span class="keyword">if</span> ((<span class="keyword">int</span>)num != num)</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> java.lang.ArithmeticException(<span class="string">"Overflow"</span>);</span><br><span class="line">   <span class="keyword">return</span> (<span class="keyword">int</span>)num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="拆成short"><a href="#拆成short" class="headerlink" title="拆成short"></a>拆成short</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将此BigDecimal转换为short,以检查丢失的信息</span></span><br><span class="line"><span class="comment"> * 如果此BigDecimal具有非零小数部分,或者超出short结果的可能范围,则抛出ArithmeticException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	转换为 short 的此 BigDecimal。 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">short</span> <span class="title">shortValueExact</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">long</span> num;</span><br><span class="line">   num = <span class="keyword">this</span>.longValueExact();     <span class="comment">// 将检查小数部分</span></span><br><span class="line">   <span class="keyword">if</span> ((<span class="keyword">short</span>)num != num)</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> java.lang.ArithmeticException(<span class="string">"Overflow"</span>);</span><br><span class="line">   <span class="keyword">return</span> (<span class="keyword">short</span>)num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="拆成byte"><a href="#拆成byte" class="headerlink" title="拆成byte"></a>拆成byte</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将此BigDecimal转换为byte,以检查丢失的信息</span></span><br><span class="line"><span class="comment"> * 如果此BigDecimal具有非零小数部分,或者超出byte结果的可能范围,则抛出ArithmeticException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	转换为 byte 的此 BigDecimal。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">byte</span> <span class="title">byteValueExact</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">long</span> num;</span><br><span class="line">   num = <span class="keyword">this</span>.longValueExact();     <span class="comment">// 将检查小数部分</span></span><br><span class="line">   <span class="keyword">if</span> ((<span class="keyword">byte</span>)num != num)</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> java.lang.ArithmeticException(<span class="string">"Overflow"</span>);</span><br><span class="line">   <span class="keyword">return</span> (<span class="keyword">byte</span>)num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="拆成float"><a href="#拆成float" class="headerlink" title="拆成float"></a>拆成float</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将此BigDecimal转换为 float</span></span><br><span class="line"><span class="comment"> * 此转换类似于Java Language Specification中定义的从double到float的基本收缩转换：</span></span><br><span class="line"><span class="comment"> * 如此BigDecimal的值太大而不能表示为float，</span></span><br><span class="line"><span class="comment"> * 则将其适当地转换为Float.NEGATIVE_INFINITY或Float.POSITIVE_INFINITY</span></span><br><span class="line"><span class="comment"> * 注意：即使在返回值为有限值的情况下,此转换也可能丢失关于BigDecimal值精度的信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">floatValue</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(intCompact != INFLATED) &#123;</span><br><span class="line">        <span class="keyword">if</span> (scale == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">float</span>)intCompact;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * 如果intCompact和scale都可以精确地表示为float值,则执行单个float乘法或除法以计算(正确取整)结果</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (Math.abs(intCompact) &lt; <span class="number">1L</span>&lt;&lt;<span class="number">22</span> ) &#123;</span><br><span class="line">                <span class="comment">// 由于对INFLATED进行了外部检查,因此对Math.abs(MIN_VALUE)的保护不太好</span></span><br><span class="line">                <span class="keyword">if</span> (scale &gt; <span class="number">0</span> &amp;&amp; scale &lt; float10pow.length) &#123;</span><br><span class="line">                    <span class="keyword">return</span> (<span class="keyword">float</span>)intCompact / float10pow[scale];</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (scale &lt; <span class="number">0</span> &amp;&amp; scale &gt; -float10pow.length) &#123;</span><br><span class="line">                    <span class="keyword">return</span> (<span class="keyword">float</span>)intCompact * float10pow[-scale];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 效率低下,但可以保证工作</span></span><br><span class="line">    <span class="keyword">return</span> Float.parseFloat(<span class="keyword">this</span>.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="拆成double"><a href="#拆成double" class="headerlink" title="拆成double"></a>拆成double</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将此BigDecimal转换为 double</span></span><br><span class="line"><span class="comment"> * 此转换类似于Java Language Specification中定义的从double到float的基本收缩转换：</span></span><br><span class="line"><span class="comment"> * 如果此BigDecimal的数量太大而不能表示为double,则将其适当地转换为 Double.NEGATIVE_INFINITY或Double.POSITIVE_INFINITY。</span></span><br><span class="line"><span class="comment"> * 注意：即使在返回值为有限值的情况下,此转换也可能丢失关于BigDecimal值精度的信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	类 Number 中的 doubleValue</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">doubleValue</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(intCompact != INFLATED) &#123;</span><br><span class="line">        <span class="keyword">if</span> (scale == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">double</span>)intCompact;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * 如果intCompact和小数位数都可以精确地表示为double值,请执行一次double乘法或除法以计算(正确取整)结果</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (Math.abs(intCompact) &lt; <span class="number">1L</span>&lt;&lt;<span class="number">52</span> ) &#123;</span><br><span class="line">                <span class="comment">// 由于对INFLATED进行了外部检查,因此对Math.abs(MIN_VALUE)的保护不太好</span></span><br><span class="line">                <span class="keyword">if</span> (scale &gt; <span class="number">0</span> &amp;&amp; scale &lt; double10pow.length) &#123;</span><br><span class="line">                    <span class="keyword">return</span> (<span class="keyword">double</span>)intCompact / double10pow[scale];</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (scale &lt; <span class="number">0</span> &amp;&amp; scale &gt; -double10pow.length) &#123;</span><br><span class="line">                    <span class="keyword">return</span> (<span class="keyword">double</span>)intCompact * double10pow[-scale];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 效率低下，但可以保证工作</span></span><br><span class="line">    <span class="keyword">return</span> Double.parseDouble(<span class="keyword">this</span>.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="最后单位大小"><a href="#最后单位大小" class="headerlink" title="最后单位大小"></a>最后单位大小</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回此BigDecimal的ulp(最后一位的单位)的大小</span></span><br><span class="line"><span class="comment"> * 非零BigDecimal值的ulp是此值与下一个具有相同位数的较大BigDecimal值之间的正距离</span></span><br><span class="line"><span class="comment"> * 零值的ulp在数值上等于具有this标度的1</span></span><br><span class="line"><span class="comment"> * 使用与this相同的标度存储该结果,这样,零和非零值的结果等于[1, this.scale()]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	this 的 ulp 的大小</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">ulp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> BigDecimal.valueOf(<span class="number">1</span>, <span class="keyword">this</span>.scale());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="拆成char"><a href="#拆成char" class="headerlink" title="拆成char[]"></a>拆成char[]</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将这个BigDecimal转化为char[]数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> sci true：用于科学计数法;false：用于工程计数法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	具有以下BigDecimal的规范字符串表示形式的字符串</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">layoutChars</span><span class="params">(<span class="keyword">boolean</span> sci)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (scale == <span class="number">0</span>) <span class="comment">// 零刻度无关紧要</span></span><br><span class="line">        <span class="keyword">return</span> (intCompact != INFLATED) ?</span><br><span class="line">            Long.toString(intCompact):</span><br><span class="line">            intVal.toString();</span><br><span class="line">    <span class="comment">// 获取此线程局部变量的当前线程副本中的值。</span></span><br><span class="line">    StringBuilderHelper sbHelper = threadLocalStringBuilderHelper.get();</span><br><span class="line">    <span class="keyword">char</span>[] coeff;</span><br><span class="line">    <span class="keyword">int</span> offset;  <span class="comment">// offset是coeff数组的起始索引</span></span><br><span class="line">    <span class="comment">// 求绝对值的意义</span></span><br><span class="line">    <span class="keyword">if</span> (intCompact != INFLATED) &#123;</span><br><span class="line">        <span class="comment">// 将intCompact的绝对值的字符放置到sbHelper.cmpCharArray中,并将偏移量返回到表示开始的数组中</span></span><br><span class="line">        offset = sbHelper.putIntCompact(Math.abs(intCompact));</span><br><span class="line">        coeff  = sbHelper.getCompactCharArray();<span class="comment">// 获取 sbHelper.cmpCharArray[]</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        offset = <span class="number">0</span>;</span><br><span class="line">        coeff  = intVal.abs().toString().toCharArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 构造一个缓冲区,为所有情况提供足够的容量.如果需要E表示法,长度为:如果是负,则+ 1；</span></span><br><span class="line"><span class="comment">     * 如果需要点,则+1,表示"E+",则+2,+10为调整指数(exponent)</span></span><br><span class="line"><span class="comment">     * 如果是负的,可以是+1,加上前导"0.00000"</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    StringBuilder buf = sbHelper.getStringBuilder();</span><br><span class="line">    <span class="keyword">if</span> (signum() &lt; <span class="number">0</span>)             <span class="comment">// 前缀"-"",如果是负数</span></span><br><span class="line">        buf.append(<span class="string">'-'</span>);</span><br><span class="line">    <span class="keyword">int</span> coeffLen = coeff.length - offset;</span><br><span class="line">    <span class="keyword">long</span> adjusted = -(<span class="keyword">long</span>)scale + (coeffLen -<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> ((scale &gt;= <span class="number">0</span>) &amp;&amp; (adjusted &gt;= -<span class="number">6</span>)) &#123; <span class="comment">// 普通的数字</span></span><br><span class="line">        <span class="keyword">int</span> pad = scale - coeffLen;         <span class="comment">// 填充0的计数</span></span><br><span class="line">        <span class="keyword">if</span> (pad &gt;= <span class="number">0</span>) &#123;                     <span class="comment">// 0.xxx form</span></span><br><span class="line">            buf.append(<span class="string">'0'</span>);</span><br><span class="line">            buf.append(<span class="string">'.'</span>);</span><br><span class="line">            <span class="keyword">for</span> (; pad&gt;<span class="number">0</span>; pad--) &#123;</span><br><span class="line">                buf.append(<span class="string">'0'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            buf.append(coeff, offset, coeffLen);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;                         <span class="comment">// xx.xx form</span></span><br><span class="line">            buf.append(coeff, offset, -pad);</span><br><span class="line">            buf.append(<span class="string">'.'</span>);</span><br><span class="line">            buf.append(coeff, -pad + offset, scale);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 需要E符号</span></span><br><span class="line">        <span class="keyword">if</span> (sci) &#123;                       <span class="comment">// 科学计数法</span></span><br><span class="line">            buf.append(coeff[offset]);   <span class="comment">// 首位字符</span></span><br><span class="line">            <span class="keyword">if</span> (coeffLen &gt; <span class="number">1</span>) &#123;          <span class="comment">// 更多信息</span></span><br><span class="line">                buf.append(<span class="string">'.'</span>);</span><br><span class="line">                buf.append(coeff, offset + <span class="number">1</span>, coeffLen - <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;                         <span class="comment">// 工程计数法</span></span><br><span class="line">            <span class="keyword">int</span> sig = (<span class="keyword">int</span>)(adjusted % <span class="number">3</span>);</span><br><span class="line">            <span class="keyword">if</span> (sig &lt; <span class="number">0</span>)</span><br><span class="line">                sig += <span class="number">3</span>;                <span class="comment">// [调整为负数]</span></span><br><span class="line">            adjusted -= sig;             <span class="comment">// 现在是3的倍数</span></span><br><span class="line">            sig++;</span><br><span class="line">            <span class="keyword">if</span> (signum() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">switch</span> (sig) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    buf.append(<span class="string">'0'</span>); <span class="comment">// 指数（exponent）是3的倍数</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                    buf.append(<span class="string">"0.00"</span>);</span><br><span class="line">                    adjusted += <span class="number">3</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                    buf.append(<span class="string">"0.0"</span>);</span><br><span class="line">                    adjusted += <span class="number">3</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Unexpected sig value "</span> + sig);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sig &gt;= coeffLen) &#123;   <span class="comment">// 都是整数</span></span><br><span class="line">                buf.append(coeff, offset, coeffLen);</span><br><span class="line">                <span class="comment">// 可能还需要一些零</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = sig - coeffLen; i &gt; <span class="number">0</span>; i--)</span><br><span class="line">                    buf.append(<span class="string">'0'</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;                     <span class="comment">// xx.xxE form</span></span><br><span class="line">                buf.append(coeff, offset, sig);</span><br><span class="line">                buf.append(<span class="string">'.'</span>);</span><br><span class="line">                buf.append(coeff, offset + sig, coeffLen - sig);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (adjusted != <span class="number">0</span>) &#123;             <span class="comment">// [sci不可以是0]</span></span><br><span class="line">            buf.append(<span class="string">'E'</span>);</span><br><span class="line">            <span class="keyword">if</span> (adjusted &gt; <span class="number">0</span>)            <span class="comment">// 正的力符号</span></span><br><span class="line">                buf.append(<span class="string">'+'</span>);</span><br><span class="line">            buf.append(adjusted);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> buf.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="bigInteger"><a href="#bigInteger" class="headerlink" title="bigInteger"></a>bigInteger</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 以BigInteger的形式返回10的n次方。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> n	返回的10的幂(&gt;=0)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	一个值为(10的n次方)的BigInteger值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BigInteger <span class="title">bigTenToThe</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> BigInteger.ZERO;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n &lt; BIG_TEN_POWERS_TABLE_MAX) &#123;</span><br><span class="line">        BigInteger[] pows = BIG_TEN_POWERS_TABLE;</span><br><span class="line">        <span class="keyword">if</span> (n &lt; pows.length)</span><br><span class="line">            <span class="keyword">return</span> pows[n];</span><br><span class="line">        <span class="keyword">else</span><span class="comment">// 扩展BIG_TEN_POWERS_TABLE数组</span></span><br><span class="line">            <span class="keyword">return</span> expandBigIntegerTenPowers(n);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// BigInteger.pow很慢，所以通过从一个字符串构造一个BigInteger来生成10的n次幂(仍然不是很快)</span></span><br><span class="line">    <span class="keyword">char</span> tenpow[] = <span class="keyword">new</span> <span class="keyword">char</span>[n + <span class="number">1</span>];</span><br><span class="line">    tenpow[<span class="number">0</span>] = <span class="string">'1'</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line">        tenpow[i] = <span class="string">'0'</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BigInteger(tenpow);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 扩展BIG_TEN_POWERS_TABLE数组,至少包含10的n次方</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> n	返回的10次方(&gt; = 0)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	一个值为(10的n次幂)的BigDecimal,同时将BIG_TEN_POWERS_TABLE数组扩展到大于n的大小</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BigInteger <span class="title">expandBigIntegerTenPowers</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(BigDecimal<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">        BigInteger[] pows = BIG_TEN_POWERS_TABLE;</span><br><span class="line">        <span class="keyword">int</span> curLen = pows.length;</span><br><span class="line">        <span class="comment">// 下面的比较和上面的同步语句是为了防止多个线程展开同一个数组</span></span><br><span class="line">        <span class="keyword">if</span> (curLen &lt;= n) &#123;</span><br><span class="line">            <span class="keyword">int</span> newLen = curLen &lt;&lt; <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span> (newLen &lt;= n)</span><br><span class="line">                newLen &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">            pows = Arrays.copyOf(pows, newLen);<span class="comment">// 复制数组</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = curLen; i &lt; newLen; i++)</span><br><span class="line">            	<span class="comment">// 获取pows[i - 1] * BigInteger.TEN</span></span><br><span class="line">                pows[i] = pows[i - <span class="number">1</span>].multiply(BigInteger.TEN);</span><br><span class="line">            <span class="comment">// 基于以下事实:</span></span><br><span class="line">            <span class="comment">// 1. pows是一个私有的局部变量;</span></span><br><span class="line">            <span class="comment">// 2. 下面的存储是一个不稳定的存储。</span></span><br><span class="line">            <span class="comment">// 新创建的数组元素可以安全地发布。</span></span><br><span class="line">            BIG_TEN_POWERS_TABLE = pows;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pows[n];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="10次幂运算和标度匹配"><a href="#10次幂运算和标度匹配" class="headerlink" title="10次幂运算和标度匹配"></a>10次幂运算和标度匹配</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span>[] LONG_TEN_POWERS_TABLE = &#123;</span><br><span class="line">    <span class="number">1</span>,                     <span class="comment">// 0 / 10^0</span></span><br><span class="line">    <span class="number">10</span>,                    <span class="comment">// 1 / 10^1</span></span><br><span class="line">    <span class="number">100</span>,                   <span class="comment">// 2 / 10^2</span></span><br><span class="line">    <span class="number">1000</span>,                  <span class="comment">// 3 / 10^3</span></span><br><span class="line">    <span class="number">10000</span>,                 <span class="comment">// 4 / 10^4</span></span><br><span class="line">    <span class="number">100000</span>,                <span class="comment">// 5 / 10^5</span></span><br><span class="line">    <span class="number">1000000</span>,               <span class="comment">// 6 / 10^6</span></span><br><span class="line">    <span class="number">10000000</span>,              <span class="comment">// 7 / 10^7</span></span><br><span class="line">    <span class="number">100000000</span>,             <span class="comment">// 8 / 10^8</span></span><br><span class="line">    <span class="number">1000000000</span>,            <span class="comment">// 9 / 10^9</span></span><br><span class="line">    <span class="number">10000000000L</span>,          <span class="comment">// 10 / 10^10</span></span><br><span class="line">    <span class="number">100000000000L</span>,         <span class="comment">// 11 / 10^11</span></span><br><span class="line">    <span class="number">1000000000000L</span>,        <span class="comment">// 12 / 10^12</span></span><br><span class="line">    <span class="number">10000000000000L</span>,       <span class="comment">// 13 / 10^13</span></span><br><span class="line">    <span class="number">100000000000000L</span>,      <span class="comment">// 14 / 10^14</span></span><br><span class="line">    <span class="number">1000000000000000L</span>,     <span class="comment">// 15 / 10^15</span></span><br><span class="line">    <span class="number">10000000000000000L</span>,    <span class="comment">// 16 / 10^16</span></span><br><span class="line">    <span class="number">100000000000000000L</span>,   <span class="comment">// 17 / 10^17</span></span><br><span class="line">    <span class="number">1000000000000000000L</span>   <span class="comment">// 18 / 10^18</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> BigInteger BIG_TEN_POWERS_TABLE[] = &#123;   </span><br><span class="line">    BigInteger.ONE,</span><br><span class="line">    BigInteger.valueOf(<span class="number">10</span>),       </span><br><span class="line">    BigInteger.valueOf(<span class="number">100</span>),</span><br><span class="line">    BigInteger.valueOf(<span class="number">1000</span>),     </span><br><span class="line">    BigInteger.valueOf(<span class="number">10000</span>),</span><br><span class="line">    BigInteger.valueOf(<span class="number">100000</span>),   </span><br><span class="line">    BigInteger.valueOf(<span class="number">1000000</span>),</span><br><span class="line">    BigInteger.valueOf(<span class="number">10000000</span>), </span><br><span class="line">    BigInteger.valueOf(<span class="number">100000000</span>),</span><br><span class="line">    BigInteger.valueOf(<span class="number">1000000000</span>),</span><br><span class="line">    BigInteger.valueOf(<span class="number">10000000000L</span>),</span><br><span class="line">    BigInteger.valueOf(<span class="number">100000000000L</span>),</span><br><span class="line">    BigInteger.valueOf(<span class="number">1000000000000L</span>),</span><br><span class="line">    BigInteger.valueOf(<span class="number">10000000000000L</span>),</span><br><span class="line">    BigInteger.valueOf(<span class="number">100000000000000L</span>),</span><br><span class="line">    BigInteger.valueOf(<span class="number">1000000000000000L</span>),</span><br><span class="line">    BigInteger.valueOf(<span class="number">10000000000000000L</span>),</span><br><span class="line">    BigInteger.valueOf(<span class="number">100000000000000000L</span>),</span><br><span class="line">    BigInteger.valueOf(<span class="number">1000000000000000000L</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BIG_TEN_POWERS_TABLE_INITLEN =</span><br><span class="line">    BIG_TEN_POWERS_TABLE.length;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BIG_TEN_POWERS_TABLE_MAX =</span><br><span class="line">    <span class="number">16</span> * BIG_TEN_POWERS_TABLE_INITLEN;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> THRESHOLDS_TABLE[] = &#123;</span><br><span class="line">    Long.MAX_VALUE,                     <span class="comment">// 0</span></span><br><span class="line">    Long.MAX_VALUE/<span class="number">10L</span>,                 <span class="comment">// 1</span></span><br><span class="line">    Long.MAX_VALUE/<span class="number">100L</span>,                <span class="comment">// 2</span></span><br><span class="line">    Long.MAX_VALUE/<span class="number">1000L</span>,               <span class="comment">// 3</span></span><br><span class="line">    Long.MAX_VALUE/<span class="number">10000L</span>,              <span class="comment">// 4</span></span><br><span class="line">    Long.MAX_VALUE/<span class="number">100000L</span>,             <span class="comment">// 5</span></span><br><span class="line">    Long.MAX_VALUE/<span class="number">1000000L</span>,            <span class="comment">// 6</span></span><br><span class="line">    Long.MAX_VALUE/<span class="number">10000000L</span>,           <span class="comment">// 7</span></span><br><span class="line">    Long.MAX_VALUE/<span class="number">100000000L</span>,          <span class="comment">// 8</span></span><br><span class="line">    Long.MAX_VALUE/<span class="number">1000000000L</span>,         <span class="comment">// 9</span></span><br><span class="line">    Long.MAX_VALUE/<span class="number">10000000000L</span>,        <span class="comment">// 10</span></span><br><span class="line">    Long.MAX_VALUE/<span class="number">100000000000L</span>,       <span class="comment">// 11</span></span><br><span class="line">    Long.MAX_VALUE/<span class="number">1000000000000L</span>,      <span class="comment">// 12</span></span><br><span class="line">    Long.MAX_VALUE/<span class="number">10000000000000L</span>,     <span class="comment">// 13</span></span><br><span class="line">    Long.MAX_VALUE/<span class="number">100000000000000L</span>,    <span class="comment">// 14</span></span><br><span class="line">    Long.MAX_VALUE/<span class="number">1000000000000000L</span>,   <span class="comment">// 15</span></span><br><span class="line">    Long.MAX_VALUE/<span class="number">10000000000000000L</span>,  <span class="comment">// 16</span></span><br><span class="line">    Long.MAX_VALUE/<span class="number">100000000000000000L</span>, <span class="comment">// 17</span></span><br><span class="line">    Long.MAX_VALUE/<span class="number">1000000000000000000L</span> <span class="comment">// 18</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算val * 10 ^ n;</span></span><br><span class="line"><span class="comment"> * 如果可以表示为long,则返回该产品,否则INFLATED</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> val</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> n</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">longMultiplyPowerTen</span><span class="params">(<span class="keyword">long</span> val, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (val == <span class="number">0</span> || n &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> val;</span><br><span class="line">    <span class="keyword">long</span>[] tab = LONG_TEN_POWERS_TABLE;</span><br><span class="line">    <span class="keyword">long</span>[] bounds = THRESHOLDS_TABLE;</span><br><span class="line">    <span class="keyword">if</span> (n &lt; tab.length &amp;&amp; n &lt; bounds.length) &#123;</span><br><span class="line">        <span class="keyword">long</span> tenpower = tab[n];</span><br><span class="line">        <span class="keyword">if</span> (val == <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span> tenpower;</span><br><span class="line">        <span class="keyword">if</span> (Math.abs(val) &lt;= bounds[n])</span><br><span class="line">            <span class="keyword">return</span> val * tenpower;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> INFLATED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算this* 10 ^ n。</span></span><br><span class="line"><span class="comment"> * 主要需要让特殊的套管捕获零值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> n</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> BigInteger <span class="title">bigMultiplyPowerTen</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (n &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.inflate();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (intCompact != INFLATED)</span><br><span class="line">        <span class="keyword">return</span> bigTenToThe(n).multiply(intCompact);<span class="comment">// 10的n次幂*intCompact</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> intVal.multiply(bigTenToThe(n));<span class="comment">// intVal*10的n次幂</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 如果intVal为空,则为intVal字段分配适当的BigInteger,即使用紧凑表示</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> BigInteger <span class="title">inflate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (intVal == <span class="keyword">null</span>)</span><br><span class="line">        intVal = BigInteger.valueOf(intCompact);</span><br><span class="line">    <span class="keyword">return</span> intVal;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 匹配两个BigDecimal的比例(scales)以对齐它们的最小有效数字</span></span><br><span class="line"><span class="comment"> * 如果val[0]和val[1]的标度(scales)不同,则重新标度(无损地)较低的BigDecimal,使它们匹配</span></span><br><span class="line"><span class="comment"> * 也就是说：较低比例(lower-scaled)的引用将被具有与其他BigDecimal相同比例(scale)的新对象的引用所替代</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> val</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">matchScale</span><span class="params">(BigDecimal[] val)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (val[<span class="number">0</span>].scale == val[<span class="number">1</span>].scale) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (val[<span class="number">0</span>].scale &lt; val[<span class="number">1</span>].scale) &#123;</span><br><span class="line">        val[<span class="number">0</span>] = val[<span class="number">0</span>].setScale(val[<span class="number">1</span>].scale, ROUND_UNNECESSARY);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (val[<span class="number">1</span>].scale &lt; val[<span class="number">0</span>].scale) &#123;</span><br><span class="line">        val[<span class="number">1</span>] = val[<span class="number">1</span>].setScale(val[<span class="number">0</span>].scale, ROUND_UNNECESSARY);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="序列化和反序列化"><a href="#序列化和反序列化" class="headerlink" title="序列化和反序列化"></a>序列化和反序列化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从流中重新构造BigDecimal实例(即反序列化它)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> s	正在读取的流。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> java.io.IOException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> ClassNotFoundException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">// 读取所有字段</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line">        <span class="comment">// 验证可能错误的字段</span></span><br><span class="line">    <span class="keyword">if</span> (intVal == <span class="keyword">null</span>) &#123;</span><br><span class="line">        String message = <span class="string">"BigDecimal: null intVal in stream"</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> java.io.StreamCorruptedException(message);</span><br><span class="line">        <span class="comment">// [现在允许所有的标度（scale）]</span></span><br><span class="line">    &#125;<span class="comment">// 获取intVal（BigInteger）的compact值。</span></span><br><span class="line">    intCompact = compactValFor(intVal);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将此BigDecimal序列化到相关流</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> s	要序列化的流。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> java.io.IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(java.io.ObjectOutputStream s)</span></span></span><br><span class="line"><span class="function">   <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">   <span class="comment">// 必须膨胀(inflate)以保持兼容的串行形式。</span></span><br><span class="line">   <span class="keyword">this</span>.inflate();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 写入适当字段</span></span><br><span class="line">   s.defaultWriteObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="获取长度"><a href="#获取长度" class="headerlink" title="获取长度"></a>获取长度</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回以十进制数字表示的long绝对值的长度。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> x	long值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	未缩放值(unscaled value)的长度，以十进制数表示。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">longDigitLength</span><span class="params">(<span class="keyword">long</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 整数log 10 (x)在(1233/4096)*(1 +整数log 2 (x))的1以内。</span></span><br><span class="line"><span class="comment">     * 分数1233/4096近似于log10(2)</span></span><br><span class="line"><span class="comment">     * 因此,我们首先执行log2的一个版本(Long类的一个变体,具有预先检查和相反的方向),然后根据powers表进行伸缩(scale)和检查 </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">assert</span> x != INFLATED;</span><br><span class="line">    <span class="keyword">if</span> (x &lt; <span class="number">0</span>)</span><br><span class="line">        x = -x;</span><br><span class="line">    <span class="keyword">if</span> (x &lt; <span class="number">10</span>)  <span class="comment">// 必须筛选0，还是筛选10</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="number">64</span>; <span class="comment">// 不是63，以避免以后需要添加1</span></span><br><span class="line">    <span class="keyword">int</span> y = (<span class="keyword">int</span>)(x &gt;&gt;&gt; <span class="number">32</span>);</span><br><span class="line">    <span class="keyword">if</span> (y == <span class="number">0</span>) &#123; n -= <span class="number">32</span>; y = (<span class="keyword">int</span>)x; &#125;</span><br><span class="line">    <span class="keyword">if</span> (y &gt;&gt;&gt; <span class="number">16</span> == <span class="number">0</span>) &#123; n -= <span class="number">16</span>; y &lt;&lt;= <span class="number">16</span>; &#125;</span><br><span class="line">    <span class="keyword">if</span> (y &gt;&gt;&gt; <span class="number">24</span> == <span class="number">0</span>) &#123; n -=  <span class="number">8</span>; y &lt;&lt;=  <span class="number">8</span>; &#125;</span><br><span class="line">    <span class="keyword">if</span> (y &gt;&gt;&gt; <span class="number">28</span> == <span class="number">0</span>) &#123; n -=  <span class="number">4</span>; y &lt;&lt;=  <span class="number">4</span>; &#125;</span><br><span class="line">    <span class="keyword">if</span> (y &gt;&gt;&gt; <span class="number">30</span> == <span class="number">0</span>) &#123; n -=  <span class="number">2</span>; y &lt;&lt;=  <span class="number">2</span>; &#125;</span><br><span class="line">    <span class="keyword">int</span> r = (((y &gt;&gt;&gt; <span class="number">31</span>) + n) * <span class="number">1233</span>) &gt;&gt;&gt; <span class="number">12</span>;</span><br><span class="line">    <span class="keyword">long</span>[] tab = LONG_TEN_POWERS_TABLE;</span><br><span class="line">    <span class="comment">// 如果r &gt;=长度，必须有最长可能的数字</span></span><br><span class="line">    <span class="keyword">return</span> (r &gt;= tab.length || x &lt; tab[r])? r : r+<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回一个BigInteger的绝对值的长度，以十进制数字表示。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> b	BigInteger值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	未缩放值（unscaled value）的长度，以十进制数字表示</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">bigDigitLength</span><span class="params">(BigInteger b)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 和Long版本的思路一样,但是我们需要一个更好的log10(2)的近似值。</span></span><br><span class="line"><span class="comment">     * 使用646456993/2 ^ 31最大可能bitLength报道是准确的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (b.signum == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> r = (<span class="keyword">int</span>)((((<span class="keyword">long</span>)b.bitLength() + <span class="number">1</span>) * <span class="number">646456993</span>) &gt;&gt;&gt; <span class="number">31</span>);</span><br><span class="line">    <span class="comment">// 满足约束(10的r次方) &lt; 0</span></span><br><span class="line">    <span class="keyword">return</span> b.compareMagnitude(bigTenToThe(r)) &lt; <span class="number">0</span>? r : r+<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="后置零删除"><a href="#后置零删除" class="headerlink" title="后置零删除"></a>后置零删除</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从这个BigDecimal中删除不重要的后置零,直到达到首选比例(scale)或不能删除更多的零为止</span></span><br><span class="line"><span class="comment"> * 如果首选比例(preferred scale)小于Integer.MIN_VALUE,所有后面的0都将被删除</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 警告:此方法应该只在新对象上调用，因为它会改变值字段。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> preferredScale</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	这个BigDecimal的比例(scale)可能会缩小到接近首选的比例(scale)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> BigDecimal <span class="title">stripZerosToMatchScale</span><span class="params">(<span class="keyword">long</span> preferredScale)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.inflate();</span><br><span class="line">    BigInteger qr[];                <span class="comment">// 商-余对</span></span><br><span class="line">    <span class="comment">// 满足约束(10的BigInteger.TEN次方) &gt;= 0 &amp;&amp; scale &gt; preferredScale</span></span><br><span class="line">    <span class="keyword">while</span> ( intVal.compareMagnitude(BigInteger.TEN) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">            scale &gt; preferredScale) &#123;</span><br><span class="line">        <span class="keyword">if</span> (intVal.testBit(<span class="number">0</span>))<span class="comment">// 计算 ((intVal &amp; (1&lt;&lt;0)) != 0)</span></span><br><span class="line">            <span class="keyword">break</span>;                  <span class="comment">// 奇数不能以0结尾</span></span><br><span class="line">        qr = intVal.divideAndRemainder(BigInteger.TEN);</span><br><span class="line">        <span class="keyword">if</span> (qr[<span class="number">1</span>].signum() != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;                 <span class="comment">// 非0的剩余部分</span></span><br><span class="line">        intVal=qr[<span class="number">0</span>];</span><br><span class="line">        scale = checkScale((<span class="keyword">long</span>)scale-<span class="number">1</span>);  <span class="comment">// 可能会溢出</span></span><br><span class="line">        <span class="keyword">if</span> (precision &gt; <span class="number">0</span>)          <span class="comment">// 已知调整精度（precision）</span></span><br><span class="line">          precision--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (intVal != <span class="keyword">null</span>)</span><br><span class="line">        intCompact = compactValFor(intVal);<span class="comment">// 获取intVal的compact值。</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 与checkScale相同,其中value！= 0</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">checkScaleNonZero</span><span class="params">(<span class="keyword">long</span> val)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> asInt = (<span class="keyword">int</span>)val;</span><br><span class="line">    <span class="keyword">if</span> (asInt != val) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArithmeticException(asInt&gt;<span class="number">0</span> ? <span class="string">"Underflow"</span>:<span class="string">"Overflow"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> asInt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检查下溢或下溢的标度(scale)</span></span><br><span class="line"><span class="comment"> * 如果这个BigDecimal是非零的,则在标度(scale)超出范围时抛出异常</span></span><br><span class="line"><span class="comment"> * 如果这是零,就把标度(scale)缩小到右边的极值(the extreme value),如果这个标度(scale)超出范围的话</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> val	新标度（scale）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	验证标度为int。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">checkScale</span><span class="params">(<span class="keyword">long</span> val)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> asInt = (<span class="keyword">int</span>)val;</span><br><span class="line">    <span class="keyword">if</span> (asInt != val) &#123;</span><br><span class="line">        asInt = val&gt;Integer.MAX_VALUE ? Integer.MAX_VALUE : Integer.MIN_VALUE;</span><br><span class="line">        BigInteger b;</span><br><span class="line">        <span class="keyword">if</span> (intCompact != <span class="number">0</span> &amp;&amp;</span><br><span class="line">            ((b = intVal) == <span class="keyword">null</span> || b.signum() != <span class="number">0</span>))<span class="comment">// 新的标度（scale）超出范围，则出现ArithmeticException(溢出或下溢)</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArithmeticException(asInt&gt;<span class="number">0</span> ? <span class="string">"Underflow"</span>:<span class="string">"Overflow"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> asInt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="比较操作-private"><a href="#比较操作-private" class="headerlink" title="比较操作(private)"></a>比较操作(private)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回给定&#123;<span class="doctag">@code</span> BigInteger&#125;的压缩值,如果太大,则返回INFLATED.依赖于BigInteger</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">compactValFor</span><span class="params">(BigInteger b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] m = b.mag;</span><br><span class="line">    <span class="keyword">int</span> len = m.length;</span><br><span class="line">    <span class="keyword">if</span> (len == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> d = m[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span> (len &gt; <span class="number">2</span> || (len == <span class="number">2</span> &amp;&amp; d &lt; <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">return</span> INFLATED;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> u = (len == <span class="number">2</span>)?</span><br><span class="line">        (((<span class="keyword">long</span>) m[<span class="number">1</span>] &amp; LONG_MASK) + (((<span class="keyword">long</span>)d) &lt;&lt; <span class="number">32</span>)) :</span><br><span class="line">        (((<span class="keyword">long</span>)d)   &amp; LONG_MASK);</span><br><span class="line">    <span class="keyword">return</span> (b.signum &lt; <span class="number">0</span>)? -u : u;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *	判断x和y的绝对值的大小</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> x</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> y</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	-1:x&lt;y；0：x=y；x&gt;y:1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">longCompareMagnitude</span><span class="params">(<span class="keyword">long</span> x, <span class="keyword">long</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x &lt; <span class="number">0</span>)</span><br><span class="line">        x = -x;</span><br><span class="line">    <span class="keyword">if</span> (y &lt; <span class="number">0</span>)</span><br><span class="line">        y = -y;</span><br><span class="line">    <span class="keyword">return</span> (x &lt; y) ? -<span class="number">1</span> : ((x == y) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断s强转为int的范围</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> s</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">saturateLong</span><span class="params">(<span class="keyword">long</span> s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = (<span class="keyword">int</span>)s;</span><br><span class="line">    <span class="keyword">return</span> (s == i) ? i : (s &lt; <span class="number">0</span> ? Integer.MIN_VALUE : Integer.MAX_VALUE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="内部打印"><a href="#内部打印" class="headerlink" title="内部打印"></a>内部打印</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 内部打印程序</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(String name, BigDecimal bd)</span> </span>&#123;</span><br><span class="line">    System.err.format(<span class="string">"%s:\tintCompact %d\tintVal %d\tscale %d\tprecision %d%n"</span>, name, bd.intCompact, bd.intVal, bd.scale, bd.precision);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检查此BigDecimal的内部不变量.这些不变量包括：</span></span><br><span class="line"><span class="comment"> *    该对象必须被初始化;intCompact不能为INFLATED或intVal为非null.这两个条件都可能成立</span></span><br><span class="line"><span class="comment"> *    如果同时设置了intCompact和intVal,则它们的值必须一致.</span></span><br><span class="line"><span class="comment"> *    如果精度非零,则必须具有正确的值.</span></span><br><span class="line"><span class="comment"> * 说明: 由于这是一种审核方法,因此我们不应该更改此BigDecimal对象的状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> BigDecimal <span class="title">audit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (intCompact == INFLATED) &#123;</span><br><span class="line">        <span class="keyword">if</span> (intVal == <span class="keyword">null</span>) &#123;</span><br><span class="line">            print(<span class="string">"audit"</span>, <span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"null intVal"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 检查精度</span></span><br><span class="line">        <span class="keyword">if</span> (precision &gt; <span class="number">0</span> &amp;&amp; precision != bigDigitLength(intVal)) &#123;</span><br><span class="line">            print(<span class="string">"audit"</span>, <span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"precision mismatch"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (intVal != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">long</span> val = intVal.longValue();</span><br><span class="line">            <span class="keyword">if</span> (val != intCompact) &#123;</span><br><span class="line">                print(<span class="string">"audit"</span>, <span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Inconsistent state, intCompact="</span> + intCompact + <span class="string">"\t intVal="</span> + val);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 检查精度</span></span><br><span class="line">        <span class="keyword">if</span> (precision &gt; <span class="number">0</span> &amp;&amp; precision != longDigitLength(intCompact)) &#123;</span><br><span class="line">            print(<span class="string">"audit"</span>, <span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"precision mismatch"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="舍入操作-private"><a href="#舍入操作-private" class="headerlink" title="舍入操作(private)"></a>舍入操作(private)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 圆的一个操作数;仅当数字&gt;0时使用.不改变this;如果需要舍入,则创建并返回一个新的BigDecimal</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mc	要使用的上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> BigDecimal <span class="title">roundOp</span><span class="params">(MathContext mc)</span> </span>&#123;</span><br><span class="line">    BigDecimal rounded = doRound(<span class="keyword">this</span>, mc);<span class="comment">// 根据mc设置返回一个this的四舍五入的BigDecimal对象</span></span><br><span class="line">    <span class="keyword">return</span> rounded;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据MathContext设置将这个BigDecimal四舍五入;仅在精度(precision ) &gt; 0时使用</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">roundThis</span><span class="params">(MathContext mc)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 根据mc设置返回一个this的四舍五入的BigDecimal对象</span></span><br><span class="line">    BigDecimal rounded = doRound(<span class="keyword">this</span>, mc);</span><br><span class="line">    <span class="keyword">if</span> (rounded == <span class="keyword">this</span>)                 <span class="comment">//不是圆的</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">this</span>.intVal     = rounded.intVal;</span><br><span class="line">    <span class="keyword">this</span>.intCompact = rounded.intCompact;</span><br><span class="line">    <span class="keyword">this</span>.scale      = rounded.scale;</span><br><span class="line">    <span class="keyword">this</span>.precision  = rounded.precision;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回一个BigDecimal,根据MathContext设置四舍五入;</span></span><br><span class="line"><span class="comment"> * 仅当mc.precision &gt; 0时使用。不改变this;</span></span><br><span class="line"><span class="comment"> * 如果需要舍入,则创建并返回一个新的BigDecimal</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> d	</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mc	要使用的上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>	根据MathContext设置四舍五入的BigDecimal.可以返回这个,如果不需要四舍五入</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BigDecimal <span class="title">doRound</span><span class="params">(BigDecimal val, MathContext mc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> mcp = mc.precision;</span><br><span class="line">    <span class="keyword">boolean</span> wasDivided = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (mcp &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        BigInteger intVal = val.intVal;</span><br><span class="line">        <span class="keyword">long</span> compactVal = val.intCompact;</span><br><span class="line">        <span class="keyword">int</span> scale = val.scale;</span><br><span class="line">        <span class="keyword">int</span> prec = val.precision();</span><br><span class="line">        <span class="keyword">int</span> mode = mc.roundingMode.oldMode;</span><br><span class="line">        <span class="keyword">int</span> drop;</span><br><span class="line">        <span class="keyword">if</span> (compactVal == INFLATED) &#123;</span><br><span class="line">            drop = prec - mcp;</span><br><span class="line">            <span class="keyword">while</span> (drop &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                scale = checkScaleNonZero((<span class="keyword">long</span>) scale - drop);</span><br><span class="line">                intVal = divideAndRoundByTenPow(intVal, drop, mode);</span><br><span class="line">                wasDivided = <span class="keyword">true</span>;</span><br><span class="line">                compactVal = compactValFor(intVal);</span><br><span class="line">                <span class="keyword">if</span> (compactVal != INFLATED) &#123;</span><br><span class="line">                    prec = longDigitLength(compactVal);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                prec = bigDigitLength(intVal);</span><br><span class="line">                drop = prec - mcp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (compactVal != INFLATED) &#123;</span><br><span class="line">            drop = prec - mcp;  <span class="comment">// 跌落不能超过18</span></span><br><span class="line">            <span class="keyword">while</span> (drop &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                scale = checkScaleNonZero((<span class="keyword">long</span>) scale - drop);</span><br><span class="line">                compactVal = divideAndRound(compactVal, LONG_TEN_POWERS_TABLE[drop], mc.roundingMode.oldMode);</span><br><span class="line">                wasDivided = <span class="keyword">true</span>;</span><br><span class="line">                prec = longDigitLength(compactVal);</span><br><span class="line">                drop = prec - mcp;</span><br><span class="line">                intVal = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> wasDivided ? <span class="keyword">new</span> BigDecimal(intVal,compactVal,scale,prec) : val;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BigDecimal <span class="title">doRound</span><span class="params">(<span class="keyword">long</span> compactVal, <span class="keyword">int</span> scale, MathContext mc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> mcp = mc.precision;</span><br><span class="line">    <span class="keyword">if</span> (mcp &gt; <span class="number">0</span> &amp;&amp; mcp &lt; <span class="number">19</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> prec = longDigitLength(compactVal);</span><br><span class="line">        <span class="keyword">int</span> drop = prec - mcp;  <span class="comment">// 跌落不能超过18</span></span><br><span class="line">        <span class="keyword">while</span> (drop &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            scale = checkScaleNonZero((<span class="keyword">long</span>) scale - drop);</span><br><span class="line">            compactVal = divideAndRound(compactVal, LONG_TEN_POWERS_TABLE[drop], mc.roundingMode.oldMode);</span><br><span class="line">            prec = longDigitLength(compactVal);</span><br><span class="line">            drop = prec - mcp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> valueOf(compactVal, scale, prec);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> valueOf(compactVal, scale);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将&#123;<span class="doctag">@code</span> BigInteger&#125;值除以十的幂</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BigInteger <span class="title">divideAndRoundByTenPow</span><span class="params">(BigInteger intVal, <span class="keyword">int</span> tenPow, <span class="keyword">int</span> roundingMode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tenPow &lt; LONG_TEN_POWERS_TABLE.length)</span><br><span class="line">        intVal = divideAndRound(intVal, LONG_TEN_POWERS_TABLE[tenPow], roundingMode);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        intVal = divideAndRound(intVal, bigTenToThe(tenPow), roundingMode);</span><br><span class="line">    <span class="keyword">return</span> intVal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">Eric Liang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://ericql.github.io/2019/11/12/01-Java%E5%9F%BA%E7%A1%80%E7%AF%87/02-JDK%E6%BA%90%E7%A0%81%E7%AF%87/BigDecimal%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">https://ericql.github.io/2019/11/12/01-Java%E5%9F%BA%E7%A1%80%E7%AF%87/02-JDK%E6%BA%90%E7%A0%81%E7%AF%87/BigDecimal%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://ericql.github.io">Eric Liang</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/JDK%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">JDK源码解析    </a><a class="post-meta__tags" href="/tags/BigDecimal/">BigDecimal    </a></div><div class="post_share"><div class="social-share" data-image="https://source.unsplash.com/300x300/?program" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/11/25/hexo%E5%91%BD%E4%BB%A4/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>博客相关命令</span></div></a></div><div class="next-post pull_right"><a href="/2019/11/12/01-Java%E5%9F%BA%E7%A1%80%E7%AF%87/01-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E7%82%B9/Java%E4%B8%AD%E7%9A%84equals()%E5%92%8Chashcode()%E4%B9%8B%E9%97%B4%E5%85%B3%E7%B3%BB/"><img class="next_cover lazyload" data-src="https://source.unsplash.com/300x300/?equals" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>Java中的equals()和hashcode()之间关系</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2019/11/12/01-Java基础篇/02-JDK源码篇/Enum源码解析/" title="Enum源码解析"><img class="relatedPosts_cover lazyload"data-src="https://source.unsplash.com/300x300/?library"><div class="relatedPosts_title">Enum源码解析</div></a></div><div class="relatedPosts_item"><a href="/2019/11/12/01-Java基础篇/02-JDK源码篇/ThreadLocal源码解析/" title="ThreadLocal源码解析"><img class="relatedPosts_cover lazyload"data-src="https://source.unsplash.com/300x300/?beauty"><div class="relatedPosts_title">ThreadLocal源码解析</div></a></div><div class="relatedPosts_item"><a href="/2019/11/12/01-Java基础篇/02-JDK源码篇/Integer源码解析/" title="Integer源码解析"><img class="relatedPosts_cover lazyload"data-src="https://source.unsplash.com/300x300/?document"><div class="relatedPosts_title">Integer源码解析</div></a></div><div class="relatedPosts_item"><a href="/2019/11/12/01-Java基础篇/02-JDK源码篇/ClassLoader源码解析/" title="ClassLoader源码解析"><img class="relatedPosts_cover lazyload"data-src="https://source.unsplash.com/300x300/?book"><div class="relatedPosts_title">ClassLoader源码解析</div></a></div><div class="relatedPosts_item"><a href="/2019/11/12/01-Java基础篇/02-JDK源码篇/Long源码解析/" title="Long源码解析"><img class="relatedPosts_cover lazyload"data-src="https://source.unsplash.com/300x300/?github"><div class="relatedPosts_title">Long源码解析</div></a></div><div class="relatedPosts_item"><a href="/2019/11/12/01-Java基础篇/02-JDK源码篇/String源码解析/" title="String源码解析"><img class="relatedPosts_cover lazyload"data-src="https://source.unsplash.com/300x300/?cartoon"><div class="relatedPosts_title">String源码解析</div></a></div></div><div class="clear_both"></div></div></div></div><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2020 By Eric Liang</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="footer_custom_text"><a href="https://ericql.github.io">欢饮来到Eric的博客</a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>