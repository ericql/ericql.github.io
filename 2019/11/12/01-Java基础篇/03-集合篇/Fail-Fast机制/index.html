<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>fail-fast机制 | Eric Liang</title><meta name="description" content="fail-fast机制"><meta name="keywords" content="集合"><meta name="author" content="Eric Liang"><meta name="copyright" content="Eric Liang"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="fail-fast机制"><meta name="twitter:description" content="fail-fast机制"><meta name="twitter:image" content="https://source.unsplash.com/300x300/?library"><meta property="og:type" content="article"><meta property="og:title" content="fail-fast机制"><meta property="og:url" content="https://ericql.github.io/2019/11/12/01-Java%E5%9F%BA%E7%A1%80%E7%AF%87/03-%E9%9B%86%E5%90%88%E7%AF%87/Fail-Fast%E6%9C%BA%E5%88%B6/"><meta property="og:site_name" content="Eric Liang"><meta property="og:description" content="fail-fast机制"><meta property="og:image" content="https://source.unsplash.com/300x300/?library"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://ericql.github.io/2019/11/12/01-Java%E5%9F%BA%E7%A1%80%E7%AF%87/03-%E9%9B%86%E5%90%88%E7%AF%87/Fail-Fast%E6%9C%BA%E5%88%B6/"><link rel="prev" title="集合工具类" href="https://ericql.github.io/2019/11/12/01-Java%E5%9F%BA%E7%A1%80%E7%AF%87/03-%E9%9B%86%E5%90%88%E7%AF%87/%E9%9B%86%E5%90%88%E5%B7%A5%E5%85%B7%E7%B1%BB/"><link rel="next" title="ThreadLocal源码解析" href="https://ericql.github.io/2019/11/12/01-Java%E5%9F%BA%E7%A1%80%E7%AF%87/02-JDK%E6%BA%90%E7%A0%81%E7%AF%87/ThreadLocal%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'false',
  highlight_lang: 'true',
  highlight_shrink: 'false',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  copyright: undefined,
  copy_copyright_js: false,
  ClickShowText: undefined,
  medium_zoom: 'false',
  Snackbar: undefined
  
}</script></head><body><div id="header"> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Eric Liang</a></span><i class="fa fa-bars fa-fw toggle-menu pull_right close" aria-hidden="true"></i><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 档案</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></span><span class="pull_right" id="search_button"></span></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="lazyload avatar_img" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/Photo/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'"></div><div class="mobile_post_data"><div class="mobile_data_item is_center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">29</div></a></div></div><div class="mobile_data_item is_center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">17</div></a></div></div><div class="mobile_data_item is_center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">7</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 档案</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#fail-fast机制"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">fail-fast机制</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#一、定义"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">一、定义</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#二、fail-fast示例"><span class="toc_mobile_items-number">1.2.</span> <span class="toc_mobile_items-text">二、fail-fast示例</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#三、原因"><span class="toc_mobile_items-number">1.3.</span> <span class="toc_mobile_items-text">三、原因</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#四、fail-fast解决办法"><span class="toc_mobile_items-number">1.4.</span> <span class="toc_mobile_items-text">四、fail-fast解决办法</span></a></li></ol></li></ol></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#fail-fast机制"><span class="toc-number">1.</span> <span class="toc-text">fail-fast机制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、定义"><span class="toc-number">1.1.</span> <span class="toc-text">一、定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、fail-fast示例"><span class="toc-number">1.2.</span> <span class="toc-text">二、fail-fast示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、原因"><span class="toc-number">1.3.</span> <span class="toc-text">三、原因</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、fail-fast解决办法"><span class="toc-number">1.4.</span> <span class="toc-text">四、fail-fast解决办法</span></a></li></ol></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://uploadbeta.com/api/pictures/random)"><div id="post-info"><div id="post-title"><div class="posttitle">fail-fast机制</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2019-11-12<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-02-01</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/01-Java%E5%9F%BA%E7%A1%80%E7%AF%87/">01-Java基础篇</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/01-Java%E5%9F%BA%E7%A1%80%E7%AF%87/03-%E9%9B%86%E5%90%88%E8%A7%A3%E6%9E%90/">03-集合解析</a></span><div class="post-meta-wordcount"><i class="fa fa-eye post-meta__icon" aria-hidden="true">       </i><span>阅读量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="fail-fast机制"><a href="#fail-fast机制" class="headerlink" title="fail-fast机制"></a>fail-fast机制</h1><p>在JDK的Collection中我们时常会看到类似于这样的话:<br>例如:ArrayList:<br>&emsp;&emsp;注意,迭代器的快速失败行为无法得到保证,因为一般来说不可能对是否出现不同步并发修改做出任何硬性保证.快速失败迭代器会尽最大努力抛出ConcurrentModificationException.因此为提高这类迭代器的正确性而编写一个依赖于此异常的程序是错误的做法;迭代器的快速失败行为应该仅用于检测bug<br>HashMap中:<br>&emsp;&emsp;注意,迭代器的快速失败行为不能得到保证,一般来说,存在非同步的并发修改时,不可能作出任何坚决的保证.快速失败迭代器尽最大努力抛出 ConcurrentModificationException.因此,编写依赖于此异常的程序的做法是错误的,正确做法是:迭代器的快速失败行为应该仅用于检测程序错误</p>
<h2 id="一、定义"><a href="#一、定义" class="headerlink" title="一、定义"></a>一、定义</h2><p>&emsp;&emsp;”快速失败”也就是fail-fast,它是java集合中的一种错误检测机制.当多个线程对集合进行结构上的改变操作时,有可能会产生fail-fast机制,<font color='red'>记住是有可能,而不是一定</font><br>&emsp;&emsp;例如:假设存在两个线程(线程1、线程2),线程1通过Iterator在遍历集合A中的元素,在某个时候线程2修改了集合A的结构(是结构上的修改而不是简单的修改集合元素的内容),那么这个时候就会抛出ConcurrentModificationException异常,从而产生fail-fast机制</p>
<h2 id="二、fail-fast示例"><a href="#二、fail-fast示例" class="headerlink" title="二、fail-fast示例"></a>二、fail-fast示例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FailFastTest</span> </span>&#123;    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();    </span><br><span class="line">        </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@desc</span>:线程one迭代list  </span></span><br><span class="line"><span class="comment">     */</span>    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">threadOne</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;    </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;    </span><br><span class="line">            Iterator&lt;Integer&gt; iterator = list.iterator();    </span><br><span class="line">            <span class="keyword">while</span>(iterator.hasNext())&#123;    </span><br><span class="line">                <span class="keyword">int</span> i = iterator.next();    </span><br><span class="line">                System.out.println(<span class="string">"ThreadOne 遍历:"</span> + i);    </span><br><span class="line">                <span class="keyword">try</span> &#123;    </span><br><span class="line">                    Thread.sleep(<span class="number">10</span>);    </span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;    </span><br><span class="line">                    e.printStackTrace();    </span><br><span class="line">                &#125;    </span><br><span class="line">            &#125;    </span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;    </span><br><span class="line">        </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@desc</span>:当i == 3时，修改list  </span></span><br><span class="line"><span class="comment">     */</span>    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">threadTwo</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;    </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;    </span><br><span class="line">            <span class="keyword">int</span> i = <span class="number">0</span> ;     </span><br><span class="line">            <span class="keyword">while</span>(i &lt; <span class="number">6</span>)&#123;    </span><br><span class="line">                System.out.println(<span class="string">"ThreadTwo run："</span> + i);    </span><br><span class="line">                <span class="keyword">if</span>(i == <span class="number">3</span>)&#123;    </span><br><span class="line">                    list.remove(i);    </span><br><span class="line">                &#125;    </span><br><span class="line">                i++;    </span><br><span class="line">            &#125;    </span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;    </span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;    </span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span>;i++)&#123;    </span><br><span class="line">            list.add(i);    </span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="keyword">new</span> threadOne().start();    </span><br><span class="line">        <span class="keyword">new</span> threadTwo().start();    </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="三、原因"><a href="#三、原因" class="headerlink" title="三、原因"></a>三、原因</h2><p>&emsp;&emsp;通过上面的示例和讲解,初步知道fail-fast产生的原因就在于程序在对collection进行迭代时,某个线程对该collection在结构上对其做了修改,这时迭代器会抛出ConcurrentModificationException异常信息,从而产生fail-fast<br>&emsp;&emsp;要了解fail-fast机制,我们首先要对ConcurrentModificationException 异常有所了解.当方法检测到对象的并发修改,但不允许这种修改时就抛出该异常.同时需要注意的是,该异常不会始终指出对象已经由不同线程并发修改,如果单线程违反了规则,同样也有可能会抛出改异常<br>&emsp;&emsp;诚然,迭代器的快速失败行为无法得到保证,它不能保证一定会出现该错误,但是快速失败操作会尽最大努力抛出ConcurrentModificationException异常,所以为提高此类操作的正确性而编写一个依赖于此异常的程序是错误的做法,正确做法是:ConcurrentModificationException 应该仅用于检测 bug.下面我将以ArrayList为例进一步分析fail-fast产生的原因<br>&emsp;&emsp;从前面我们知道fail-fast是在操作迭代器时产生的.现在我们来看看ArrayList中迭代器的源代码:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Itr</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">E</span>&gt; </span>&#123;    </span><br><span class="line">   <span class="keyword">int</span> cursor;    </span><br><span class="line">   <span class="keyword">int</span> lastRet = -<span class="number">1</span>;    </span><br><span class="line">   <span class="keyword">int</span> expectedModCount = ArrayList.<span class="keyword">this</span>.modCount;    </span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;    </span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">this</span>.cursor != ArrayList.<span class="keyword">this</span>.size);    </span><br><span class="line">    &#125;    </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> E <span class="title">next</span><span class="params">()</span> </span>&#123;    </span><br><span class="line">        checkForComodification();    </span><br><span class="line">        <span class="comment">/** 省略此处代码 */</span>    </span><br><span class="line">    &#125;    </span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;    </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.lastRet &lt; <span class="number">0</span>)    </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();    </span><br><span class="line">        checkForComodification();    </span><br><span class="line">        <span class="comment">/** 省略此处代码 */</span>    </span><br><span class="line">    &#125;    </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">checkForComodification</span><span class="params">()</span> </span>&#123;    </span><br><span class="line">        <span class="keyword">if</span> (ArrayList.<span class="keyword">this</span>.modCount == <span class="keyword">this</span>.expectedModCount)    </span><br><span class="line">            <span class="keyword">return</span>;    </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();    </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;从上面源码我们可以看出,迭代器在调用next()、remove()方法时都说调用checkForComodification()方法,该方法主要就是检测modCount==expectedModCount?若不等则抛出ConcurrentModificationException异常,从而产生fail-fast机制<br>&emsp;&emsp;所以要弄清楚为什么会产生fail-fast机制我们就必须要用弄明白为什么modCount != expectedModCount,他们的值在什么时候发生改变的<br>&emsp;&emsp;expectedModCount是在Itr中定义的:int expectedModCount = ArrayList.this.modCount;所以他的值是不可能会修改的<br>&emsp;&emsp;所以会变的是modCount,modCount是在 AbstractList 中定义的,为全局变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">transient</span> <span class="keyword">int</span> modCount = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>那么他什么时候因为什么原因而发生改变呢?请看ArrayList的源码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E paramE)</span> </span>&#123;    </span><br><span class="line">    ensureCapacityInternal(<span class="keyword">this</span>.size + <span class="number">1</span>);    </span><br><span class="line">        <span class="comment">/** 省略此处代码 */</span>    </span><br><span class="line">    &#125;    </span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureCapacityInternal</span><span class="params">(<span class="keyword">int</span> paramInt)</span> </span>&#123;    </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.elementData == EMPTY_ELEMENTDATA)    </span><br><span class="line">            paramInt = Math.max(<span class="number">10</span>, paramInt);    </span><br><span class="line">        ensureExplicitCapacity(paramInt);    </span><br><span class="line">    &#125;    </span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureExplicitCapacity</span><span class="params">(<span class="keyword">int</span> paramInt)</span> </span>&#123;    </span><br><span class="line">        <span class="keyword">this</span>.modCount += <span class="number">1</span>;    <span class="comment">//修改modCount    </span></span><br><span class="line">        <span class="comment">/** 省略此处代码 */</span>    </span><br><span class="line">    &#125;    </span><br><span class="line">        </span><br><span class="line">    <span class="function">ublic <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object paramObject)</span> </span>&#123;    </span><br><span class="line">        <span class="keyword">int</span> i;    </span><br><span class="line">        <span class="keyword">if</span> (paramObject == <span class="keyword">null</span>)    </span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.size; ++i) &#123;    </span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.elementData[i] != <span class="keyword">null</span>)    </span><br><span class="line">                    <span class="keyword">continue</span>;    </span><br><span class="line">                fastRemove(i);    </span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;    </span><br><span class="line">            &#125;    </span><br><span class="line">        <span class="keyword">else</span>    </span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.size; ++i) &#123;    </span><br><span class="line">                <span class="keyword">if</span> (!(paramObject.equals(<span class="keyword">this</span>.elementData[i])))    </span><br><span class="line">                    <span class="keyword">continue</span>;    </span><br><span class="line">                fastRemove(i);    </span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;    </span><br><span class="line">            &#125;    </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;    </span><br><span class="line">    &#125;    </span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fastRemove</span><span class="params">(<span class="keyword">int</span> paramInt)</span> </span>&#123;    </span><br><span class="line">        <span class="keyword">this</span>.modCount += <span class="number">1</span>;   <span class="comment">//修改modCount    </span></span><br><span class="line">        <span class="comment">/** 省略此处代码 */</span>    </span><br><span class="line">    &#125;    </span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;    </span><br><span class="line">        <span class="keyword">this</span>.modCount += <span class="number">1</span>;    <span class="comment">//修改modCount    </span></span><br><span class="line">        <span class="comment">/** 省略此处代码 */</span>    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;从上面的源代码可以看出:ArrayList中无论add、remove、clear方法只要涉及改变ArrayList元素个数的方法都会导致modCount改变,所以我们这里初步判断由于expectedModCount的值与modCount改变不同步,导致两者之间不等从而产生fail-fast机制,知道产生fail-fast产生的根本原因,我们看如下场景:<br>&emsp;&emsp;有两个线程(线程A,线程B),其中线程A负责遍历list、线程B修改list.线程A在遍历list过程的某个时候(此时expectedModCount = modCount=N),线程启动,同时线程B增加一个元素,这是modCount的值发生改变(modCount + 1 = N + 1).线程A继续遍历执行next方法时,通告checkForComodification方法发现expectedModCount  = N ,而modCount = N + 1,两者不等,这时就抛出ConcurrentModificationException 异常,从而产生fail-fast机制</p>
<h2 id="四、fail-fast解决办法"><a href="#四、fail-fast解决办法" class="headerlink" title="四、fail-fast解决办法"></a>四、fail-fast解决办法</h2><p>&emsp;&emsp;通过前面的实例、源码分析,我想各位已经基本了解了fail-fast的机制,下面我就产生的原因提出解决方案.这里有两种解决方案：</p>
<ul>
<li><font color='blue'>方案一</font>:在遍历过程中所有涉及到改变modCount值的地方全部加上synchronized或者直接使用Collection.synchronizedList这样可以解决,但是不推荐,因为增删造成的同步锁可能会阻塞遍历操作</li>
<li><font color='blue'>方案二</font>:使用CopyOnWriteArrayList来替换ArrayList.推荐使用该方案</li>
</ul>
<p>&emsp;&emsp;CopyOnWriteArrayList为何物?ArrayList的一个线程安全的变体,其中所有可变操作(add、set等等)都是通过对底层数组进行一次新的复制来实现的.该类产生的开销比较大,但是在两种情况下它非常适合使用</p>
<ol>
<li>在不能或不想进行同步遍历,但又需要从并发线程中排除冲突时</li>
<li>当遍历操作的数量大大超过可变可变操作的数量时</li>
</ol>
<p>遇到这两张情况使用CopyOnWriteArrayList来替代ArrayList再合适不过了,那为什么CopyOnWriteArrayList可以替代ArrayList?</p>
<ul>
<li>CopyOnWriteArrayList无论是从数据结构、定义都和ArrayList一样,它和ArrayList一样是实现List接口,底层使用数组实现,在方法上也包含add、remove、clear、iterator等方法</li>
<li>CopyOnWriteArrayList根本就不会产生ConcurrentModificationException异常,也就是它使用迭代器完全不会产生fail-fast机制</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">COWIterator</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">ListIterator</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/** 省略此处代码 */</span>    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> E <span class="title">next</span><span class="params">()</span> </span>&#123;    </span><br><span class="line">        <span class="keyword">if</span> (!(hasNext()))    </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();    </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.snapshot[(<span class="keyword">this</span>.cursor++)];    </span><br><span class="line">    &#125;    </span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 省略此处代码 */</span>    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;CopyOnWriteArrayList的方法根本就没有像ArrayList中使用checkForComodification方法来判断expectedModCount与modCount是否相等,它为什么会这么做?我们以add方法为例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E paramE)</span> </span>&#123;    </span><br><span class="line">    ReentrantLock localReentrantLock = <span class="keyword">this</span>.lock;    </span><br><span class="line">    localReentrantLock.lock();    </span><br><span class="line">    <span class="keyword">try</span> &#123;    </span><br><span class="line">        Object[] arrayOfObject1 = getArray();    </span><br><span class="line">        <span class="keyword">int</span> i = arrayOfObject1.length;    </span><br><span class="line">        Object[] arrayOfObject2 = Arrays.copyOf(arrayOfObject1, i + <span class="number">1</span>);    </span><br><span class="line">        arrayOfObject2[i] = paramE;    </span><br><span class="line">        setArray(arrayOfObject2);    </span><br><span class="line">        <span class="keyword">int</span> j = <span class="number">1</span>;    </span><br><span class="line">        <span class="keyword">return</span> j;    </span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;    </span><br><span class="line">        localReentrantLock.unlock();    </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;        </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setArray</span><span class="params">(Object[] paramArrayOfObject)</span> </span>&#123;    </span><br><span class="line">    <span class="keyword">this</span>.array = paramArrayOfObject;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CopyOnWriterArrayList的add方法与ArrayList的add方法有一个最大的不同点就在于,下面三句代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Object[] arrayOfObject2 = Arrays.copyOf(arrayOfObject1, i + <span class="number">1</span>);    </span><br><span class="line">arrayOfObject2[i] = paramE;    </span><br><span class="line">setArray(arrayOfObject2);</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;就是这三句代码使得CopyOnWriterArrayList不会抛ConcurrentModificationException异常,主要原因在于copy原来的array,再copy数组上进行add操作,这样做完全不会影响COWIterator中的array了<br>&emsp;&emsp;CopyOnWriterArrayList所代表的核心概念就是:任何对array在结构上有所改变的操作(add、remove、clear等),CopyOnWriterArrayList都会copy现有的数据,再在copy的数据上修改,这样就不会影响COWIterator中的数据了,修改完成之后改变原有数据的引用即可.同时这样造成的代价就是产生大量的对象,同时数组的copy也是相当有损耗的</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">Eric Liang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://ericql.github.io/2019/11/12/01-Java%E5%9F%BA%E7%A1%80%E7%AF%87/03-%E9%9B%86%E5%90%88%E7%AF%87/Fail-Fast%E6%9C%BA%E5%88%B6/">https://ericql.github.io/2019/11/12/01-Java%E5%9F%BA%E7%A1%80%E7%AF%87/03-%E9%9B%86%E5%90%88%E7%AF%87/Fail-Fast%E6%9C%BA%E5%88%B6/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://ericql.github.io">Eric Liang</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%9B%86%E5%90%88/">集合    </a></div><div class="post_share"><div class="social-share" data-image="https://source.unsplash.com/300x300/?library" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/11/12/01-Java%E5%9F%BA%E7%A1%80%E7%AF%87/03-%E9%9B%86%E5%90%88%E7%AF%87/%E9%9B%86%E5%90%88%E5%B7%A5%E5%85%B7%E7%B1%BB/"><img class="prev_cover lazyload" data-src="https://source.unsplash.com/300x300/?cartoon" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>集合工具类</span></div></a></div><div class="next-post pull_right"><a href="/2019/11/12/01-Java%E5%9F%BA%E7%A1%80%E7%AF%87/02-JDK%E6%BA%90%E7%A0%81%E7%AF%87/ThreadLocal%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"><img class="next_cover lazyload" data-src="https://source.unsplash.com/300x300/?beauty" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>ThreadLocal源码解析</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2019/11/12/01-Java基础篇/03-集合篇/集合工具类/" title="集合工具类"><img class="relatedPosts_cover lazyload"data-src="https://source.unsplash.com/300x300/?cartoon"><div class="relatedPosts_title">集合工具类</div></a></div><div class="relatedPosts_item"><a href="/2019/11/12/01-Java基础篇/03-集合篇/LinkedList源码解析/" title="LinkedList源码解析"><img class="relatedPosts_cover lazyload"data-src="https://source.unsplash.com/300x300/?document"><div class="relatedPosts_title">LinkedList源码解析</div></a></div><div class="relatedPosts_item"><a href="/2019/11/12/01-Java基础篇/03-集合篇/TreeMap源码解析/" title="TreeMap源码解析"><img class="relatedPosts_cover lazyload"data-src="https://source.unsplash.com/300x300/?github"><div class="relatedPosts_title">TreeMap源码解析</div></a></div><div class="relatedPosts_item"><a href="/2019/11/12/01-Java基础篇/03-集合篇/HashMap源码解析/" title="HashMap源码解析"><img class="relatedPosts_cover lazyload"data-src="https://source.unsplash.com/300x300/?program"><div class="relatedPosts_title">HashMap源码解析</div></a></div><div class="relatedPosts_item"><a href="/2019/11/12/01-Java基础篇/03-集合篇/ArrayList源码解析/" title="ArrayList源码解析"><img class="relatedPosts_cover lazyload"data-src="https://source.unsplash.com/300x300/?book"><div class="relatedPosts_title">ArrayList源码解析</div></a></div></div><div class="clear_both"></div></div></div></div><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2020 By Eric Liang</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="footer_custom_text"><a href="https://ericql.github.io">欢饮来到Eric的博客</a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>